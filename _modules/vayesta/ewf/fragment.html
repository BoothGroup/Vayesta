

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vayesta.ewf.fragment &mdash; Vayesta 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Vayesta
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/modules.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Vayesta</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../vayesta.html">vayesta</a></li>
          <li class="breadcrumb-item"><a href="../ewf.html">vayesta.ewf</a></li>
      <li class="breadcrumb-item active">vayesta.ewf.fragment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vayesta.ewf.fragment</h1><div class="highlight"><pre>
<span></span><span class="c1"># Standard libaries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>

<span class="c1"># External libaries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Internal libaries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf.cc</span>

<span class="c1"># Local modules</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">vayesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="n">einsum</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">,</span> <span class="n">getattr_recursive</span><span class="p">,</span> <span class="n">hstack</span><span class="p">,</span> <span class="n">log_method</span><span class="p">,</span> <span class="n">log_time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.qemb</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fragment</span> <span class="k">as</span> <span class="n">BaseFragment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.fragmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">IAO_Fragmentation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">RFCI_WaveFunction</span><span class="p">,</span> <span class="n">RCCSDTQ_WaveFunction</span><span class="p">,</span> <span class="n">UCCSDTQ_WaveFunction</span><span class="p">,</span> <span class="n">RDM_WaveFunction</span><span class="p">,</span> <span class="n">RRDM_WaveFunction</span><span class="p">,</span> <span class="n">URDM_WaveFunction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">DMET_Bath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.mpi</span><span class="w"> </span><span class="kn">import</span> <span class="n">mpi</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.ewf</span><span class="w"> </span><span class="kn">import</span> <span class="n">ewf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.ewf.ccsd_t</span><span class="w"> </span><span class="kn">import</span> <span class="n">calc_fragment_ccsd_t_energy</span>

<span class="c1"># Get MPI rank of fragment</span>
<span class="n">get_fragment_mpi_rank</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mpi_rank</span>


<div class="viewcode-block" id="Options">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Options">[docs]</a>
<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Options</span><span class="p">(</span><span class="n">BaseFragment</span><span class="o">.</span><span class="n">Options</span><span class="p">):</span>
    <span class="c1"># Inherited from Embedding</span>
    <span class="c1"># ------------------------</span>
    <span class="n">t_as_lambda</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># If True, use T-amplitudes inplace of Lambda-amplitudes</span>
    <span class="n">bsse_correction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bsse_rmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sc_mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nelectron_target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
        <span class="kc">None</span>  <span class="c1"># If set, adjust bath chemical potential until electron number in fragment equals nelectron_target</span>
    <span class="p">)</span>
    <span class="n">nelectron_target_atol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span>
    <span class="n">nelectron_target_rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span>
    <span class="c1"># Calculation modes</span>
    <span class="n">calc_e_wf_corr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">calc_e_dm_corr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">store_wf_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># If set, fragment WFs will be converted to the respective type, before storing them</span>
    <span class="c1"># Fragment specific</span>
    <span class="c1"># -----------------</span>
    <span class="n">wf_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># TODO: move these:</span>
    <span class="c1"># CAS methods</span>
    <span class="n">c_cas_occ</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">c_cas_vir</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># --- Solver options</span>
    <span class="c1"># &quot;TCCSD-solver&quot;:</span>
    <span class="n">tcc_fci_opts</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span></div>

    <span class="c1"># --- Couple embedding problems (currently only CCSD and MPI)</span>
    <span class="c1"># coupled_iterations: bool = None # Now accessible through solver=coupledCCSD setting.</span>


<div class="viewcode-block" id="Fragment">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Fragment</span><span class="p">(</span><span class="n">BaseFragment</span><span class="p">):</span>
    <span class="n">Options</span> <span class="o">=</span> <span class="n">Options</span>

<div class="viewcode-block" id="Fragment.Flags">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.Flags">[docs]</a>
    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Flags</span><span class="p">(</span><span class="n">BaseFragment</span><span class="o">.</span><span class="n">Flags</span><span class="p">):</span>
        <span class="c1"># Tailoring and external correction of CCSD</span>
        <span class="n">external_corrections</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
        <span class="c1"># Whether to perform additional checks on external corrections</span>
        <span class="n">test_extcorr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Fragment.Results">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.Results">[docs]</a>
    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Results</span><span class="p">(</span><span class="n">BaseFragment</span><span class="o">.</span><span class="n">Results</span><span class="p">):</span>
        <span class="n">e_corr_dm2cumulant</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">e_corr_ccsd_t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">n_active</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ip_energy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ea_energy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">moms</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">callback_results</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="nd">@property</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">dm1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Cluster 1DM&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>

        <span class="nd">@property</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">dm2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Cluster 2DM&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">make_rdm2</span><span class="p">()</span></div>



    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        base : EWF</span>
<span class="sd">            Base EWF object.</span>
<span class="sd">        fid : int</span>
<span class="sd">            Unique ID of fragment.</span>
<span class="sd">        name :</span>
<span class="sd">            Name of fragment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># For self-consistent mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_results</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_reset</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Need to unset these so can be regenerated each iteration.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_vir</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Fragment.set_cas">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.set_cas">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_cas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iaos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">dmet_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set complete active space for tailored CCSD and active-space CC methods.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dmet_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dmet_threshold</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bath_options</span><span class="p">[</span><span class="s2">&quot;dmet_threshold&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">iaos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create new IAO fragmentation</span>
            <span class="n">frag</span> <span class="o">=</span> <span class="n">IAO_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="n">minao</span><span class="p">)</span>
            <span class="n">frag</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>
            <span class="c1"># Get IAO and environment coefficients from fragmentation</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">get_orbital_fragment_indices</span><span class="p">(</span><span class="n">iaos</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c_iao</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">get_frag_coeff</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">c_env</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">get_env_coeff</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">bath</span> <span class="o">=</span> <span class="n">DMET_Bath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dmet_threshold</span><span class="o">=</span><span class="n">dmet_threshold</span><span class="p">)</span>
            <span class="n">c_dmet</span> <span class="o">=</span> <span class="n">bath</span><span class="o">.</span><span class="n">make_dmet_bath</span><span class="p">(</span><span class="n">c_env</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bath_options</span><span class="p">[</span><span class="s2">&quot;occupation_tolerance&quot;</span><span class="p">]</span>
            <span class="n">c_iao_occ</span><span class="p">,</span> <span class="n">c_iao_vir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonalize_cluster_dm</span><span class="p">(</span><span class="n">c_iao</span><span class="p">,</span> <span class="n">c_dmet</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_iao_occ</span> <span class="o">=</span> <span class="n">c_iao_vir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">c_cas_occ</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">c_occ</span><span class="p">,</span> <span class="n">c_iao_occ</span><span class="p">)</span>
        <span class="n">c_cas_vir</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">c_vir</span><span class="p">,</span> <span class="n">c_iao_vir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_occ</span> <span class="o">=</span> <span class="n">c_cas_occ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_vir</span> <span class="o">=</span> <span class="n">c_cas_vir</span>
        <span class="k">return</span> <span class="n">c_cas_occ</span><span class="p">,</span> <span class="n">c_cas_vir</span></div>


<div class="viewcode-block" id="Fragment.add_external_corrections">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.add_external_corrections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_external_corrections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">fragments</span><span class="p">,</span> <span class="n">correction_type</span><span class="o">=</span><span class="s2">&quot;tailor&quot;</span><span class="p">,</span> <span class="n">projectors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">test_extcorr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">low_level_coul</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add tailoring or external correction from other fragment solutions to CCSD solver.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fragments: list</span>
<span class="sd">            List of solved or auxiliary fragments, used for the correction.</span>
<span class="sd">        correction_type: str, optional</span>
<span class="sd">            Type of correction:</span>
<span class="sd">                &#39;tailor&#39;: replace CCSD T1 and T2 amplitudes with FCI amplitudes.</span>
<span class="sd">                &#39;delta-tailor&#39;: Add the difference of FCI and CCSD T1 and T2 amplitudes</span>
<span class="sd">                &#39;external&#39;: externally correct CCSD T1 and T2 amplitudes from FCI T3 and T4 amplitudes.</span>
<span class="sd">            Default: &#39;tailor&#39;.</span>
<span class="sd">        projectors: int, optional</span>
<span class="sd">            Maximum number of projections applied to the occupied dimensions of the amplitude corrections.</span>
<span class="sd">            Default: 1.</span>
<span class="sd">        test_extcorr: bool, optional</span>
<span class="sd">            Whether to perform additional checks on the external corrections.</span>
<span class="sd">        low_level_coul: bool, optional</span>
<span class="sd">            This is an option specific to the &#39;external&#39; correction.</span>
<span class="sd">            If True, then the T3V term is contracted with integrals spanning the &#39;low-level&#39; (i.e. CCSD) solver, i.e. the cluster being constrained.</span>
<span class="sd">            If False, then the T3V term is contracted with the integrals in the &#39;high-level&#39; (i.e. FCI) solver, i.e. the cluster providing the constraints.</span>
<span class="sd">            In general, there should be a slight speed increase, and slight loss of accuracy for the low_level_coul=False option, but in practice, we find only</span>
<span class="sd">            minor differences.</span>
<span class="sd">            Default: True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">correction_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;tailor&quot;</span><span class="p">,</span> <span class="s2">&quot;delta-tailor&quot;</span><span class="p">,</span> <span class="s2">&quot;external&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;CCSD&quot;</span><span class="p">:</span>
            <span class="c1"># Automatically update this cluster to use external correction solver.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;extCCSD&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">!=</span> <span class="s2">&quot;extCCSD&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">low_level_coul</span><span class="p">)</span> <span class="ow">and</span> <span class="n">correction_type</span> <span class="o">!=</span> <span class="s2">&quot;external&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;low_level_coul optional argument only meaningful with &#39;external&#39; correction of fragments.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([(</span><span class="n">getattr_recursive</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;results.wf&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">auxiliary</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Fragments for external correction need to be already solved or defined as auxiliary fragments.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">external_corrections</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">correction_type</span><span class="p">,</span> <span class="n">projectors</span><span class="p">,</span> <span class="n">low_level_coul</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">test_extcorr</span> <span class="o">=</span> <span class="n">test_extcorr</span></div>


<div class="viewcode-block" id="Fragment.clear_external_corrections">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.clear_external_corrections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_external_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all tailoring or external correction which were added via add_external_corrections.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">external_corrections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">test_extcorr</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Fragment.get_init_guess">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.get_init_guess">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_init_guess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_guess</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">cluster</span><span class="p">):</span>
        <span class="c1"># FIXME</span>
        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="Fragment.kernel">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.kernel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span>

        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;HF&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">init_guess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_init_guess</span><span class="p">(</span><span class="n">init_guess</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">cluster</span><span class="p">)</span>

        <span class="c1"># Create solver object</span>
        <span class="n">cluster_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
        <span class="c1"># Calculate cluster energy at the level of RPA.</span>
        <span class="n">e_corr_rpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_rpa_correction</span><span class="p">(</span><span class="n">cluster_solver</span><span class="o">.</span><span class="n">hamil</span><span class="p">)</span>
        <span class="c1"># --- Chemical potential</span>
        <span class="n">cpt_frag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">global_frag_chempot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">nelectron_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cluster_solver</span><span class="o">.</span><span class="n">optimize_cpt</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">nelectron_target</span><span class="p">,</span>
                <span class="n">c_frag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c_proj</span><span class="p">,</span>
                <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">nelectron_target_atol</span><span class="p">,</span>
                <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">nelectron_target_rtol</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">cpt_frag</span><span class="p">:</span>
            <span class="c1"># Add chemical potential to fragment space</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;cluster|frag&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">is_rhf</span><span class="p">:</span>
                <span class="n">p_frag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">v_ext</span> <span class="o">=</span> <span class="n">cpt_frag</span> <span class="o">*</span> <span class="n">p_frag</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_frag</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">v_ext</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpt_frag</span> <span class="o">*</span> <span class="n">p_frag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cpt_frag</span> <span class="o">*</span> <span class="n">p_frag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># --- Coupled fragments.</span>
        <span class="c1"># TODO rework this functionality to combine with external corrections/tailoring.</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;coupledCCSD&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mpi</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;coupled_iterations requires MPI.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mpi</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;coupled_iterations requires as many MPI processes as there are fragments.&quot;</span><span class="p">)</span>
            <span class="n">cluster_solver</span><span class="o">.</span><span class="n">set_coupled_fragments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>

        <span class="c1"># Normal solver</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">_debug_wf</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">log_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Time for </span><span class="si">%s</span><span class="s2"> solver:&quot;</span> <span class="o">%</span> <span class="n">solver</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>

        <span class="c1"># Special debug &quot;solver&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">_debug_wf</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">_debug_random_wf</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">_debug_exact_wf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">_debug_wf</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;dump&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">wf</span> <span class="o">=</span> <span class="n">cluster_solver</span><span class="o">.</span><span class="n">wf</span>
        <span class="c1"># Multiply WF by factor [optional]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">wf_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">wf_factor</span><span class="p">)</span>
        <span class="c1"># Convert WF to different type [optional]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">store_wf_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="s2">&quot;as_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">store_wf_type</span><span class="o">.</span><span class="n">lower</span><span class="p">())()</span>
        <span class="c1"># ---Make T-projected WF</span>
        <span class="n">pwf</span> <span class="o">=</span> <span class="n">wf</span>
        <span class="c1"># Projection of FCI wave function is not implemented - convert to CISD</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">RFCI_WaveFunction</span><span class="p">):</span>
            <span class="n">pwf</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">as_cisd</span><span class="p">()</span>
        <span class="c1"># Projection of CCSDTQ wave function is not implemented - convert to CCSD</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="p">(</span><span class="n">RCCSDTQ_WaveFunction</span><span class="p">,</span> <span class="n">UCCSDTQ_WaveFunction</span><span class="p">)):</span>
            <span class="n">pwf</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">as_ccsd</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">URDM_WaveFunction</span><span class="p">):</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;cluster|frag&quot;</span><span class="p">)</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">proj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">proj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">RRDM_WaveFunction</span><span class="p">):</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;cluster|frag&quot;</span><span class="p">)</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">@</span> <span class="n">proj</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;proj|cluster-occ&quot;</span><span class="p">)</span>
        <span class="n">pwf</span> <span class="o">=</span> <span class="n">pwf</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Moments</span>

        <span class="n">moms</span> <span class="o">=</span> <span class="n">cluster_solver</span><span class="o">.</span><span class="n">hole_moments</span><span class="p">,</span> <span class="n">cluster_solver</span><span class="o">.</span><span class="n">particle_moments</span>

        <span class="n">callback_results</span> <span class="o">=</span> <span class="n">cluster_solver</span><span class="o">.</span><span class="n">callback_results</span> <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;callback&quot;</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="c1"># --- Add to results data class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="p">(</span>
            <span class="n">fid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">n_active</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">norb_active</span><span class="p">,</span>
            <span class="n">converged</span><span class="o">=</span><span class="n">cluster_solver</span><span class="o">.</span><span class="n">converged</span><span class="p">,</span>
            <span class="n">wf</span><span class="o">=</span><span class="n">wf</span><span class="p">,</span>
            <span class="n">pwf</span><span class="o">=</span><span class="n">pwf</span><span class="p">,</span>
            <span class="n">moms</span><span class="o">=</span><span class="n">moms</span><span class="p">,</span>
            <span class="n">e_corr_rpa</span><span class="o">=</span><span class="n">e_corr_rpa</span><span class="p">,</span>
            <span class="n">callback_results</span><span class="o">=</span><span class="n">callback_results</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hamil</span> <span class="o">=</span> <span class="n">cluster_solver</span><span class="o">.</span><span class="n">hamil</span>

        <span class="c1"># --- Correlation energy contributions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">calc_e_wf_corr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="p">(</span><span class="n">RRDM_WaveFunction</span><span class="p">,</span> <span class="n">URDM_WaveFunction</span><span class="p">)):</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">as_cisd</span><span class="p">(</span><span class="n">c0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
            <span class="n">es</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">e_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_energy</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">c1</span><span class="p">,</span> <span class="n">ci</span><span class="o">.</span><span class="n">c2</span><span class="p">,</span> <span class="n">hamil</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hamil</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;E(S)= </span><span class="si">%s</span><span class="s2">  E(D)= </span><span class="si">%s</span><span class="s2">  E(tot)= </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">es</span><span class="p">),</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">ed</span><span class="p">),</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">e_corr</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">calc_e_dm_corr</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">e_corr_dm2cumulant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_fragment_dm2cumulant_energy</span><span class="p">(</span><span class="n">hamil</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hamil</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">calc_e_ccsd_t_corr</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">e_corr_ccsd_t</span> <span class="o">=</span> <span class="n">calc_fragment_ccsd_t_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="Fragment.get_solver_options">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.get_solver_options">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_solver_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="c1"># TODO: fix this mess...</span>
        <span class="c1"># Use those values from solver_options, which are not None</span>
        <span class="c1"># (conv_tol, max_cycle, solve_lambda,...)</span>
        <span class="n">solver_opts</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">solver_options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">pass_through</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;CCSD&quot;</span> <span class="ow">in</span> <span class="n">solver</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="n">pass_through</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;sc_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;dm_with_frozen&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">pass_through</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Passing fragment option </span><span class="si">%s</span><span class="s2"> to solver.&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

        <span class="n">has_actspace</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;TCCSD&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;CCSDt&#39;&quot;</span> <span class="ow">in</span> <span class="n">solver</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;CCSDt&quot;</span> <span class="ow">in</span> <span class="n">solver</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;EBCC&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">solver_options</span><span class="p">[</span><span class="s2">&quot;ansatz&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CCSDt&quot;</span><span class="p">,</span> <span class="s2">&quot;CCSDt&#39;&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">has_actspace</span><span class="p">:</span>
            <span class="c1"># Set CAS orbitals</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_occ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Occupied CAS orbitals not set. Setting to occupied DMET cluster orbitals.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmet_bath</span><span class="o">.</span><span class="n">c_cluster_occ</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_vir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Virtual CAS orbitals not set. Setting to virtual DMET cluster orbitals.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_vir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmet_bath</span><span class="o">.</span><span class="n">c_cluster_vir</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="s2">&quot;c_cas_occ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_occ</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="s2">&quot;c_cas_vir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">c_cas_vir</span>
            <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;TCCSD&quot;</span><span class="p">:</span>
                <span class="n">solver_opts</span><span class="p">[</span><span class="s2">&quot;tcc_fci_opts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">tcc_fci_opts</span>
        <span class="k">elif</span> <span class="n">solver</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;DUMP&quot;</span><span class="p">:</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">solver_options</span><span class="p">[</span><span class="s2">&quot;dumpfile&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;CALLBACK&#39;</span><span class="p">:</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">solver_options</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">]</span>
        <span class="n">solver_opts</span><span class="p">[</span><span class="s2">&quot;external_corrections&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">external_corrections</span>
        <span class="n">solver_opts</span><span class="p">[</span><span class="s2">&quot;test_extcorr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">test_extcorr</span>
        <span class="k">return</span> <span class="n">solver_opts</span></div>


    <span class="c1"># --- Expectation values</span>
    <span class="c1"># ----------------------</span>

    <span class="c1"># --- Energies</span>

<div class="viewcode-block" id="Fragment.get_fragment_energy">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.get_fragment_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragment_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">hamil</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fock</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c2ba_order</span><span class="o">=</span><span class="s2">&quot;ba&quot;</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="s2">&quot;fragment&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate fragment correlation energy contribution from projected C1, C2.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c1 : (n(occ-CO), n(vir-CO)) array</span>
<span class="sd">            Fragment projected C1-amplitudes.</span>
<span class="sd">        c2 : (n(occ-CO), n(occ-CO), n(vir-CO), n(vir-CO)) array</span>
<span class="sd">            Fragment projected C2-amplitudes.</span>
<span class="sd">        hamil : ClusterHamiltonian object.</span>
<span class="sd">            Object representing cluster hamiltonian, possibly including cached ERIs.</span>
<span class="sd">        fock : (n(AO), n(AO)) array, optional</span>
<span class="sd">            Fock matrix in AO representation. If None, self.base.get_fock_for_energy()</span>
<span class="sd">            is used. Default: None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        e_singles : float</span>
<span class="sd">            Fragment correlation energy contribution from single excitations.</span>
<span class="sd">        e_doubles : float</span>
<span class="sd">            Fragment correlation energy contribution from double excitations.</span>
<span class="sd">        e_corr : float</span>
<span class="sd">            Total fragment correlation energy contribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">axis1</span> <span class="o">==</span> <span class="s2">&quot;fragment&quot;</span><span class="p">:</span>
            <span class="n">px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;proj|cluster-occ&quot;</span><span class="p">)</span>

        <span class="c1"># --- Singles energy (zero for HF-reference)</span>
        <span class="k">if</span> <span class="n">c1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_fock_for_energy</span><span class="p">()</span>
            <span class="n">fov</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active_occ</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active_vir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">axis1</span> <span class="o">==</span> <span class="s2">&quot;fragment&quot;</span><span class="p">:</span>
                <span class="n">e_singles</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ia,xi,xa-&gt;&quot;</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e_singles</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fov</span> <span class="o">*</span> <span class="n">c1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e_singles</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># --- Doubles energy</span>
        <span class="k">if</span> <span class="n">hamil</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hamil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamil</span>
        <span class="c1"># This automatically either slices a stored ERI tensor or calculates it on the fly.</span>
        <span class="n">g_ovvo</span> <span class="o">=</span> <span class="n">hamil</span><span class="o">.</span><span class="n">get_eris_bare</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="s2">&quot;ovvo&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">axis1</span> <span class="o">==</span> <span class="s2">&quot;fragment&quot;</span><span class="p">:</span>
            <span class="n">e_doubles</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;xi,xjab,iabj&quot;</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">g_ovvo</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;xi,xjab,ibaj&quot;</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">g_ovvo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e_doubles</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijab,iabj&quot;</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">g_ovvo</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijab,ibaj&quot;</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">g_ovvo</span><span class="p">)</span>

        <span class="n">e_singles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_factor</span> <span class="o">*</span> <span class="n">e_singles</span>
        <span class="n">e_doubles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_factor</span> <span class="o">*</span> <span class="n">e_doubles</span>
        <span class="n">e_corr</span> <span class="o">=</span> <span class="n">e_singles</span> <span class="o">+</span> <span class="n">e_doubles</span>
        <span class="k">return</span> <span class="n">e_singles</span><span class="p">,</span> <span class="n">e_doubles</span><span class="p">,</span> <span class="n">e_corr</span></div>


    <span class="c1"># --- Density-matrices</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ccsd_amplitudes_for_dm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">as_ccsd</span><span class="p">()</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">t2</span>
        <span class="n">pwf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">pwf</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sym</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span><span class="o">.</span><span class="n">as_ccsd</span><span class="p">()</span>
        <span class="n">t1x</span><span class="p">,</span> <span class="n">t2x</span> <span class="o">=</span> <span class="n">pwf</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="n">pwf</span><span class="o">.</span><span class="n">t2</span>
        <span class="c1"># Lambda amplitudes</span>
        <span class="k">if</span> <span class="n">t_as_lambda</span><span class="p">:</span>
            <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>
            <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span> <span class="o">=</span> <span class="n">t1x</span><span class="p">,</span> <span class="n">t2x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">l2</span>
            <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span> <span class="o">=</span> <span class="n">pwf</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">pwf</span><span class="o">.</span><span class="n">l2</span>
        <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">t1x</span><span class="p">,</span> <span class="n">t2x</span><span class="p">,</span> <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_projected_gamma1_intermediates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Intermediates for 1-DM, projected in Lambda-amplitudes and linear T-term.&quot;&quot;&quot;</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">t1x</span><span class="p">,</span> <span class="n">t2x</span><span class="p">,</span> <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ccsd_amplitudes_for_dm</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
        <span class="n">doo</span><span class="p">,</span> <span class="n">dov</span><span class="p">,</span> <span class="n">dvo</span><span class="p">,</span> <span class="n">dvv</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">ccsd_rdm</span><span class="o">.</span><span class="n">_gamma1_intermediates</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span><span class="p">)</span>
        <span class="c1"># Correction for term without Lambda amplitude:</span>
        <span class="n">dvo</span> <span class="o">+=</span> <span class="p">(</span><span class="n">t1x</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">doo</span><span class="p">,</span> <span class="n">dov</span><span class="p">,</span> <span class="n">dvo</span><span class="p">,</span> <span class="n">dvv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_projected_gamma2_intermediates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Intermediates for 2-DM, projected in Lambda-amplitudes and linear T-term.&quot;&quot;&quot;</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">t1x</span><span class="p">,</span> <span class="n">t2x</span><span class="p">,</span> <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ccsd_amplitudes_for_dm</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span>  <span class="c1"># Only attributes stdout, verbose, and max_memory are needed, just use mean-field object</span>
        <span class="n">dovov</span><span class="p">,</span> <span class="o">*</span><span class="n">d2rest</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">ccsd_rdm</span><span class="o">.</span><span class="n">_gamma2_intermediates</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1x</span><span class="p">,</span> <span class="n">l2x</span><span class="p">)</span>
        <span class="c1"># Correct D2[ovov] part (first element of d2 tuple)</span>
        <span class="n">dtau</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2x</span> <span class="o">-</span> <span class="n">t2</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ia,jb-&gt;ijab&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">t1x</span> <span class="o">-</span> <span class="n">t1</span><span class="p">),</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">dovov</span> <span class="o">+=</span> <span class="n">dtau</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">dovov</span> <span class="o">-=</span> <span class="n">dtau</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dovov</span><span class="p">,</span> <span class="o">*</span><span class="n">d2rest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d2</span>

<div class="viewcode-block" id="Fragment.make_fragment_dm1">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.make_fragment_dm1">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_fragment_dm1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Currently CCSD only.</span>

<span class="sd">        Without mean-field contribution!&quot;&quot;&quot;</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_projected_gamma1_intermediates</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
        <span class="n">dm1</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">ccsd_rdm</span><span class="o">.</span><span class="n">_make_rdm1</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">with_frozen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_mf</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dm1</span></div>


<div class="viewcode-block" id="Fragment.make_fragment_dm2cumulant">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.make_fragment_dm2cumulant">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_fragment_dm2cumulant</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sym_dm2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">full_shape</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Currently MP2/CCSD only&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;MP2&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">approx_cumulant</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="n">t2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">pwf</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sym</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span><span class="o">.</span><span class="n">as_ccsd</span><span class="p">()</span><span class="o">.</span><span class="n">t2</span>
            <span class="n">dovov</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t2x</span> <span class="o">-</span> <span class="n">t2x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_shape</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dovov</span>
            <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">dovov</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">norb</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">nvir</span>
            <span class="n">dm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">[</span><span class="n">norb</span><span class="p">])</span>
            <span class="n">occ</span><span class="p">,</span> <span class="n">vir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:</span><span class="n">nocc</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span>
            <span class="n">dm2</span><span class="p">[</span><span class="n">occ</span><span class="p">,</span> <span class="n">vir</span><span class="p">,</span> <span class="n">occ</span><span class="p">,</span> <span class="n">vir</span><span class="p">]</span> <span class="o">=</span> <span class="n">dovov</span>
            <span class="n">dm2</span><span class="p">[</span><span class="n">vir</span><span class="p">,</span> <span class="n">occ</span><span class="p">,</span> <span class="n">vir</span><span class="p">,</span> <span class="n">occ</span><span class="p">]</span> <span class="o">=</span> <span class="n">dovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dm2</span>

        <span class="n">cc</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_projected_gamma2_intermediates</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
        <span class="n">dm2</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">ccsd_rdm</span><span class="o">.</span><span class="n">_make_rdm2</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">with_dm1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_frozen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">approx_cumulant</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">elif</span> <span class="n">approx_cumulant</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">approx_cumulant</span><span class="p">:</span>
            <span class="c1"># Remove dm1(cc)^2</span>
            <span class="n">dm1x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_fragment_dm1</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">(</span><span class="n">with_mf</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">dm2</span> <span class="o">-=</span> <span class="p">(</span>
                <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,kl-&gt;ijkl&quot;</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">dm1x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,kl-&gt;ijkl&quot;</span><span class="p">,</span> <span class="n">dm1x</span><span class="p">,</span> <span class="n">dm1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,kl-&gt;iklj&quot;</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">dm1x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
                <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,kl-&gt;iklj&quot;</span><span class="p">,</span> <span class="n">dm1x</span><span class="p">,</span> <span class="n">dm1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">sym_dm2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sym_t2</span><span class="p">:</span>
            <span class="n">dm2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm2</span> <span class="o">+</span> <span class="n">dm2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">dm2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dm2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">dm2</span></div>


    <span class="c1"># def make_partial_dm1_energy(self, t_as_lambda=False):</span>
    <span class="c1">#    dm1 = self.make_partial_dm1(t_as_lambda=t_as_lambda)</span>
    <span class="c1">#    c_act = self.cluster.c_active</span>
    <span class="c1">#    fock = np.linalg.multi_dot((c_act.T, self.base.get_fock(), c_act))</span>
    <span class="c1">#    e_dm1 = einsum(&#39;ij,ji-&gt;&#39;, fock, dm1)</span>
    <span class="c1">#    return e_dm1</span>

<div class="viewcode-block" id="Fragment.make_fragment_dm2cumulant_energy">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.make_fragment_dm2cumulant_energy">[docs]</a>
    <span class="nd">@log_method</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_fragment_dm2cumulant_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hamil</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_as_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">hamil</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hamil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamil</span>

        <span class="c1"># This is a refactor of original functionality with three forks.</span>
        <span class="c1">#   - MP2 solver so dm2 cumulant is just ovov, and we just want to contract this.</span>
        <span class="c1">#   - CCSD solver so want to use approximate cumulant and can use optimal contraction of different ERI blocks</span>
        <span class="c1">#     making use of permutational symmetries.</span>
        <span class="c1">#   - All other solvers where we just use a dense eri contraction and may or may not use the approximate</span>
        <span class="c1">#     cumulant.</span>
        <span class="c1"># With the new hamiltonian object we can always use the optimal contraction for the approximate cumulant,</span>
        <span class="c1"># regardless of solver, and we support `approx_cumulant=False` for CCSD.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;MP2&quot;</span><span class="p">:</span>
            <span class="c1"># This is just ovov shape in this case. TODO neater way to handle this?</span>
            <span class="n">dm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_fragment_dm2cumulant</span><span class="p">(</span>
                <span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="n">approx_cumulant</span><span class="p">,</span> <span class="n">full_shape</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijkl,ijkl-&gt;&quot;</span><span class="p">,</span> <span class="n">hamil</span><span class="o">.</span><span class="n">get_eris_bare</span><span class="p">(</span><span class="s2">&quot;ovov&quot;</span><span class="p">),</span> <span class="n">dm2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">approx_cumulant</span><span class="p">:</span>
            <span class="c1"># Working hypothesis: this branch will effectively always uses `approx_cumulant=True`.</span>
            <span class="n">eris</span> <span class="o">=</span> <span class="n">hamil</span><span class="o">.</span><span class="n">get_dummy_eri_object</span><span class="p">(</span><span class="n">force_bare</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_vext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_projected_gamma2_intermediates</span><span class="p">(</span><span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">vayesta</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">ao2mo</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">contract_dm2intermeds_eris_rhf</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_fragment_dm2cumulant</span><span class="p">(</span>
                <span class="n">t_as_lambda</span><span class="o">=</span><span class="n">t_as_lambda</span><span class="p">,</span> <span class="n">sym_t2</span><span class="o">=</span><span class="n">sym_t2</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="n">approx_cumulant</span><span class="p">,</span> <span class="n">full_shape</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">e_dm2</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijkl,ijkl-&gt;&quot;</span><span class="p">,</span> <span class="n">hamil</span><span class="o">.</span><span class="n">get_eris_bare</span><span class="p">(),</span> <span class="n">dm2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">e_dm2</span></div>


    <span class="c1"># --- Other</span>
    <span class="c1"># ---------</span>

<div class="viewcode-block" id="Fragment.get_fragment_bsse">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.get_fragment_bsse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragment_bsse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Counterpoise Calculation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;************************&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bsse_rmax</span>

        <span class="c1"># Atomic calculation with atomic basis functions:</span>
        <span class="c1"># mol = self.mol.copy()</span>
        <span class="c1"># atom = mol.atom[self.atoms]</span>
        <span class="c1"># self.log.debugv(&quot;Keeping atoms %r&quot;, atom)</span>
        <span class="c1"># mol.atom = atom</span>
        <span class="c1"># mol.a = None</span>
        <span class="c1"># mol.build(False, False)</span>

        <span class="n">natom0</span><span class="p">,</span> <span class="n">e_mf0</span><span class="p">,</span> <span class="n">e_cm0</span><span class="p">,</span> <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counterpoise_calculation</span><span class="p">(</span><span class="n">rmax</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">natom0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Counterpoise: E(atom)= </span><span class="si">% 16.8f</span><span class="s2"> Ha&quot;</span><span class="p">,</span> <span class="n">e_cm0</span><span class="p">)</span>

        <span class="c1"># natom_list = []</span>
        <span class="c1"># e_mf_list = []</span>
        <span class="c1"># e_cm_list = []</span>
        <span class="n">r_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">rmax</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">rmax</span><span class="p">))</span>
        <span class="c1"># for r in r_values:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rmax</span>
        <span class="n">natom</span><span class="p">,</span> <span class="n">e_mf</span><span class="p">,</span> <span class="n">e_cm</span><span class="p">,</span> <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counterpoise_calculation</span><span class="p">(</span><span class="n">rmax</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">dm0</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span>
            <span class="s2">&quot;Counterpoise: n(atom)= </span><span class="si">%3d</span><span class="s2">  E(mf)= </span><span class="si">%16.8f</span><span class="s2"> Ha  E(</span><span class="si">%s</span><span class="s2">)= </span><span class="si">% 16.8f</span><span class="s2"> Ha&quot;</span><span class="p">,</span> <span class="n">natom</span><span class="p">,</span> <span class="n">e_mf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="n">e_cm</span>
        <span class="p">)</span>

        <span class="n">e_bsse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">e_cm</span> <span class="o">-</span> <span class="n">e_cm0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Counterpoise: E(BSSE)= </span><span class="si">% 16.8f</span><span class="s2"> Ha&quot;</span><span class="p">,</span> <span class="n">e_bsse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e_bsse</span></div>


<div class="viewcode-block" id="Fragment.counterpoise_calculation">
<a class="viewcode-back" href="../../../apidoc/vayesta.ewf.html#vayesta.ewf.ewf.Fragment.counterpoise_calculation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">counterpoise_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">dm0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">):</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_counterpoise_mol</span><span class="p">(</span><span class="n">rmax</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="n">nimages</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;pyscf-cp.txt&quot;</span><span class="p">)</span>
        <span class="c1"># Mean-field</span>
        <span class="c1"># mf = type(self.mf)(mol)</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">mf</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">conv_tol</span>
        <span class="c1"># if self.mf.with_df is not None:</span>
        <span class="c1">#    self.log.debugv(&quot;Setting GDF&quot;)</span>
        <span class="c1">#    self.log.debugv(&quot;%s&quot;, type(self.mf.with_df))</span>
        <span class="c1">#    # ONLY GDF SO FAR!</span>
        <span class="c1"># TODO: generalize</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">kdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">auxbasis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">kdf</span><span class="o">.</span><span class="n">auxbasis</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">with_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">auxbasis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">with_df</span><span class="o">.</span><span class="n">auxbasis</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auxbasis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">auxbasis</span><span class="p">:</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">density_fit</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">=</span><span class="n">auxbasis</span><span class="p">)</span>
        <span class="c1"># TODO:</span>
        <span class="c1"># use dm0 as starting point</span>
        <span class="n">mf</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>
        <span class="n">dm0</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>
        <span class="c1"># Embedded calculation with same options</span>
        <span class="n">ecc</span> <span class="o">=</span> <span class="n">ewf</span><span class="o">.</span><span class="n">EWF</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="n">bno_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bno_threshold</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
        <span class="n">ecc</span><span class="o">.</span><span class="n">make_atom_cluster</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
        <span class="n">ecc</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">mol</span><span class="o">.</span><span class="n">natm</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">e_tot</span><span class="p">,</span> <span class="n">ecc</span><span class="o">.</span><span class="n">e_tot</span><span class="p">,</span> <span class="n">dm0</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>