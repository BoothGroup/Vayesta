

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vayesta.core.qemb.fragment &mdash; Vayesta 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Vayesta
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apidoc/modules.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Vayesta</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../vayesta.html">vayesta</a></li>
      <li class="breadcrumb-item active">vayesta.core.qemb.fragment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vayesta.core.qemb.fragment</h1><div class="highlight"><pre>
<span></span><span class="c1"># --- Standard library</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>

<span class="c1"># --- External</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf.lo</span>

<span class="c1"># --- Internal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.util</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">OptionsBase</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">,</span>
    <span class="n">deprecated</span><span class="p">,</span>
    <span class="n">dot</span><span class="p">,</span>
    <span class="n">einsum</span><span class="p">,</span>
    <span class="n">energy_string</span><span class="p">,</span>
    <span class="n">fix_orbital_sign</span><span class="p">,</span>
    <span class="n">hstack</span><span class="p">,</span>
    <span class="n">log_time</span><span class="p">,</span>
    <span class="n">time_string</span><span class="p">,</span>
    <span class="n">timer</span><span class="p">,</span>
    <span class="n">AbstractMethodError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">spinalg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cluster</span><span class="p">,</span> <span class="n">Orbitals</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.symmetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">SymmetryIdentity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.symmetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">SymmetryTranslation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">vayesta.core.ao2mo</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">vayesta.core.ao2mo.helper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">WaveFunction</span>

<span class="c1"># Bath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">BNO_Threshold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">DMET_Bath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">EwDMET_Bath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">MP2_Bath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">Full_Bath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">R2_Bath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">RPA_Bath</span>

<span class="c1"># Bosonic Bath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.bosonic_bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">RPA_Boson_Target_Space</span><span class="p">,</span> <span class="n">RPA_QBA_Bath</span><span class="p">,</span> <span class="n">Boson_Threshold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.types.bosonic_orbitals</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuasiBosonOrbitals</span>

<span class="c1"># Other</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.misc.cubefile</span><span class="w"> </span><span class="kn">import</span> <span class="n">CubeFile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.mpi</span><span class="w"> </span><span class="kn">import</span> <span class="n">mpi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.solver</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_solver_class</span><span class="p">,</span> <span class="n">check_solver_config</span><span class="p">,</span> <span class="n">ClusterHamiltonian</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.screening.screening_crpa</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_frag_W</span>

<span class="c1"># Get MPI rank of fragment</span>
<span class="n">get_fragment_mpi_rank</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mpi_rank</span>


<div class="viewcode-block" id="Options">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.fragment.Options">[docs]</a>
<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Options</span><span class="p">(</span><span class="n">OptionsBase</span><span class="p">):</span>
    <span class="c1"># Inherited from Embedding</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># --- Bath options</span>
    <span class="n">bath_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bosonic_bath_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># --- Solver options</span>
    <span class="n">solver_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># --- Other</span>
    <span class="n">store_eris</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># If True, ERIs will be cached in Fragment.hamil</span>
    <span class="n">dm_with_frozen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO: is still used?</span>
    <span class="n">screening</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">match_cluster_fock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Fragment specific</span>
    <span class="c1"># -----------------</span>
    <span class="c1"># Auxiliary fragments are treated before non-auxiliary fragments, but do not contribute to expectation values</span>
    <span class="n">auxiliary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">coupled_fragments</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">sym_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span></div>



<div class="viewcode-block" id="Fragment">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.fragment.Fragment">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Fragment</span><span class="p">:</span>
    <span class="n">Options</span> <span class="o">=</span> <span class="n">Options</span>

<div class="viewcode-block" id="Fragment.Flags">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.fragment.Fragment.Flags">[docs]</a>
    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Flags</span><span class="p">:</span>
        <span class="c1"># If multiple cluster exist for a given atom, the envelop fragment is</span>
        <span class="c1"># the one with the largest (super) cluster space. This is used, for example,</span>
        <span class="c1"># for the finite-bath and ICMP2 corrections</span>
        <span class="n">is_envelop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">is_secfrag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Secondary fragment parameter</span>
        <span class="n">bath_parent_fragment_id</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Fragment.Results">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.fragment.Fragment.Results">[docs]</a>
    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Results</span><span class="p">:</span>
        <span class="n">fid</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Fragment ID</span>
        <span class="n">converged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>  <span class="c1"># True, if solver reached convergence criterion or no convergence required (eg. MP2 solver)</span>
        <span class="p">)</span>
        <span class="c1"># --- Energies</span>
        <span class="n">e_corr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Fragment correlation energy contribution</span>
        <span class="n">e_corr_rpa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Fragment correlation energy contribution at the level of RPA.</span>
        <span class="c1"># --- Wave-function</span>
        <span class="n">wf</span><span class="p">:</span> <span class="n">WaveFunction</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># WaveFunction object (MP2, CCSD,...)</span>
        <span class="n">pwf</span><span class="p">:</span> <span class="n">WaveFunction</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Fragment-projected wave function</span>
        <span class="n">moms</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base</span><span class="p">,</span>
        <span class="n">fid</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">c_frag</span><span class="p">,</span>
        <span class="n">c_env</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">aos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">sym_parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sym_op</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mpi_rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Abstract base class for quantum embedding fragments.</span>

<span class="sd">        The fragment may keep track of associated atoms or atomic orbitals, using</span>
<span class="sd">        the `atoms` and `aos` attributes, respectively.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        base : Embedding</span>
<span class="sd">            Quantum embedding method the fragment is part of.</span>
<span class="sd">        fid : int</span>
<span class="sd">            Fragment ID.</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of fragment.</span>
<span class="sd">        c_frag : (nAO, nFrag) array</span>
<span class="sd">            Fragment orbital coefficients.</span>
<span class="sd">        c_env : (nAO, nEnv) array</span>
<span class="sd">            Environment (non-fragment) orbital coefficients.</span>
<span class="sd">        fragment_type : {&#39;IAO&#39;, &#39;Lowdin-AO&#39;, &#39;AO&#39;}</span>
<span class="sd">            Fragment orbital type.</span>
<span class="sd">        atoms : list or int, optional</span>
<span class="sd">            Associated atoms. Default: None</span>
<span class="sd">        aos : list or int, optional</span>
<span class="sd">            Associated atomic orbitals. Default: None</span>
<span class="sd">        sym_factor : float, optional</span>
<span class="sd">            Symmetry factor (number of symmetry equivalent fragments). Default: 1.0.</span>
<span class="sd">        sym_parent : Fragment, optional</span>
<span class="sd">            Symmetry related parent fragment. Default: None.</span>
<span class="sd">        sym_op : Callable, optional</span>
<span class="sd">            Symmetry operation on AO basis function, representing the symmetry to the `sym_parent` object. Default: None.</span>
<span class="sd">        log : logging.Logger</span>
<span class="sd">            Logger object. If None, the logger of the `base` object is used. Default: None.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        mol</span>
<span class="sd">        mf</span>
<span class="sd">        size</span>
<span class="sd">        nelectron</span>
<span class="sd">        id_name</span>
<span class="sd">        log : logging.Logger</span>
<span class="sd">            Logger object.</span>
<span class="sd">        base : Embedding</span>
<span class="sd">            Quantum embedding method, the fragment is part of.</span>
<span class="sd">        id : int</span>
<span class="sd">            Unique fragment ID.</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of fragment.</span>
<span class="sd">        c_frag : (nAO, nFrag) array</span>
<span class="sd">            Fragment orbital coefficients.</span>
<span class="sd">        c_env : (nAO, nEnv) array</span>
<span class="sd">            Environment (non-fragment) orbital coefficients.</span>
<span class="sd">        fragment_type : {&#39;IAO&#39;, &#39;Lowdin-AO&#39;, &#39;AO&#39;}</span>
<span class="sd">            Fragment orbital type.</span>
<span class="sd">        sym_factor : float</span>
<span class="sd">            Symmetry factor (number of symmetry equivalent fragments).</span>
<span class="sd">        atoms : list</span>
<span class="sd">            Atoms in fragment.</span>
<span class="sd">        aos : list</span>
<span class="sd">            Atomic orbitals in fragment</span>
<span class="sd">        coupled_fragments : list</span>
<span class="sd">            List of fragments, the current fragment is coupled to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span> <span class="ow">or</span> <span class="n">base</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">fid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span>

        <span class="c1"># Options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>  <span class="c1"># Default options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">deepcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>  <span class="c1"># Update with embedding class options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># Replace with keyword arguments</span>

        <span class="c1"># Flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Flags</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">flags</span> <span class="ow">or</span> <span class="p">{}))</span>

        <span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_frag</span> <span class="o">=</span> <span class="n">c_frag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_env</span> <span class="o">=</span> <span class="n">c_env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">sym_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span> <span class="o">=</span> <span class="n">sym_parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span> <span class="o">=</span> <span class="n">sym_op</span>
        <span class="c1"># For some embeddings, it may be necessary to keep track of any associated atoms or basis functions (AOs)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="c1"># TODO: Is aos still used?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aos</span> <span class="o">=</span> <span class="n">aos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">active</span>

        <span class="c1"># MPI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">=</span> <span class="n">mpi_rank</span>

        <span class="c1"># This set of orbitals is used in the projection to evaluate expectation value contributions</span>
        <span class="c1"># of the fragment. By default it is equal to `self.c_frag`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_frag</span>

        <span class="c1"># Initialize self.bath, self._cluster, self._results, self.hamil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Creating </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="c1"># self.log.info(break_into_lines(str(self.opts), newline=&#39;\n    &#39;))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mpi</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(id= </span><span class="si">%d</span><span class="s2">, name= </span><span class="si">%s</span><span class="s2">, mpi_rank= </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_rank</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(id= </span><span class="si">%d</span><span class="s2">, name= </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="Fragment.log_info">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.log_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Some output</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;  &gt; </span><span class="si">%-24s</span><span class="s2">     &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Fragment orbitals:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Symmetry factor:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_factor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Number of electrons:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelectron</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Associated atoms:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Associated AOs:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aos</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mol</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mf</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_frag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of fragment orbitals.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_frag</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nelectron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of mean-field electrons.&quot;&quot;&quot;</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_frag</span><span class="p">)</span>
        <span class="n">ne</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ai,ab,bi-&gt;&quot;</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">(),</span> <span class="n">sc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ne</span>

<div class="viewcode-block" id="Fragment.trimmed_name">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.trimmed_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">trimmed_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">add_dots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fragment name trimmed to a given maximum length.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">add_dots</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">id_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use this whenever a unique name is needed (for example to open a separate file for each fragment).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trimmed_name</span><span class="p">())</span>

<div class="viewcode-block" id="Fragment.change_options">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.change_options">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hamil</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Cache the hamiltonian object; note that caching or not of eris is handled inside the hamiltonian object.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hamil</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frag_hamil</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hamil</span>

    <span class="nd">@hamil</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hamil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hamil</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># --- Overlap matrices</span>
    <span class="c1"># --------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_csc_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">ovlp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transpose_left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transpose_right</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">transpose_left</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">transpose_right</span><span class="p">:</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">ovlp</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ovlp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

<div class="viewcode-block" id="Fragment.get_overlap">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_overlap">[docs]</a>
    <span class="nd">@cache</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get overlap between cluster orbitals, fragment orbitals, or MOs.</span>

<span class="sd">        The return value is cached but not copied; do not modify the array in place without</span>
<span class="sd">        creating a copy!</span>

<span class="sd">        Examples:</span>
<span class="sd">        &gt;&gt;&gt; s = self.get_overlap(&#39;cluster|mo&#39;)</span>
<span class="sd">        &gt;&gt;&gt; s = self.get_overlap(&#39;cluster|frag&#39;)</span>
<span class="sd">        &gt;&gt;&gt; s = self.get_overlap(&#39;mo[occ]|cluster[occ]&#39;)</span>
<span class="sd">        &gt;&gt;&gt; s = self.get_overlap(&#39;mo[vir]|cluster[vir]&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">overlap_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">center</span><span class="p">)))</span>
            <span class="n">overlap_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">center</span><span class="p">,</span> <span class="n">right</span><span class="p">)))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csc_dot</span><span class="p">(</span><span class="n">overlap_left</span><span class="p">,</span> <span class="n">overlap_right</span><span class="p">,</span> <span class="n">ovlp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transpose_left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Standardize key to reduce cache misses:</span>
        <span class="n">key_mod</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_mod</span> <span class="o">!=</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="n">key_mod</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_coeff</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;frag&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_frag</span>
            <span class="k">if</span> <span class="s2">&quot;proj&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_proj</span>
            <span class="k">if</span> <span class="s2">&quot;occ&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">part</span> <span class="o">=</span> <span class="s2">&quot;_occ&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;vir&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">part</span> <span class="o">=</span> <span class="s2">&quot;_vir&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">part</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;mo&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;mo_coeff</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">part</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;cluster&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">,</span> <span class="s2">&quot;c_active</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">part</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid key: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="n">c_left</span> <span class="o">=</span> <span class="n">_get_coeff</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
        <span class="n">c_right</span> <span class="o">=</span> <span class="n">_get_coeff</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csc_dot</span><span class="p">(</span><span class="n">c_left</span><span class="p">,</span> <span class="n">c_right</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fragment.get_coeff_env">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_coeff_env">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_coeff_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_env</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span><span class="o">.</span><span class="n">get_coeff_env</span><span class="p">())</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symmetry_parent</span><span class="p">()</span><span class="o">.</span><span class="n">_results</span>

    <span class="nd">@results</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot set attribute results in symmetry derived fragment.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">basis_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span>

    <span class="nd">@cluster</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot set attribute cluster in symmetry derived fragment.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Fragment.reset">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_bath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reset_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reset_eris</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reset_inactive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span>
            <span class="s2">&quot;Resetting </span><span class="si">%s</span><span class="s2"> (reset_bath= </span><span class="si">%r</span><span class="s2">, reset_cluster= </span><span class="si">%r</span><span class="s2">, reset_eris= </span><span class="si">%r</span><span class="s2">, reset_inactive= </span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">reset_bath</span><span class="p">,</span>
            <span class="n">reset_cluster</span><span class="p">,</span>
            <span class="n">reset_eris</span><span class="p">,</span>
            <span class="n">reset_inactive</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reset_inactive</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">reset_bath</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dmet_bath</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bath_factory_occ</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bath_factory_vir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">reset_cluster</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">reset_eris</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamil</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seris_ov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Fragment.get_fragments_with_overlap">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_fragments_with_overlap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragments_with_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of fragments which overlap both in occupied and virtual space.&quot;&quot;&quot;</span>
        <span class="n">c_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[occ]|cluster[occ]&quot;</span><span class="p">)</span>
        <span class="n">c_vir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[vir]|cluster[vir]&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">svd</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
            <span class="n">rxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">rxy</span><span class="p">,</span> <span class="n">compute_uv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">frags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fx</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cx_occ</span> <span class="o">=</span> <span class="n">fx</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[occ]|cluster[occ]&quot;</span><span class="p">)</span>
            <span class="n">s_occ</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">c_occ</span><span class="p">,</span> <span class="n">cx_occ</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s_occ</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cx_vir</span> <span class="o">=</span> <span class="n">fx</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[vir]|cluster[vir]&quot;</span><span class="p">)</span>
            <span class="n">s_vir</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">c_vir</span><span class="p">,</span> <span class="n">cx_vir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s_vir</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">frags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frags</span></div>


<div class="viewcode-block" id="Fragment.couple_to_fragment">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.couple_to_fragment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">couple_to_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frag</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">frag</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot couple fragment with itself.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Coupling </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">frag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">coupled_fragments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fragment.couple_to_fragments">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.couple_to_fragments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">couple_to_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frags</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="n">frags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">couple_to_fragment</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fragment.get_fragment_mf_energy">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_fragment_mf_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragment_mf_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the part of the mean-field energy associated with the fragment.</span>

<span class="sd">        Does not include nuclear-nuclear repulsion!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_projector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="n">hveff</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_hcore</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_veff</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="n">occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_occ</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">e_mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hveff</span><span class="p">)[</span><span class="n">occ</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">e_mf</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">contributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if fragment contributes to expectation values, else False.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">auxiliary</span>

<div class="viewcode-block" id="Fragment.get_fragment_projector">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_fragment_projector">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragment_projector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">c_proj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Projector for one index of amplitudes local energy expression.</span>

<span class="sd">        Cost: N^2 if O(1) coeffs , N^3 if O(N) coeffs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coeff : ndarray, shape(n(AO), N)</span>
<span class="sd">            Occupied or virtual orbital coefficients.</span>
<span class="sd">        inverse : bool, optional</span>
<span class="sd">            Return 1-p instead. Default: False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        p : (n, n) array</span>
<span class="sd">            Projection matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">c_proj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_proj</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">coeff</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">(),</span> <span class="n">c_proj</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">p</span>
        <span class="k">return</span> <span class="n">p</span></div>


<div class="viewcode-block" id="Fragment.get_mo_occupation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_mo_occupation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_mo_occupation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get mean-field occupation numbers (diagonal of 1-RDM) of orbitals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mo_coeff : ndarray, shape(N, M)</span>
<span class="sd">            Orbital coefficients.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        occup : ndarray, shape(M)</span>
<span class="sd">            Occupation numbers of orbitals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="o">*</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">(),</span> <span class="n">mo_coeff</span><span class="p">)</span>
        <span class="n">occup</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ai,ab,bi-&gt;i&quot;</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">occup</span></div>


    <span class="c1"># def check_mo_occupation(self, expected, *mo_coeff, tol=None):</span>
    <span class="c1">#    if tol is None: tol = 2*self.opts.dmet_threshold</span>
    <span class="c1">#    occup = self.get_mo_occupation(*mo_coeff)</span>
    <span class="c1">#    if not np.allclose(occup, expected, atol=tol):</span>
    <span class="c1">#        raise RuntimeError(&quot;Incorrect occupation of orbitals (expected %f):\n%r&quot; % (expected, occup))</span>
    <span class="c1">#    return occup</span>

<div class="viewcode-block" id="Fragment.canonicalize_mo">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.canonicalize_mo">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">canonicalize_mo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">fock</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eigvals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Diagonalize Fock matrix within subspace.</span>

<span class="sd">        TODO: move to Embedding class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *mo_coeff : ndarrays</span>
<span class="sd">            Orbital coefficients.</span>
<span class="sd">        eigenvalues : ndarray</span>
<span class="sd">            Return MO energies of canonicalized orbitals.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo_canon : ndarray</span>
<span class="sd">            Canonicalized orbital coefficients.</span>
<span class="sd">        rot : ndarray</span>
<span class="sd">            Rotation matrix: np.dot(mo_coeff, rot) = mo_canon.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_fock</span><span class="p">()</span>
        <span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="o">*</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="n">fock</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">mo_coeff</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fock</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)</span>
        <span class="n">mo_energy</span><span class="p">,</span> <span class="n">rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">fock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Canonicalized MO energies:</span><span class="se">\n</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mo_energy</span><span class="p">)</span>
        <span class="n">mo_can</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">rot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sign_convention</span><span class="p">:</span>
            <span class="n">mo_can</span><span class="p">,</span> <span class="n">signs</span> <span class="o">=</span> <span class="n">fix_orbital_sign</span><span class="p">(</span><span class="n">mo_can</span><span class="p">)</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">*</span> <span class="n">signs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">rot</span><span class="p">),</span> <span class="n">mo_can</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mo_can</span><span class="p">,</span> <span class="n">rot</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">mo_coeff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eigvals</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mo_can</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">mo_energy</span>
        <span class="k">return</span> <span class="n">mo_can</span><span class="p">,</span> <span class="n">rot</span></div>


<div class="viewcode-block" id="Fragment.diagonalize_cluster_dm">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.diagonalize_cluster_dm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">diagonalize_cluster_dm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Diagonalize cluster (fragment+bath) DM to get fully occupied and virtual orbitals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *mo_coeff: array or list of arrays</span>
<span class="sd">            Orbital coefficients. If multiple are given, they will be stacked along their second dimension.</span>
<span class="sd">        dm1: array, optional</span>
<span class="sd">            Mean-field density matrix, used to separate occupied and virtual cluster orbitals.</span>
<span class="sd">            If None, `self.mf.make_rdm1()` is used. Default: None.</span>
<span class="sd">        tol: float, optional</span>
<span class="sd">            If set, check that all eigenvalues of the cluster DM are close</span>
<span class="sd">            to 0 or 2, with the tolerance given by tol. Default= 1e-4.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        c_cluster_occ: (n(AO), n(occ cluster)) array</span>
<span class="sd">            Occupied cluster orbital coefficients.</span>
<span class="sd">        c_cluster_vir: (n(AO), n(vir cluster)) array</span>
<span class="sd">            Virtual cluster orbital coefficients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>
        <span class="n">c_cluster</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="o">*</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">(),</span> <span class="n">c_cluster</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">norm</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tol</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Eigenvalues of cluster-DM not all close to 0 or </span><span class="si">%d</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">e</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">c_cluster</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c_cluster</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">c_cluster</span> <span class="o">=</span> <span class="n">fix_orbital_sign</span><span class="p">(</span><span class="n">c_cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">e</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">norm</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">c_cluster_occ</span><span class="p">,</span> <span class="n">c_cluster_vir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">c_cluster</span><span class="p">,</span> <span class="p">[</span><span class="n">nocc</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">c_cluster_occ</span><span class="p">,</span> <span class="n">c_cluster_vir</span></div>


<div class="viewcode-block" id="Fragment.project_ref_orbitals">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.project_ref_orbitals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">project_ref_orbitals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_ref</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Project reference orbitals into available space in new geometry.</span>

<span class="sd">        The projected orbitals will be ordered according to their eigenvalues within the space.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c : ndarray</span>
<span class="sd">            Orbital coefficients.</span>
<span class="sd">        c_ref : ndarray</span>
<span class="sd">            Orbital coefficients of reference orbitals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nref</span> <span class="o">=</span> <span class="n">c_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">nref</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Projecting </span><span class="si">%d</span><span class="s2"> reference orbitals into space of </span><span class="si">%d</span><span class="s2"> orbitals&quot;</span><span class="p">,</span> <span class="n">nref</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="c1"># Diagonalize reference orbitals among themselves (due to change in overlap matrix)</span>
        <span class="n">c_ref_orth</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">lo</span><span class="o">.</span><span class="n">vec_lowdin</span><span class="p">(</span><span class="n">c_ref</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">c_ref_orth</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">c_ref</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># Diagonalize projector in space</span>
        <span class="n">csc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">((</span><span class="n">c_ref_orth</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">csc</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">csc</span><span class="p">)</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">e</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span></div>


    <span class="c1"># --- Symmetry</span>
    <span class="c1"># ============</span>

<div class="viewcode-block" id="Fragment.copy">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.copy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create copy of fragment, without adding it to the fragments list.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">get_next_id</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(copy)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">kwargs_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwargs_copy</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c_frag&quot;</span><span class="p">,</span> <span class="s2">&quot;c_env&quot;</span><span class="p">,</span> <span class="s2">&quot;solver&quot;</span><span class="p">,</span> <span class="s2">&quot;atoms&quot;</span><span class="p">,</span> <span class="s2">&quot;aos&quot;</span><span class="p">,</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;sym_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;sym_op&quot;</span><span class="p">,</span> <span class="s2">&quot;mpi_rank&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">kwargs_copy</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">kwargs_copy</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">frag</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_copy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frag</span></div>


<div class="viewcode-block" id="Fragment.add_tsymmetric_fragments">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.add_tsymmetric_fragments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_tsymmetric_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tvecs</span><span class="p">,</span> <span class="n">symtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tvecs: array(3) of integers</span>
<span class="sd">            Each element represent the number of translation vector corresponding to the a0, a1, and a2 lattice vectors of the cell.</span>
<span class="sd">        symtol: float, optional</span>
<span class="sd">            Tolerance for the error of the mean-field density matrix between symmetry related fragments.</span>
<span class="sd">            If the largest absolute difference in the density-matrix is above this value,</span>
<span class="sd">            and exception will be raised. Default: 1e-6.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fragments: list</span>
<span class="sd">            List of T-symmetry related fragments. These will be automatically added to base.fragments and</span>
<span class="sd">            have the attributes `sym_parent` and `sym_op` set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>

        <span class="n">fragments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">tvecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="n">tvecs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="n">tvecs</span><span class="p">[</span><span class="mi">2</span><span class="p">]))):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tvec</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx</span> <span class="o">/</span> <span class="n">tvecs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dy</span> <span class="o">/</span> <span class="n">tvecs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">tvecs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">sym_op</span> <span class="o">=</span> <span class="n">SymmetryTranslation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">tvec</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sym_op</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;No T-symmetric fragment found for translation (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) of fragment </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Name for translationally related fragments</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_T(</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>
            <span class="c1"># Translated coefficients</span>
            <span class="n">c_frag_t</span> <span class="o">=</span> <span class="n">sym_op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_frag</span><span class="p">)</span>
            <span class="n">c_env_t</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Avoid expensive symmetry operation on environment orbitals</span>
            <span class="c1"># Check that translated fragment does not overlap with current fragment:</span>
            <span class="n">fragovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csc_dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_frag</span><span class="p">,</span> <span class="n">c_frag_t</span><span class="p">,</span> <span class="n">ovlp</span><span class="o">=</span><span class="n">ovlp</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">spinsym</span> <span class="o">==</span> <span class="s2">&quot;restricted&quot;</span><span class="p">:</span>
                <span class="n">fragovlp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fragovlp</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">spinsym</span> <span class="o">==</span> <span class="s2">&quot;unrestricted&quot;</span><span class="p">:</span>
                <span class="n">fragovlp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fragovlp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fragovlp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">fragovlp</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="s2">&quot;Translation (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) of fragment </span><span class="si">%s</span><span class="s2"> not orthogonal to original fragment (overlap= </span><span class="si">%.3e</span><span class="s2">)!&quot;</span><span class="p">,</span>
                    <span class="n">dx</span><span class="p">,</span>
                    <span class="n">dy</span><span class="p">,</span>
                    <span class="n">dz</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">fragovlp</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Overlapping fragment spaces.&quot;</span><span class="p">)</span>

            <span class="c1"># Add fragment</span>
            <span class="n">frag_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">get_next_id</span><span class="p">()</span>
            <span class="n">frag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Fragment</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                <span class="n">frag_id</span><span class="p">,</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">c_frag_t</span><span class="p">,</span>
                <span class="n">c_env_t</span><span class="p">,</span>
                <span class="n">sym_parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">sym_op</span><span class="o">=</span><span class="n">sym_op</span><span class="p">,</span>
                <span class="n">mpi_rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_rank</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">asdict</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">fragments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span>
            <span class="c1"># Check symmetry</span>
            <span class="c1"># (only for the primitive translations (1,0,0), (0,1,0), and (0,0,1) to reduce number of sym_op(c_env) calls)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">charge_err</span><span class="p">,</span> <span class="n">spin_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symmetry_error</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="n">dm1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">charge_err</span><span class="p">,</span> <span class="n">spin_err</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">symtol</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                        <span class="s2">&quot;Mean-field DM1 not symmetric for translation (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) of </span><span class="si">%s</span><span class="s2"> (errors: charge= </span><span class="si">%.3e</span><span class="s2">, spin= </span><span class="si">%.3e</span><span class="s2">)!&quot;</span><span class="p">,</span>
                        <span class="n">dx</span><span class="p">,</span>
                        <span class="n">dy</span><span class="p">,</span>
                        <span class="n">dz</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">charge_err</span><span class="p">,</span>
                        <span class="n">spin_err</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MF not symmetric under translation (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span>
                        <span class="s2">&quot;Mean-field DM symmetry error for translation (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) of </span><span class="si">%s</span><span class="s2">: charge= </span><span class="si">%.3e</span><span class="s2">, spin= </span><span class="si">%.3e</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">dx</span><span class="p">,</span>
                        <span class="n">dy</span><span class="p">,</span>
                        <span class="n">dz</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">charge_err</span><span class="p">,</span>
                        <span class="n">spin_err</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="n">fragments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fragments</span></div>


<div class="viewcode-block" id="Fragment.get_symmetry_parent">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_symmetry_parent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_symmetry_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span><span class="o">.</span><span class="n">get_symmetry_parent</span><span class="p">()</span></div>


<div class="viewcode-block" id="Fragment.get_symmetry_operation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_symmetry_operation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_symmetry_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SymmetryIdentity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">symmetry</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span></div>


<div class="viewcode-block" id="Fragment.get_symmetry_generations">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_symmetry_generations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_symmetry_generations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxgen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">maxgen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">generations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fragments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="o">**</span><span class="n">filters</span><span class="p">)</span>
        <span class="c1"># Direct children:</span>
        <span class="n">lastgen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="n">fragments</span><span class="p">,</span> <span class="n">sym_parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">generations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lastgen</span><span class="p">)</span>
        <span class="c1"># Children of children, etc:</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxgen</span> <span class="ow">or</span> <span class="mi">1000</span><span class="p">):</span>
            <span class="n">newgen</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fx</span> <span class="ow">in</span> <span class="n">lastgen</span><span class="p">:</span>
                <span class="n">newgen</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="n">fragments</span><span class="p">,</span> <span class="n">sym_parent</span><span class="o">=</span><span class="n">fx</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">newgen</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">generations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newgen</span><span class="p">)</span>
            <span class="n">lastgen</span> <span class="o">=</span> <span class="n">newgen</span>
        <span class="k">return</span> <span class="n">generations</span></div>


<div class="viewcode-block" id="Fragment.get_symmetry_children">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_symmetry_children">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_symmetry_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxgen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">):</span>
        <span class="n">gens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symmetry_generations</span><span class="p">(</span><span class="n">maxgen</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">)</span>
        <span class="c1"># Flatten list of lists:</span>
        <span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">gens</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">children</span></div>


<div class="viewcode-block" id="Fragment.get_symmetry_tree">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_symmetry_tree">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_symmetry_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxgen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a recursive tree:</span>

<span class="sd">        [(x, [children of x]), (y, [children of y]), ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">maxgen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maxgen</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="k">if</span> <span class="n">maxgen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c1"># Get direct children:</span>
        <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symmetry_children</span><span class="p">(</span><span class="n">maxgen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">)</span>
        <span class="c1"># Build tree recursively:</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">get_symmetry_tree</span><span class="p">(</span><span class="n">maxgen</span><span class="o">=</span><span class="n">maxgen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tree</span></div>


<div class="viewcode-block" id="Fragment.loop_symmetry_children">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.loop_symmetry_children">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_symmetry_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symtree</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxgen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_self</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loop over all symmetry related fragments, including children of children, etc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arrays : ndarray or list[ndarray], optional</span>
<span class="sd">            If arrays are passed, the symmetry operation of each symmetry related fragment will be</span>
<span class="sd">            applied to this array along the axis given in `axes`.</span>
<span class="sd">        axes : list[int], optional</span>
<span class="sd">            List of axes, along which the symmetry operation is applied for each element of `arrays`.</span>
<span class="sd">            If None, the first axis will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_yield</span><span class="p">(</span><span class="n">fragment</span><span class="p">,</span> <span class="n">arrays</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">arrays</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fragment</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">arrays</span>

        <span class="k">if</span> <span class="n">include_self</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">get_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxgen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">maxgen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maxgen</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="k">if</span> <span class="n">arrays</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">symtree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">symtree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symmetry_tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">child</span><span class="p">,</span> <span class="n">grandchildren</span> <span class="ow">in</span> <span class="n">symtree</span><span class="p">:</span>
            <span class="n">intermediates</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">sym_op</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">axes</span><span class="p">)]</span>
            <span class="k">yield</span> <span class="n">get_yield</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">intermediates</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">grandchildren</span> <span class="ow">and</span> <span class="n">maxgen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">child</span><span class="o">.</span><span class="n">loop_symmetry_children</span><span class="p">(</span>
                    <span class="n">intermediates</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">symtree</span><span class="o">=</span><span class="n">grandchildren</span><span class="p">,</span> <span class="n">maxgen</span><span class="o">=</span><span class="p">(</span><span class="n">maxgen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_symmetry_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Includes children of children, etc.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_symmetry_children</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetry_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Includes children of children, etc.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_symmetry_children</span> <span class="o">+</span> <span class="mi">1</span>

<div class="viewcode-block" id="Fragment.get_symmetry_error">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_symmetry_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_symmetry_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get translational symmetry error between two fragments.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>
        <span class="n">ovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="c1"># This fragment (x)</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">c_frag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coeff_env</span><span class="p">()))</span>
        <span class="n">dmx</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">cx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">,</span> <span class="n">cx</span><span class="p">)</span>
        <span class="c1"># Other fragment (y)</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">frag</span><span class="o">.</span><span class="n">c_frag</span><span class="p">,</span> <span class="n">frag</span><span class="o">.</span><span class="n">get_coeff_env</span><span class="p">()))</span>
        <span class="n">dmy</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">cy</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dmx</span> <span class="o">-</span> <span class="n">dmy</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">,</span> <span class="mf">0.0</span></div>


    <span class="c1"># def check_mf_tsymmetry(self):</span>
    <span class="c1">#    &quot;&quot;&quot;Check translational symmetry of the mean-field between fragment and its children.&quot;&quot;&quot;</span>
    <span class="c1">#    ovlp = self.base.get_ovlp()</span>
    <span class="c1">#    sds = dot(ovlp, self.mf.make_rdm1(), ovlp)</span>
    <span class="c1">#    c0 = np.hstack((self.c_frag, self.c_env))</span>
    <span class="c1">#    dm0 = dot(c0.T, sds, c0)</span>
    <span class="c1">#    for frag in self.get_symmetry_children():</span>
    <span class="c1">#        c1 = np.hstack((frag.c_frag, frag.c_env))</span>
    <span class="c1">#        dm1 = dot(c1.T, sds, c1)</span>
    <span class="c1">#        err = abs(dm1 - dm0).max()</span>
    <span class="c1">#        if err &gt; mf_tol:</span>
    <span class="c1">#            self.log.error(&quot;Mean-field not T-symmetric between %s and %s (error= %.3e)!&quot;,</span>
    <span class="c1">#                    self.name, frag.name, err)</span>
    <span class="c1">#            continue</span>
    <span class="c1">#        else:</span>
    <span class="c1">#            self.log.debugv(&quot;Mean-field T-symmetry error between %s and %s = %.3e&quot;, self.name, frag.name, err)</span>

    <span class="c1"># Bath and cluster</span>
    <span class="c1"># ----------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_bath_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">occtype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get bath-option, checking if a occupied-virtual specific option has been set.&quot;&quot;&quot;</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bath_options</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">occtype</span><span class="p">[:</span><span class="mi">3</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">opt</span>
        <span class="k">return</span> <span class="n">opts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<div class="viewcode-block" id="Fragment.make_bath">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.make_bath">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_bath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># --- DMET bath</span>
        <span class="n">dmet</span> <span class="o">=</span> <span class="n">DMET_Bath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dmet_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bath_options</span><span class="p">[</span><span class="s2">&quot;dmet_threshold&quot;</span><span class="p">])</span>
        <span class="n">dmet</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmet_bath</span> <span class="o">=</span> <span class="n">dmet</span>

        <span class="c1"># --- Additional bath</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_bath</span><span class="p">(</span><span class="n">occtype</span><span class="p">):</span>
            <span class="n">otype</span> <span class="o">=</span> <span class="n">occtype</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">otype</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;occ&quot;</span><span class="p">,</span> <span class="s2">&quot;vir&quot;</span><span class="p">)</span>
            <span class="n">btype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;bathtype&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
            <span class="c1"># DMET bath only</span>
            <span class="k">if</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;dmet&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># Full bath (for debugging)</span>
            <span class="k">if</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Full_Bath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dmet_bath</span><span class="o">=</span><span class="n">dmet</span><span class="p">,</span> <span class="n">occtype</span><span class="o">=</span><span class="n">occtype</span><span class="p">)</span>
            <span class="c1"># Energy-weighted DMET bath</span>
            <span class="k">if</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;ewdmet&quot;</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="n">max_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;max_order&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">EwDMET_Bath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dmet_bath</span><span class="o">=</span><span class="n">dmet</span><span class="p">,</span> <span class="n">occtype</span><span class="o">=</span><span class="n">occtype</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span>
            <span class="c1"># Spatially close orbitals</span>
            <span class="k">if</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;r2&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">R2_Bath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dmet</span><span class="p">,</span> <span class="n">occtype</span><span class="o">=</span><span class="n">occtype</span><span class="p">)</span>
            <span class="c1"># MP2 bath natural orbitals</span>
            <span class="k">if</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;mp2&quot;</span><span class="p">:</span>
                <span class="n">project_dmet_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;project_dmet_order&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="n">project_dmet_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;project_dmet_mode&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="n">addbuffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;addbuffer&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">occtype</span> <span class="o">==</span> <span class="s2">&quot;virtual&quot;</span>
                <span class="k">if</span> <span class="n">addbuffer</span><span class="p">:</span>
                    <span class="n">other</span> <span class="o">=</span> <span class="s2">&quot;occ&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">otype</span> <span class="o">==</span> <span class="s2">&quot;vir&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;vir&quot;</span>
                    <span class="n">c_buffer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dmet</span><span class="p">,</span> <span class="s2">&quot;c_env_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">other</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c_buffer</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">MP2_Bath</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">dmet_bath</span><span class="o">=</span><span class="n">dmet</span><span class="p">,</span>
                    <span class="n">occtype</span><span class="o">=</span><span class="n">occtype</span><span class="p">,</span>
                    <span class="n">c_buffer</span><span class="o">=</span><span class="n">c_buffer</span><span class="p">,</span>
                    <span class="n">project_dmet_order</span><span class="o">=</span><span class="n">project_dmet_order</span><span class="p">,</span>
                    <span class="n">project_dmet_mode</span><span class="o">=</span><span class="n">project_dmet_mode</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;rpa&quot;</span><span class="p">:</span>
                <span class="n">project_dmet_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;project_dmet_order&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="n">project_dmet_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;project_dmet_mode&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">RPA_Bath</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">dmet_bath</span><span class="o">=</span><span class="n">dmet</span><span class="p">,</span>
                    <span class="n">occtype</span><span class="o">=</span><span class="n">occtype</span><span class="p">,</span>
                    <span class="n">c_buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">project_dmet_order</span><span class="o">=</span><span class="n">project_dmet_order</span><span class="p">,</span>
                    <span class="n">project_dmet_mode</span><span class="o">=</span><span class="n">project_dmet_mode</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;bathtype= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">btype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bath_factory_occ</span> <span class="o">=</span> <span class="n">get_bath</span><span class="p">(</span><span class="n">occtype</span><span class="o">=</span><span class="s2">&quot;occupied&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bath_factory_vir</span> <span class="o">=</span> <span class="n">get_bath</span><span class="p">(</span><span class="n">occtype</span><span class="o">=</span><span class="s2">&quot;virtual&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fragment.make_cluster">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.make_cluster">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_orbitals</span><span class="p">(</span><span class="n">occtype</span><span class="p">):</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_bath_factory_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">occtype</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">btype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;bathtype&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;dmet&quot;</span><span class="p">:</span>
                <span class="n">c_bath</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">c_frozen</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmet_bath</span><span class="p">,</span> <span class="s2">&quot;c_env_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">occtype</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
                <span class="n">c_bath</span><span class="p">,</span> <span class="n">c_frozen</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">get_bath</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;r2&quot;</span><span class="p">:</span>
                <span class="n">rcut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;rcut&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="n">c_bath</span><span class="p">,</span> <span class="n">c_frozen</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">get_bath</span><span class="p">(</span><span class="n">rcut</span><span class="o">=</span><span class="n">rcut</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">btype</span> <span class="o">==</span> <span class="s2">&quot;ewdmet&quot;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="n">c_bath</span><span class="p">,</span> <span class="n">c_frozen</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">get_bath</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">btype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mp2&quot;</span><span class="p">,</span> <span class="s2">&quot;rpa&quot;</span><span class="p">,</span> <span class="s2">&quot;rpacorr&quot;</span><span class="p">]:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="n">truncation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;truncation&quot;</span><span class="p">,</span> <span class="n">occtype</span><span class="p">)</span>
                <span class="n">bno_threshold</span> <span class="o">=</span> <span class="n">BNO_Threshold</span><span class="p">(</span><span class="n">truncation</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
                <span class="n">c_bath</span><span class="p">,</span> <span class="n">c_frozen</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">get_bath</span><span class="p">(</span><span class="n">bno_threshold</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">return</span> <span class="n">c_bath</span><span class="p">,</span> <span class="n">c_frozen</span>

        <span class="n">c_bath_occ</span><span class="p">,</span> <span class="n">c_frozen_occ</span> <span class="o">=</span> <span class="n">get_orbitals</span><span class="p">(</span><span class="s2">&quot;occupied&quot;</span><span class="p">)</span>
        <span class="n">c_bath_vir</span><span class="p">,</span> <span class="n">c_frozen_vir</span> <span class="o">=</span> <span class="n">get_orbitals</span><span class="p">(</span><span class="s2">&quot;virtual&quot;</span><span class="p">)</span>
        <span class="n">c_active_occ</span> <span class="o">=</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">hstack_matrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmet_bath</span><span class="o">.</span><span class="n">c_cluster_occ</span><span class="p">,</span> <span class="n">c_bath_occ</span><span class="p">)</span>
        <span class="n">c_active_vir</span> <span class="o">=</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">hstack_matrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmet_bath</span><span class="o">.</span><span class="n">c_cluster_vir</span><span class="p">,</span> <span class="n">c_bath_vir</span><span class="p">)</span>
        <span class="c1"># Canonicalize orbitals</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;canonicalize&quot;</span><span class="p">,</span> <span class="s2">&quot;occupied&quot;</span><span class="p">):</span>
            <span class="n">c_active_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonicalize_mo</span><span class="p">(</span><span class="n">c_active_occ</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bath_option</span><span class="p">(</span><span class="s2">&quot;canonicalize&quot;</span><span class="p">,</span> <span class="s2">&quot;virtual&quot;</span><span class="p">):</span>
            <span class="n">c_active_vir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonicalize_mo</span><span class="p">(</span><span class="n">c_active_vir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="n">from_coeffs</span><span class="p">(</span><span class="n">c_active_occ</span><span class="p">,</span> <span class="n">c_active_vir</span><span class="p">,</span> <span class="n">c_frozen_occ</span><span class="p">,</span> <span class="n">c_frozen_vir</span><span class="p">)</span>

        <span class="c1"># Check occupations</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">check_occup</span><span class="p">(</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
            <span class="n">occup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mo_occupation</span><span class="p">(</span><span class="n">mo_coeff</span><span class="p">)</span>
            <span class="c1"># RHF</span>
            <span class="n">atol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bath_options</span><span class="p">[</span><span class="s2">&quot;occupation_tolerance&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">occup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">occup</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atol</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">occup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">occup</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">)</span>

        <span class="n">check_occup</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_total_occ</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">check_occup</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_total_vir</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orbitals for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">repr_size</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span> <span class="o">=</span> <span class="n">cluster</span>
        <span class="k">return</span> <span class="n">cluster</span></div>


<div class="viewcode-block" id="Fragment.make_bosonic_bath_target">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.make_bosonic_bath_target">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_bosonic_bath_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the target space for bosonic bath orbitals. This can either be the DMET cluster or the full space, and</span>
<span class="sd">        can include a projection onto the fragment.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_bath_options</span><span class="p">[</span><span class="s2">&quot;bathtype&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;rpa&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">target_space</span> <span class="o">=</span> <span class="n">RPA_Boson_Target_Space</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">target_orbitals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_bath_options</span><span class="p">[</span><span class="s2">&quot;target_orbitals&quot;</span><span class="p">],</span>
            <span class="n">local_projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_bath_options</span><span class="p">[</span><span class="s2">&quot;local_projection&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">target_excits</span> <span class="o">=</span> <span class="n">target_space</span><span class="o">.</span><span class="n">gen_target_excitation</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">target_excits</span><span class="p">,</span> <span class="n">target_excits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Fragment.make_bosonic_cluster">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.make_bosonic_cluster">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_bosonic_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m0_target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set bosonic component of the cluster.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_bath_options</span><span class="p">[</span><span class="s2">&quot;bathtype&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;rpa&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_boson_bath_factory</span> <span class="o">=</span> <span class="n">RPA_QBA_Bath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_m0</span><span class="o">=</span><span class="n">m0_target</span><span class="p">)</span>

        <span class="n">boson_threshold</span> <span class="o">=</span> <span class="n">Boson_Threshold</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_bath_options</span><span class="p">[</span><span class="s2">&quot;truncation&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_bath_options</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">c_bath</span><span class="p">,</span> <span class="n">c_frozen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boson_bath_factory</span><span class="o">.</span><span class="n">get_bath</span><span class="p">(</span><span class="n">boson_threshold</span><span class="o">=</span><span class="n">boson_threshold</span><span class="p">)</span>
        <span class="n">fullorbs</span> <span class="o">=</span> <span class="n">Orbitals</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">bosons</span> <span class="o">=</span> <span class="n">QuasiBosonOrbitals</span><span class="p">(</span><span class="n">fullorbs</span><span class="p">,</span> <span class="n">coeff_ex</span><span class="o">=</span><span class="n">c_bath</span><span class="p">)</span></div>


    <span class="c1"># --- Results</span>
    <span class="c1"># ===========</span>

<div class="viewcode-block" id="Fragment.get_fragment_mo_energy">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_fragment_mo_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragment_mo_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_active</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fock</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns approximate MO energies, using the the diagonal of the Fock matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c_active: array, optional</span>
<span class="sd">        fock: array, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">c_active</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c_active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active</span>
        <span class="k">if</span> <span class="n">fock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_fock</span><span class="p">()</span>
        <span class="n">mo_energy</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ai,ab,bi-&gt;i&quot;</span><span class="p">,</span> <span class="n">c_active</span><span class="p">,</span> <span class="n">fock</span><span class="p">,</span> <span class="n">c_active</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mo_energy</span></div>


<div class="viewcode-block" id="Fragment.get_fragment_dmet_energy">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_fragment_dmet_energy">[docs]</a>
    <span class="nd">@mpi</span><span class="o">.</span><span class="n">with_send</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">get_fragment_mpi_rank</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragment_dmet_energy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dm2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h1e_eff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hamil</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">part_cumulant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get fragment contribution to whole system DMET energy from cluster DMs.</span>

<span class="sd">        After fragment summation, the nuclear-nuclear repulsion must be added to get the total energy!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dm1: array, optional</span>
<span class="sd">            Cluster one-electron reduced density-matrix in cluster basis. If `None`, `self.results.dm1` is used. Default: None.</span>
<span class="sd">        dm2: array, optional</span>
<span class="sd">            Cluster two-electron reduced density-matrix in cluster basis. If `None`, `self.results.dm2` is used. Default: None.</span>
<span class="sd">        hamil : ClusterHamiltonian object.</span>
<span class="sd">            Object representing cluster hamiltonian, possibly including cached ERIs.</span>
<span class="sd">        part_cumulant: bool, optional</span>
<span class="sd">            If True, the 2-DM cumulant will be partitioned to calculate the energy. If False,</span>
<span class="sd">            the full 2-DM will be partitioned, as it is done in most of the DMET literature.</span>
<span class="sd">            True is recommended, unless checking for agreement with literature results. Default: True.</span>
<span class="sd">        approx_cumulant: bool, optional</span>
<span class="sd">            If True, the approximate cumulant, containing (delta 1-DM)-squared terms, is partitioned,</span>
<span class="sd">            instead of the true cumulant, if `part_cumulant=True`. Default: True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        e_dmet: float</span>
<span class="sd">            Electronic fragment DMET energy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_rank</span>
        <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">dm1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;DM1 not found for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">c_act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">hamil</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hamil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hamil</span>
        <span class="k">if</span> <span class="n">hamil</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hamil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frag_hamil</span><span class="p">()</span>

        <span class="n">eris</span> <span class="o">=</span> <span class="n">hamil</span><span class="o">.</span><span class="n">get_eris_bare</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dm2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">make_rdm2</span><span class="p">(</span><span class="n">with_dm1</span><span class="o">=</span><span class="ow">not</span> <span class="n">part_cumulant</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="n">approx_cumulant</span><span class="p">)</span>
        <span class="c1"># Get effective core potential</span>
        <span class="k">if</span> <span class="n">h1e_eff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">part_cumulant</span><span class="p">:</span>
                <span class="n">h1e_eff</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">c_act</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_hcore_for_energy</span><span class="p">(),</span> <span class="n">c_act</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use the original Hcore (without chemical potential modifications), but updated mf-potential!</span>
                <span class="n">h1e_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_hcore_for_energy</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_veff_for_energy</span><span class="p">(</span><span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">h1e_eff</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">c_act</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">h1e_eff</span><span class="p">,</span> <span class="n">c_act</span><span class="p">)</span>
                <span class="n">occ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span><span class="p">]</span>
                <span class="n">v_act</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;iipq-&gt;pq&quot;</span><span class="p">,</span> <span class="n">eris</span><span class="p">[</span><span class="n">occ</span><span class="p">,</span> <span class="n">occ</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;iqpi-&gt;pq&quot;</span><span class="p">,</span> <span class="n">eris</span><span class="p">[</span><span class="n">occ</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">occ</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">h1e_eff</span> <span class="o">-=</span> <span class="n">v_act</span>

        <span class="n">p_frag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_projector</span><span class="p">(</span><span class="n">c_act</span><span class="p">)</span>
        <span class="c1"># Check number of electrons</span>
        <span class="n">ne</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ix,ij,jx-&gt;&quot;</span><span class="p">,</span> <span class="n">p_frag</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">p_frag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Number of electrons for DMET energy in fragment </span><span class="si">%12s</span><span class="s2">: </span><span class="si">%.8f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>

        <span class="c1"># Evaluate energy</span>
        <span class="n">e1b</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;xj,xi,ij-&gt;&quot;</span><span class="p">,</span> <span class="n">h1e_eff</span><span class="p">,</span> <span class="n">p_frag</span><span class="p">,</span> <span class="n">dm1</span><span class="p">)</span>
        <span class="n">e2b</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;xjkl,xi,ijkl-&gt;&quot;</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">p_frag</span><span class="p">,</span> <span class="n">dm2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;E(DMET): E(1)= </span><span class="si">%s</span><span class="s2"> E(2)= </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">e1b</span><span class="p">),</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">e2b</span><span class="p">))</span>
        <span class="n">e_dmet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">sym_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">e1b</span> <span class="o">+</span> <span class="n">e2b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Fragment E(DMET)= </span><span class="si">%+16.8f</span><span class="s2"> Ha&quot;</span><span class="p">,</span> <span class="n">e_dmet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">timingv</span><span class="p">(</span><span class="s2">&quot;Time for DMET energy: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time_string</span><span class="p">(</span><span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">e_dmet</span></div>


    <span class="c1"># --- Counterpoise</span>
    <span class="c1"># ================</span>

<div class="viewcode-block" id="Fragment.make_counterpoise_mol">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.make_counterpoise_mol">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_counterpoise_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make molecule object for counterposise calculation.</span>

<span class="sd">        WARNING: This has only been tested for periodic systems so far!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rmax : float</span>
<span class="sd">            All atom centers within range `rmax` are added as ghost-atoms in the counterpoise correction.</span>
<span class="sd">        nimages : int, optional</span>
<span class="sd">            Number of neighboring unit cell in each spatial direction. Has no effect in open boundary</span>
<span class="sd">            calculations. Default: 5.</span>
<span class="sd">        unit : [&#39;A&#39;, &#39;B&#39;]</span>
<span class="sd">            Unit for `rmax`, either Angstrom (`A`) or Bohr (`B`).</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            Additional keyword arguments for returned PySCF Mole/Cell object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mol_cp : pyscf.gto.Mole or pyscf.pbc.gto.Cell</span>
<span class="sd">            Mole or Cell object with periodic boundary conditions removed</span>
<span class="sd">            and with ghost atoms added depending on `rmax` and `nimages`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">vayesta.misc</span>

        <span class="k">return</span> <span class="n">vayesta</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">counterpoise</span><span class="o">.</span><span class="n">make_mol</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rmax</span><span class="o">=</span><span class="n">rmax</span><span class="p">,</span> <span class="n">nimages</span><span class="o">=</span><span class="n">nimages</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>


    <span class="c1"># --- Orbital plotting</span>
    <span class="c1"># --------------------</span>

<div class="viewcode-block" id="Fragment.pop_analysis">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.pop_analysis">[docs]</a>
    <span class="nd">@mpi</span><span class="o">.</span><span class="n">with_send</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">get_fragment_mpi_rank</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pop_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cluster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span>
        <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">dm1</span>
        <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DM1 not found for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">dm1</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">make_frozen_rdm1</span><span class="p">()</span> <span class="o">+</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">coeff</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">pop_analysis</span><span class="p">(</span><span class="n">dm1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fragment.plot3d">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.plot3d">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">gridsize</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write cube density data of fragment orbitals to file.&quot;&quot;&quot;</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">gridsize</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">directory</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">CubeFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span><span class="n">nz</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">cube</span><span class="o">.</span><span class="n">add_orbital</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_frag</span><span class="p">)</span>
        <span class="n">cube</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>


<div class="viewcode-block" id="Fragment.check_solver">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.check_solver">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="n">is_uhf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span><span class="p">:</span>
            <span class="n">is_eb</span> <span class="o">=</span> <span class="s2">&quot;crpa_full&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_eb</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">check_solver_config</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">is_uhf</span><span class="p">,</span> <span class="n">is_eb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fragment.get_solver">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_solver">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span>
        <span class="n">cl_ham</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamil</span>
        <span class="n">solver_cls</span> <span class="o">=</span> <span class="n">get_solver_class</span><span class="p">(</span><span class="n">cl_ham</span><span class="p">,</span> <span class="n">solver</span><span class="p">)</span>
        <span class="n">solver_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solver_options</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
        <span class="n">cluster_solver</span> <span class="o">=</span> <span class="n">solver_cls</span><span class="p">(</span><span class="n">cl_ham</span><span class="p">,</span> <span class="o">**</span><span class="n">solver_opts</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cluster_solver</span><span class="o">.</span><span class="n">hamil</span><span class="o">.</span><span class="n">add_screening</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seris_ov</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cluster_solver</span></div>


<div class="viewcode-block" id="Fragment.get_local_rpa_correction">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_local_rpa_correction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_local_rpa_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hamil</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">e_loc_rpa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">ext_rpa_correction</span><span class="p">:</span>
            <span class="n">hamil</span> <span class="o">=</span> <span class="n">hamil</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamil</span>
            <span class="n">cumulant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">ext_rpa_correction</span> <span class="o">==</span> <span class="s2">&quot;cumulant&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">ext_rpa_correction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;erpa&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulant&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown external rpa correction </span><span class="si">%s</span><span class="s2"> specified.&quot;</span><span class="p">)</span>
            <span class="n">e_loc_rpa</span> <span class="o">=</span> <span class="n">hamil</span><span class="o">.</span><span class="n">calc_loc_erpa</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_seris_ov</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">cumulant</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e_loc_rpa</span></div>


<div class="viewcode-block" id="Fragment.get_frag_hamil">
<a class="viewcode-back" href="../../../../apidoc/vayesta.ewf.html#vayesta.core.qemb.fragment.Fragment.get_frag_hamil">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_frag_hamil</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;crpa_full&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bos_freqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span> <span class="o">=</span> <span class="n">get_frag_W</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">pcoupling</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pcoupled&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span><span class="p">),</span>
                    <span class="n">only_ov_screened</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;ov&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span><span class="p">),</span>
                    <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="c1"># This detects based on fragment what kind of Hamiltonian is appropriate (restricted and/or EB).</span>
        <span class="k">return</span> <span class="n">ClusterHamiltonian</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
            <span class="n">screening</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span><span class="p">,</span>
            <span class="n">cache_eris</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">store_eris</span><span class="p">,</span>
            <span class="n">match_fock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">match_cluster_fock</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Fragment.get_solver_options">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.fragment.Fragment.get_solver_options">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_solver_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AbstractMethodError</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>