

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vayesta.core.qemb.qemb &mdash; Vayesta 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Vayesta
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apidoc/modules.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Vayesta</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../vayesta.html">vayesta</a></li>
      <li class="breadcrumb-item active">vayesta.core.qemb.qemb</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vayesta.core.qemb.qemb</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf.mp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf.ci</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf.cc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf.pbc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf.pbc.tools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf.lib</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyscf.mp.mp2</span><span class="w"> </span><span class="kn">import</span> <span class="n">_mo_without_core</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.foldscf</span><span class="w"> </span><span class="kn">import</span> <span class="n">FoldedSCF</span><span class="p">,</span> <span class="n">fold_scf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.util</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">OptionsBase</span><span class="p">,</span>
    <span class="n">OrthonormalityError</span><span class="p">,</span>
    <span class="n">SymmetryError</span><span class="p">,</span>
    <span class="n">dot</span><span class="p">,</span>
    <span class="n">einsum</span><span class="p">,</span>
    <span class="n">energy_string</span><span class="p">,</span>
    <span class="n">getattr_recursive</span><span class="p">,</span>
    <span class="n">hstack</span><span class="p">,</span>
    <span class="n">log_method</span><span class="p">,</span>
    <span class="n">log_time</span><span class="p">,</span>
    <span class="n">with_doc</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">spinalg</span><span class="p">,</span> <span class="n">eris</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.scmf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PDMET</span><span class="p">,</span> <span class="n">Brueckner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.screening.screening_moment</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_screened_eris</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.mpi</span><span class="w"> </span><span class="kn">import</span> <span class="n">mpi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.qemb.register</span><span class="w"> </span><span class="kn">import</span> <span class="n">FragmentRegister</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.rpa</span><span class="w"> </span><span class="kn">import</span> <span class="n">ssRIRPA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.solver</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_solver_config</span>

<span class="c1"># Symmetry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.symmetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">SymmetryGroup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.symmetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">SymmetryInversion</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.symmetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">SymmetryReflection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.symmetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">SymmetryRotation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.symmetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">SymmetryTranslation</span>

<span class="c1"># Fragmentations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.fragmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">SAO_Fragmentation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.fragmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">IAO_Fragmentation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.fragmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">IAOPAO_Fragmentation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.fragmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">Site_Fragmentation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.fragmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">CAS_Fragmentation</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.misc.cptbisect</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChempotBisection</span>

<span class="c1"># Expectation values</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.qemb.corrfunc</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_corrfunc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.qemb.corrfunc</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_corrfunc_mf</span>

<span class="c1"># --- This Package</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.qemb.fragment</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fragment</span>

<span class="c1"># from . import helper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.qemb.rdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_rdm1_demo_rhf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.qemb.rdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_rdm2_demo_rhf</span>


<div class="viewcode-block" id="Options">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Options">[docs]</a>
<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Options</span><span class="p">(</span><span class="n">OptionsBase</span><span class="p">):</span>
    <span class="n">store_eris</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
        <span class="kc">True</span>  <span class="c1"># If True, ERIs will be stored in Fragment.hamil; otherwise they will be recalculated whenever needed.</span>
    <span class="p">)</span>
    <span class="n">global_frag_chempot</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Global fragment chemical potential (e.g. for democratically partitioned DMs)</span>
    <span class="n">dm_with_frozen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Add frozen parts to cluster DMs</span>
    <span class="c1"># --- Bath options</span>
    <span class="n">bath_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">OptionsBase</span><span class="o">.</span><span class="n">dict_with_defaults</span><span class="p">(</span>
        <span class="c1"># General</span>
        <span class="n">bathtype</span><span class="o">=</span><span class="s2">&quot;dmet&quot;</span><span class="p">,</span>
        <span class="n">canonicalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">occupation_tolerance</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
        <span class="c1"># DMET bath</span>
        <span class="n">dmet_threshold</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
        <span class="c1"># R2 bath</span>
        <span class="n">rcut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Ang&quot;</span><span class="p">,</span>
        <span class="c1"># EwDMET bath</span>
        <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_order</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>  <span class="c1"># +threshold (same as MP2 bath)</span>
        <span class="c1"># MP2 bath</span>
        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">truncation</span><span class="o">=</span><span class="s2">&quot;occupation&quot;</span><span class="p">,</span>
        <span class="n">project_dmet_order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">project_dmet_mode</span><span class="o">=</span><span class="s2">&quot;squared-entropy&quot;</span><span class="p">,</span>
        <span class="n">addbuffer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="c1"># The following options can be set occupied/virtual-specific:</span>
        <span class="n">bathtype_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bathtype_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">rcut_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">rcut_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unit_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unit_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">order_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">order_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_order_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_order_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">threshold_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">threshold_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">truncation_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">truncation_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">project_dmet_order_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">project_dmet_order_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">project_dmet_mode_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">project_dmet_mode_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">addbuffer_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">addbuffer_dmet_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">canonicalize_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">canonicalize_vir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># --- Bosonic bath options</span>
    <span class="n">bosonic_bath_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">OptionsBase</span><span class="o">.</span><span class="n">dict_with_defaults</span><span class="p">(</span>
        <span class="c1"># General</span>
        <span class="n">bathtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># construction options.</span>
        <span class="n">target_orbitals</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="n">local_projection</span><span class="o">=</span><span class="s2">&quot;fragment&quot;</span><span class="p">,</span>
        <span class="c1"># bath truncation options.</span>
        <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
        <span class="n">truncation</span><span class="o">=</span><span class="s2">&quot;occupation&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># --- Solver options</span>
    <span class="n">solver_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">OptionsBase</span><span class="o">.</span><span class="n">dict_with_defaults</span><span class="p">(</span>
        <span class="c1"># General</span>
        <span class="n">conv_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">n_moments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># CCSD</span>
        <span class="n">solve_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">conv_tol_normt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">level_shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">diis_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">diis_start_cycle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">iterative_damping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># FCI</span>
        <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">max_cycle</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">fix_spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lindep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">davidson_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">init_guess</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="c1"># EBFCI/EBCCSD</span>
        <span class="n">max_boson_occ</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="c1"># EBCC</span>
        <span class="n">ansatz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">store_as_ccsd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># Dump</span>
        <span class="n">dumpfile</span><span class="o">=</span><span class="s2">&quot;clusters.h5&quot;</span><span class="p">,</span>
        <span class="c1"># Callback</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># MP2</span>
        <span class="n">compress_cderi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>

    <span class="p">)</span>
    <span class="c1"># --- Other</span>
    <span class="n">symmetry_tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># Tolerance (in Bohr) for atomic positions</span>
    <span class="n">symmetry_mf_tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span>  <span class="c1"># Tolerance for mean-field solution</span>
    <span class="n">screening</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># What form of screening to use in clusters.</span>
    <span class="n">ext_rpa_correction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">match_cluster_fock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="Embedding">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Embedding</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for quantum embedding methods.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mf : pyscf.scf.SCF</span>
<span class="sd">        PySCF mean-field object.</span>
<span class="sd">    solver : str, optional</span>
<span class="sd">        Default solver for cluster problems. The available solvers depend on the embedding class.</span>
<span class="sd">        Default: &#39;CCSD&#39;.</span>
<span class="sd">    log : logging.Logger, optional</span>
<span class="sd">        Vayesta logger object. Default: None</span>
<span class="sd">    bath_options : dict, optional</span>
<span class="sd">        Bath specific options. The bath type is determined by the key `bathtype` (default: &#39;DMET&#39;).</span>
<span class="sd">        The following bath specific options can be specified.</span>

<span class="sd">        All bath types:</span>

<span class="sd">            dmet_threshold : float, optional</span>
<span class="sd">                Threshold for DMET bath orbitals. Orbitals with eigenvalues larger than `dmet_threshold`</span>
<span class="sd">                or smaller than 1-`dmet_threshold` will be added as bath orbitals. Default: 1e-6.</span>

<span class="sd">        MP2 bath (`bathtype = &#39;MP2&#39;`):</span>

<span class="sd">            threshold : float</span>
<span class="sd">                Threshold for MP2 natural orbital truncation. Orbitals with eigenvalues larger than</span>
<span class="sd">                `threshold` will be added as bath orbitals.</span>

<span class="sd">        R2 bath (`bathtype = &#39;R2&#39;`):</span>

<span class="sd">            rcut : float</span>
<span class="sd">                Range cutoff for R2 bath. Orbitals with eigenvalues smaller than `rcut` will be added</span>
<span class="sd">                as bath orbitals.</span>
<span class="sd">            unit : {&#39;Ang&#39;, &#39;Bohr&#39;}, optional</span>
<span class="sd">                Unit of `rcut`. Default: &#39;Ang&#39;.</span>

<span class="sd">    solver_options : dict, optional</span>
<span class="sd">        Solver specific options. The following solver specific options can be specified.</span>


<span class="sd">            conv_tol : float</span>
<span class="sd">                Energy convergence tolerance [valid for &#39;CISD&#39;, &#39;CCSD&#39;, &#39;TCCSD&#39;, &#39;FCI&#39;]</span>
<span class="sd">            conv_tol_normt : float</span>
<span class="sd">                Amplitude convergence tolerance [valid for &#39;CCSD&#39;, &#39;TCCSD&#39;]</span>
<span class="sd">            fix_spin : float</span>
<span class="sd">                Target specified spin state [valid for &#39;FCI&#39;]</span>
<span class="sd">            solve_lambda : bool</span>
<span class="sd">                Solve Lambda-equations [valid for &#39;CCSD&#39;, &#39;TCCSD&#39;]. If False, T-amplitudes are used instead.</span>
<span class="sd">            dumpfile : str</span>
<span class="sd">                Dump cluster orbitals and integrals to file [valid for &#39;Dump&#39;]</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mol</span>
<span class="sd">    nao</span>
<span class="sd">    ncells</span>
<span class="sd">    nmo</span>
<span class="sd">    nfrag</span>
<span class="sd">    e_mf</span>
<span class="sd">    log : logging.Logger</span>
<span class="sd">        Logger object.</span>
<span class="sd">    self.mf : pyscf.scf.SCF</span>
<span class="sd">        PySCF mean-field object.</span>
<span class="sd">    self.mo_energy : (nMO) array</span>
<span class="sd">        MO energies.</span>
<span class="sd">    self.mo_occ : (nMO) array</span>
<span class="sd">        MO occupation numbers.</span>
<span class="sd">    self.mo_coeff : (nAO, nMO) array</span>
<span class="sd">        MO coefficients.</span>
<span class="sd">    self.fragments : list</span>
<span class="sd">        List of fragments for embedding calculation.</span>
<span class="sd">    self.kcell : pyscf.pbc.gto.Cell</span>
<span class="sd">        For k-point sampled mean-field calculation, which have been folded to the supercell,</span>
<span class="sd">        this will hold the original primitive unit cell.</span>
<span class="sd">    self.kpts : (nK, 3) array</span>
<span class="sd">        For k-point sampled mean-field calculation, which have been folded to the supercell,</span>
<span class="sd">        this will hold the original k-points.</span>
<span class="sd">    self.kdf : pyscf.pbc.df.GDF</span>
<span class="sd">        For k-point sampled mean-field calculation, which have been folded to the supercell,</span>
<span class="sd">        this will hold the original Gaussian density-fitting object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Shadow these in inherited methods:</span>
    <span class="n">Fragment</span> <span class="o">=</span> <span class="n">Fragment</span>
    <span class="n">Options</span> <span class="o">=</span> <span class="n">Options</span>

    <span class="c1"># Deprecated:</span>
    <span class="n">is_rhf</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">is_uhf</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Use instead:</span>
    <span class="n">spinsym</span> <span class="o">=</span> <span class="s2">&quot;restricted&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;CCSD&quot;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># 1) Logging</span>
        <span class="c1"># ----------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span> <span class="ow">or</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;INITIALIZING </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=============</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span> <span class="o">*</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">indent</span><span class="p">():</span>
            <span class="c1"># 2) Options</span>
            <span class="c1"># ----------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># 3) Overwrite methods/attributes</span>
            <span class="c1"># -------------------------------</span>
            <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">overwrite</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Overwriting method </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Overwriting attribute </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

            <span class="c1"># 4) Mean-field</span>
            <span class="c1"># -------------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mf</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kcell</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kpts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kdf</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">madelung</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">with</span> <span class="n">log_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">timing</span><span class="p">,</span> <span class="s2">&quot;Time for mean-field setup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_mf</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>

            <span class="c1"># 5) Other</span>
            <span class="c1"># --------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span> <span class="o">=</span> <span class="n">SymmetryGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">symmetry_tol</span><span class="p">)</span>
            <span class="n">nimages</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">,</span> <span class="s2">&quot;subcellmesh&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nimages</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="o">.</span><span class="n">set_translations</span><span class="p">(</span><span class="n">nimages</span><span class="p">)</span>
            <span class="c1"># Rotations need to be added manually!</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">FragmentRegister</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">with_scmf</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Self-consistent mean-field</span>
            <span class="c1"># Initialize results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_mpi_bcast_mf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use mo_energy and mo_coeff from master MPI rank only.&quot;&quot;&quot;</span>
        <span class="c1"># If vayesta.misc.scf_with_mpi was used, we do not need broadcast</span>
        <span class="c1"># as the MO coefficients will already be the same</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="s2">&quot;with_mpi&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="n">log_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">timing</span><span class="p">,</span> <span class="s2">&quot;Time to broadcast mean-field to all MPI ranks: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="c1"># Check if all MPI ranks have the same mean-field MOs</span>
            <span class="c1"># mo_energy = mpi.world.gather(mf.mo_energy)</span>
            <span class="c1"># if mpi.is_master:</span>
            <span class="c1">#    moerr = np.max([abs(mo_energy[i] - mo_energy[0]).max() for i in range(len(mpi))])</span>
            <span class="c1">#    if moerr &gt; 1e-6:</span>
            <span class="c1">#        self.log.warning(&quot;Large difference of MO energies between MPI ranks= %.2e !&quot;, moerr)</span>
            <span class="c1">#    else:</span>
            <span class="c1">#        self.log.debugv(&quot;Largest difference of MO energies between MPI ranks= %.2e&quot;, moerr)</span>
            <span class="c1"># Use MOs of master process</span>
            <span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="Embedding.init_mf">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.init_mf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_mf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mf_orig</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mf</span>  <span class="c1"># Keep track of original mean-field object - be careful not to modify in any way, to avoid side effects!</span>
        <span class="p">)</span>

        <span class="c1"># Create shallow copy of mean-field object; this way it can be updated without side effects outside the quantum</span>
        <span class="c1"># embedding method if attributes are replaced in their entirety</span>
        <span class="c1"># (eg. `mf.mo_coeff = mo_new` instead of `mf.mo_coeff[:] = mo_new`).</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;type(mf)= </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">mf</span><span class="p">))</span>
        <span class="c1"># If the mean-field has k-points, automatically fold to the supercell:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">pbc</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">khf</span><span class="o">.</span><span class="n">KSCF</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">log_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">timing</span><span class="p">,</span> <span class="s2">&quot;Time for k-&gt;G folding of MOs: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">mf</span> <span class="o">=</span> <span class="n">fold_scf</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">FoldedSCF</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kcell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kdf</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">kmf</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">kmf</span><span class="o">.</span><span class="n">kpts</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">kmf</span><span class="o">.</span><span class="n">with_df</span>
        <span class="c1"># Make sure that all MPI ranks use the same MOs`:</span>
        <span class="k">if</span> <span class="n">mpi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mpi_bcast_mf</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mf</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_rhf</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_uhf</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot deduce RHF or UHF!&quot;</span><span class="p">)</span>

        <span class="c1"># Evaluating the Madelung constant is expensive - cache result</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_exxdiv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">madelung</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">pbc</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">madelung</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">kpt</span><span class="p">)</span>

        <span class="c1"># Original mean-field integrals - do not change these!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ovlp_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hcore_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">get_hcore</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_veff_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">get_veff</span><span class="p">()</span>
        <span class="c1"># Cached integrals - these can be changed!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ovlp_orig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hcore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hcore_orig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_veff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_veff_orig</span>

        <span class="c1"># Hartree-Fock energy - this can be different from mf.e_tot, when the mean-field</span>
        <span class="c1"># is not a (converged) HF calculations</span>
        <span class="n">e_mf</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">e_tot</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncells</span>
        <span class="n">e_hf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_mf</span>
        <span class="n">de</span> <span class="o">=</span> <span class="n">e_mf</span> <span class="o">-</span> <span class="n">e_hf</span>
        <span class="n">rde</span> <span class="o">=</span> <span class="n">de</span> <span class="o">/</span> <span class="n">e_mf</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Mean-field not converged!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initial E(mean-field)= </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">e_mf</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculated E(HF)=      </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">e_hf</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Difference dE=         </span><span class="si">%s</span><span class="s2"> ( </span><span class="si">%.1f%%</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">de</span><span class="p">),</span> <span class="n">rde</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rde</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Large difference between initial E(mean-field) and calculated E(HF)!&quot;</span><span class="p">)</span>

        <span class="c1"># FIXME (no RHF/UHF dependent code here)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rhf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;n(AO)= </span><span class="si">%4d</span><span class="s2">  n(MO)= </span><span class="si">%4d</span><span class="s2">  n(linear dep.)= </span><span class="si">%4d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;n(AO)= </span><span class="si">%4d</span><span class="s2">  n(alpha/beta-MO)= (</span><span class="si">%4d</span><span class="s2">, </span><span class="si">%4d</span><span class="s2">)  n(linear dep.)= (</span><span class="si">%4d</span><span class="s2">, </span><span class="si">%4d</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nao</span><span class="p">,</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nmo</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nao</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nao</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_orthonormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_name</span><span class="o">=</span><span class="s2">&quot;MO&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rhf</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;MO energies (occ):</span><span class="se">\n</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;MO energies (vir):</span><span class="se">\n</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;alpha-MO energies (occ):</span><span class="se">\n</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;beta-MO energies (occ):</span><span class="se">\n</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;alpha-MO energies (vir):</span><span class="se">\n</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;beta-MO energies (vir):</span><span class="se">\n</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="Embedding.change_options">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.change_options">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="n">fkwds</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fx</span><span class="o">.</span><span class="n">opts</span><span class="p">,</span> <span class="n">key</span><span class="p">)]}</span>
            <span class="n">fx</span><span class="o">.</span><span class="n">change_options</span><span class="p">(</span><span class="o">**</span><span class="n">fkwds</span><span class="p">)</span></div>


    <span class="c1"># --- Basic properties and methods</span>
    <span class="c1"># ================================</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mf&quot;</span><span class="p">]</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(&quot;</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%r</span><span class="s2">, &quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span>

    <span class="c1"># Mol/Cell properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mole or Cell object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">mol</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_exxdiv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Correction for divergent exact-exchange potential.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">,</span> <span class="s2">&quot;exxdiv&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">exxdiv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="Embedding.get_exxdiv">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_exxdiv">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_exxdiv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get divergent exact-exchange (exxdiv) energy correction and potential.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        e_exxdiv: float</span>
<span class="sd">            Divergent exact-exchange energy correction per unit cell.</span>
<span class="sd">        v_exxdiv: array</span>
<span class="sd">            Divergent exact-exchange potential correction in AO basis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_exxdiv</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span><span class="p">])</span>
        <span class="n">e_exxdiv</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">madelung</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">v_exxdiv</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">madelung</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Divergent exact-exchange (exxdiv) correction= </span><span class="si">%+16.8f</span><span class="s2"> Ha&quot;</span><span class="p">,</span> <span class="n">e_exxdiv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e_exxdiv</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">v_exxdiv</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pbc_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="s2">&quot;dimension&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nao</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of atomic orbitals.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">nao_nr</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ncells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of primitive cells within supercell.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">,</span> <span class="s2">&quot;with_df&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">with_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">with_df</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Mean-field properties</span>

    <span class="c1"># def init_vhf_ehf(self):</span>
    <span class="c1">#    &quot;&quot;&quot;Get Hartree-Fock potential and energy.&quot;&quot;&quot;</span>
    <span class="c1">#    if self.opts.recalc_vhf:</span>
    <span class="c1">#        self.log.debug(&quot;Calculating HF potential from mean-field object.&quot;)</span>
    <span class="c1">#        vhf = self.mf.get_veff()</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        self.log.debug(&quot;Calculating HF potential from MOs.&quot;)</span>
    <span class="c1">#        cs = np.dot(self.mo_coeff.T, self.get_ovlp())</span>
    <span class="c1">#        fock = np.dot(cs.T*self.mo_energy, cs)</span>
    <span class="c1">#        vhf = (fock - self.get_hcore())</span>
    <span class="c1">#    h1e = self.get_hcore_for_energy()</span>
    <span class="c1">#    ehf = self.mf.energy_tot(h1e=h1e, vhf=vhf)</span>
    <span class="c1">#    return vhf, ehf</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mo_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Molecular orbital energies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mo_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Molecular orbital coefficients.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mo_occ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Molecular orbital occupations.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_occ</span>

    <span class="c1"># MOs setters:</span>

    <span class="c1"># @mo_energy.setter</span>
    <span class="c1"># def mo_energy(self, mo_energy):</span>
    <span class="c1">#    &quot;&quot;&quot;Updating the MOs resets the effective potential cache `_veff`.&quot;&quot;&quot;</span>
    <span class="c1">#    self.log.debugv(&quot;MF attribute &#39;mo_energy&#39; is updated; deleting cached _veff.&quot;)</span>
    <span class="c1">#    #self._veff = None</span>
    <span class="c1">#    self.mf.mo_energy = mo_energy</span>

    <span class="c1"># @mo_coeff.setter</span>
    <span class="c1"># def mo_coeff(self, mo_coeff):</span>
    <span class="c1">#    &quot;&quot;&quot;Updating the MOs resets the effective potential cache `_veff`.&quot;&quot;&quot;</span>
    <span class="c1">#    self.log.debugv(&quot;MF attribute &#39;mo_coeff&#39; is updated; deleting chached _veff.&quot;)</span>
    <span class="c1">#    #self._veff = None</span>
    <span class="c1">#    self.mf.mo_coeff = mo_coeff</span>

    <span class="c1"># @mo_occ.setter</span>
    <span class="c1"># def mo_occ(self, mo_occ):</span>
    <span class="c1">#    &quot;&quot;&quot;Updating the MOs resets the effective potential cache `_veff`.&quot;&quot;&quot;</span>
    <span class="c1">#    self.log.debugv(&quot;MF attribute &#39;mo_occ&#39; is updated; deleting chached _veff.&quot;)</span>
    <span class="c1">#    #self._veff = None</span>
    <span class="c1">#    self.mf.mo_occ = mo_occ</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nmo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total number of molecular orbitals (MOs).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nocc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of occupied MOs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nvir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of virtual MOs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mo_energy_occ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Occupied MO energies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mo_energy_vir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Virtual MO coefficients.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nocc</span> <span class="p">:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mo_coeff_occ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Occupied MO coefficients.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mo_coeff_vir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Virtual MO coefficients.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span> <span class="p">:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">e_mf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total mean-field energy per unit cell (not folded supercell).</span>
<span class="sd">        Note that the input unit cell itself can be a supercell, in which case</span>
<span class="sd">        `e_mf` refers to this cell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hcore_for_energy</span><span class="p">()</span>
        <span class="n">vhf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_veff_for_energy</span><span class="p">()</span>
        <span class="n">e_mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">energy_tot</span><span class="p">(</span><span class="n">h1e</span><span class="o">=</span><span class="n">h1e</span><span class="p">,</span> <span class="n">vhf</span><span class="o">=</span><span class="n">vhf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e_mf</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncells</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">e_nuc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Nuclear-repulsion energy per unit cell (not folded supercell).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">energy_nuc</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncells</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">e_nonlocal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">ext_rpa_correction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="n">e_local</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">e_corr_rpa</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">symmetry_factor</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="n">sym_parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_rpa</span> <span class="o">-</span> <span class="p">(</span><span class="n">e_local</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>

    <span class="c1"># Embedding properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nfrag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of fragments.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>

<div class="viewcode-block" id="Embedding.loop">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.loop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loop over fragments.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">frag</span></div>


    <span class="c1"># --- Integral methods</span>
    <span class="c1"># ====================</span>

    <span class="c1"># Integrals of the original mean-field object - these cannot be changed:</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_ovlp_orig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ovlp_orig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_hcore_orig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hcore_orig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_veff_orig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_exxdiv</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_exxdiv</span><span class="p">:</span>
            <span class="n">v_exxdiv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exxdiv</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_veff_orig</span><span class="p">()</span> <span class="o">-</span> <span class="n">v_exxdiv</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_veff_orig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_fock_orig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hcore_orig</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_veff_orig</span><span class="p">(</span><span class="n">with_exxdiv</span><span class="o">=</span><span class="n">with_exxdiv</span><span class="p">)</span>

    <span class="c1"># Integrals which change with mean-field updates or chemical potential shifts:</span>

<div class="viewcode-block" id="Embedding.get_ovlp">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_ovlp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ovlp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;AO-overlap matrix.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ovlp</span></div>


<div class="viewcode-block" id="Embedding.get_hcore">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_hcore">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_hcore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Core Hamiltonian (kinetic energy plus nuclear-electron attraction).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hcore</span></div>


<div class="viewcode-block" id="Embedding.get_veff">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_veff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_veff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hartree-Fock Coulomb and exchange potential in AO basis.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_exxdiv</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_exxdiv</span><span class="p">:</span>
            <span class="n">v_exxdiv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exxdiv</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_veff</span><span class="p">(</span><span class="n">dm1</span><span class="o">=</span><span class="n">dm1</span><span class="p">)</span> <span class="o">-</span> <span class="n">v_exxdiv</span>
        <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_veff</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">get_veff</span><span class="p">(</span><span class="n">dm</span><span class="o">=</span><span class="n">dm1</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.get_fock">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_fock">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fock matrix in AO basis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hcore</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_veff</span><span class="p">(</span><span class="n">dm1</span><span class="o">=</span><span class="n">dm1</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="n">with_exxdiv</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.set_ovlp">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.set_ovlp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_ovlp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Changing ovlp matrix.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ovlp</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Embedding.set_hcore">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.set_hcore">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_hcore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Changing hcore matrix.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hcore</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Embedding.set_veff">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.set_veff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_veff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Changing veff matrix.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_veff</span> <span class="o">=</span> <span class="n">value</span></div>


    <span class="c1"># Integrals for energy evaluation</span>
    <span class="c1"># Overwriting these allows using different integrals for the energy evaluation</span>

<div class="viewcode-block" id="Embedding.get_hcore_for_energy">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_hcore_for_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_hcore_for_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Core Hamiltonian used for energy evaluation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hcore</span><span class="p">()</span></div>


<div class="viewcode-block" id="Embedding.get_veff_for_energy">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_veff_for_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_veff_for_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hartree-Fock potential used for energy evaluation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_veff</span><span class="p">(</span><span class="n">dm1</span><span class="o">=</span><span class="n">dm1</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="n">with_exxdiv</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.get_fock_for_energy">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_fock_for_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fock_for_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fock matrix used for energy evaluation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hcore_for_energy</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_veff_for_energy</span><span class="p">(</span><span class="n">dm1</span><span class="o">=</span><span class="n">dm1</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="n">with_exxdiv</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.get_fock_for_bath">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_fock_for_bath">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fock_for_bath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fock matrix used for bath orbitals.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fock</span><span class="p">(</span><span class="n">dm1</span><span class="o">=</span><span class="n">dm1</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="n">with_exxdiv</span><span class="p">)</span></div>


    <span class="c1"># Other integral methods:</span>

<div class="viewcode-block" id="Embedding.get_ovlp_power">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_ovlp_power">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ovlp_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">power</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get power of AO overlap matrix.</span>

<span class="sd">        For folded calculations, this uses the k-point sampled overlap, for better performance and accuracy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        power : float</span>
<span class="sd">            Matrix power.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        spow : (n(AO), n(AO)) array</span>
<span class="sd">            Matrix power of AO overlap matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">power</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kcell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="p">(</span><span class="n">e</span><span class="o">**</span><span class="n">power</span><span class="p">),</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kcell</span><span class="o">.</span><span class="n">pbc_intor</span><span class="p">(</span><span class="s2">&quot;int1e_ovlp&quot;</span><span class="p">,</span> <span class="n">hermi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kpts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kpts</span><span class="p">,</span> <span class="n">pbcopt</span><span class="o">=</span><span class="n">pyscf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">c_null_ptr</span><span class="p">())</span>
        <span class="n">ek</span><span class="p">,</span> <span class="n">vk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span>
        <span class="n">spowk</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;kai,ki,kbi-&gt;kab&quot;</span><span class="p">,</span> <span class="n">vk</span><span class="p">,</span> <span class="n">ek</span><span class="o">**</span><span class="n">power</span><span class="p">,</span> <span class="n">vk</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">spow</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">pbc</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">k2gamma</span><span class="o">.</span><span class="n">to_supercell_ao_integrals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kcell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpts</span><span class="p">,</span> <span class="n">spowk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spow</span></div>


    <span class="n">get_cderi</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">get_cderi</span>

    <span class="n">get_cderi_exspace</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">get_cderi_exspace</span>

    <span class="n">get_eris_array</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">get_eris_array</span>

    <span class="n">get_eris_object</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">get_eris_object</span>

<div class="viewcode-block" id="Embedding.build_screened_interactions">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.build_screened_interactions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_screened_interactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build screened interactions, be they dynamic or static.&quot;&quot;&quot;</span>
        <span class="n">have_static_screening</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">])</span>
        <span class="n">have_dynamic_screening</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_bath_options</span><span class="p">[</span><span class="s2">&quot;bathtype&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">have_static_screening</span> <span class="ow">and</span> <span class="n">have_dynamic_screening</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot currently use both static screened coulomb interaction and bosonic baths at the same time.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">have_static_screening</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_screened_eris</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">have_dynamic_screening</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_bosonic_bath</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.build_bosonic_bath">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.build_bosonic_bath">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_bosonic_bath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spinsym</span> <span class="o">!=</span> <span class="s2">&quot;restricted&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Bosonic baths are currently only compatible with a restricted formalism.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;BOSONIC BATH SETUP&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;==================&quot;</span><span class="p">)</span>

        <span class="n">fragments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sym_parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpi_rank</span><span class="o">=</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">log_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">timing</span><span class="p">,</span> <span class="s2">&quot;Total time for bath and clusters: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Generating required information for bosonic bath generation&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="c1"># Generate list of all required target information.</span>
            <span class="n">targets</span><span class="p">,</span> <span class="n">ntarget</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">make_bosonic_bath_target</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">])</span>
            <span class="n">target_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">targets</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
            <span class="n">rpa</span> <span class="o">=</span> <span class="n">ssRIRPA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">)</span>
            <span class="n">moments</span> <span class="o">=</span> <span class="n">rpa</span><span class="o">.</span><span class="n">kernel_moms</span><span class="p">(</span><span class="n">max_moment</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">target_rot</span><span class="o">=</span><span class="n">target_rot</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Split this into individual fragment contributions.</span>
            <span class="n">moments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vsplit</span><span class="p">(</span><span class="n">moments</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ntarget</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">moment</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fragments</span><span class="p">,</span> <span class="n">moments</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Making bosonic bath for </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot; on MPI process </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mpi</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span> <span class="k">if</span> <span class="n">mpi</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">indent</span><span class="p">():</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">make_bosonic_cluster</span><span class="p">(</span><span class="n">moment</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.build_screened_eris">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.build_screened_eris">[docs]</a>
    <span class="nd">@log_method</span><span class="p">()</span>
    <span class="nd">@with_doc</span><span class="p">(</span><span class="n">build_screened_eris</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_screened_eris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SCREENED INTERACTION SETUP&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;==========================&quot;</span><span class="p">)</span>
        <span class="n">nmomscr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span> <span class="o">==</span> <span class="s2">&quot;mrpa&quot;</span><span class="p">])</span>
        <span class="n">lov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">ext_rpa_correction</span><span class="p">:</span>
            <span class="n">cumulant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">ext_rpa_correction</span> <span class="o">==</span> <span class="s2">&quot;cumulant&quot;</span>
            <span class="k">if</span> <span class="n">nmomscr</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfrag</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;External dRPA correction currently requires all fragments use mrpa screening.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">ext_rpa_correction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;erpa&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulant&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown external rpa correction </span><span class="si">%s</span><span class="s2"> specified.&quot;</span><span class="p">)</span>
            <span class="n">lov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cderi</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff_occ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff_vir</span><span class="p">))</span>
            <span class="n">rpa</span> <span class="o">=</span> <span class="n">ssRIRPA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">lov</span><span class="o">=</span><span class="n">lov</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cumulant</span><span class="p">:</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="n">lov</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">lp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">l_</span> <span class="o">=</span> <span class="n">l_2</span> <span class="o">=</span> <span class="n">lp</span>

                <span class="k">if</span> <span class="n">lov</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ln</span> <span class="o">=</span> <span class="n">lov</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">lov</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">l_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lp</span><span class="p">,</span> <span class="n">ln</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">l_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lp</span><span class="p">,</span> <span class="o">-</span><span class="n">ln</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">l_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">l_</span><span class="p">,</span> <span class="n">l_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">l_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">l_2</span><span class="p">,</span> <span class="n">l_2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">m0</span> <span class="o">=</span> <span class="n">rpa</span><span class="o">.</span><span class="n">kernel_moms</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">target_rot</span><span class="o">=</span><span class="n">l_</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Deduct effective mean-field contribution and project the RHS and we&#39;re done.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_rpa</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,pq-&gt;&quot;</span><span class="p">,</span> <span class="n">m0</span> <span class="o">-</span> <span class="n">l_</span><span class="p">,</span> <span class="n">l_2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Calculate total dRPA energy in N^4 time; this is cheaper than screening calculations.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e_rpa</span><span class="p">,</span> <span class="n">energy_error</span> <span class="o">=</span> <span class="n">rpa</span><span class="o">.</span><span class="n">kernel_energy</span><span class="p">(</span><span class="n">correction</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_rpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_rpa</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncells</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set total RPA correlation energy contribution as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e_rpa</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nmomscr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SCREENED INTERACTION SETUP&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;==========================&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">log_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">timing</span><span class="p">,</span> <span class="s2">&quot;Time for screened interation setup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">build_screened_eris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">store_m0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">ext_rpa_correction</span><span class="p">,</span> <span class="n">cderi_ov</span><span class="o">=</span><span class="n">lov</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="c1"># Symmetry between fragments</span>
    <span class="c1"># --------------------------</span>

<div class="viewcode-block" id="Embedding.create_symmetric_fragments">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.create_symmetric_fragments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_symmetric_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetry</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mf_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_mf</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add rotationally or translationally symmetric fragments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mf_tol: float, optional</span>
<span class="sd">            Tolerance for the error of the mean-field density matrix between symmetry related fragments.</span>
<span class="sd">            If the largest absolute difference in the density-matrix is above this value,</span>
<span class="sd">            and exception will be raised. Default: self.opts.symmetry_mf_tol.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fragments: list</span>
<span class="sd">            List of T-symmetry related fragments. These will have the attributes `sym_parent` and `sym_op` set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_axes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">catch_default_axes</span><span class="p">(</span><span class="n">axis</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">default_axes</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">return</span> <span class="n">axis</span>

        <span class="n">symtype</span> <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">to_bohr</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ang&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">point</span> <span class="o">/</span> <span class="mf">0.529177210903</span>
            <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;latvec&quot;</span><span class="p">:</span>
                <span class="c1"># kcell = self.kcell if self.kcell is not None else self.mol</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kcell</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span><span class="o">.</span><span class="n">lattice_vectors</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;bohr&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">point</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unit= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">unit</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">shift_point_to_supercell</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Shift point in primitive cell to equivalent, scaled point in supercell.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kcell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># No PBC or no supercell</span>
                <span class="k">return</span> <span class="n">point</span>
            <span class="n">ak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kcell</span><span class="o">.</span><span class="n">lattice_vectors</span><span class="p">()</span>  <span class="c1"># primtive cell lattice vectors</span>
            <span class="n">bk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">ak</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">lattice_vectors</span><span class="p">()</span>  <span class="c1"># supercell lattice vectors</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ak</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="c1"># Shift in internal coordinates, then transform back</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">bk</span><span class="p">)</span> <span class="o">+</span> <span class="n">shift</span><span class="p">,</span> <span class="n">ak</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">point</span>

        <span class="k">if</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;inversion&quot;</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">to_bohr</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">],</span> <span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">])</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">shift_point_to_supercell</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span> <span class="ow">or</span> <span class="s2">&quot;I&quot;</span>
            <span class="n">symlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;reflection&quot;</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">to_bohr</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">],</span> <span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">])</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">shift_point_to_supercell</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;axis&quot;</span><span class="p">]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">catch_default_axes</span><span class="p">(</span><span class="n">axis</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">to_bohr</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">])</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span> <span class="ow">or</span> <span class="s2">&quot;M&quot;</span>
            <span class="n">symlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;rotation&quot;</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;axis&quot;</span><span class="p">]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">catch_default_axes</span><span class="p">(</span><span class="n">axis</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">to_bohr</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">])</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">to_bohr</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">],</span> <span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">])</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">shift_point_to_supercell</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
            <span class="n">symlist</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span> <span class="ow">or</span> <span class="s2">&quot;R&quot;</span>
        <span class="k">elif</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;translation&quot;</span><span class="p">:</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">])</span>
            <span class="n">symlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">translation</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="n">translation</span><span class="p">[</span><span class="mi">2</span><span class="p">])))[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span> <span class="ow">or</span> <span class="s2">&quot;T&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Symmetry type= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">symtype</span><span class="p">)</span>

        <span class="n">ovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">check_mf</span><span class="p">:</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fragments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fragments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">()</span>
        <span class="n">ftree</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fx</span><span class="p">]</span> <span class="k">for</span> <span class="n">fx</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symlist</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;inversion&quot;</span><span class="p">:</span>
                <span class="n">sym_op</span> <span class="o">=</span> <span class="n">SymmetryInversion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;inversion&quot;</span><span class="p">:</span>
                <span class="n">sym_op</span> <span class="o">=</span> <span class="n">SymmetryReflection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;reflection&quot;</span><span class="p">:</span>
                <span class="n">sym_op</span> <span class="o">=</span> <span class="n">SymmetryReflection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;rotation&quot;</span><span class="p">:</span>
                <span class="n">rotvec</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">sym</span> <span class="o">/</span> <span class="n">order</span><span class="p">)</span> <span class="o">*</span> <span class="n">axis</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
                <span class="n">sym_op</span> <span class="o">=</span> <span class="n">SymmetryRotation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">rotvec</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;translation&quot;</span><span class="p">:</span>
                <span class="n">transvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">/</span> <span class="n">translation</span>
                <span class="n">sym_op</span> <span class="o">=</span> <span class="n">SymmetryTranslation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">transvec</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">flist</span> <span class="ow">in</span> <span class="n">ftree</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Name for symmetry related fragment</span>
                <span class="k">if</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;inversion&quot;</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;reflection&quot;</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;rotation&quot;</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">symtype</span> <span class="o">==</span> <span class="s2">&quot;translation&quot;</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">(</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
                <span class="c1"># Translated coefficients</span>
                <span class="n">c_frag_t</span> <span class="o">=</span> <span class="n">sym_op</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">c_frag</span><span class="p">)</span>
                <span class="n">c_env_t</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Avoid expensive symmetry operation on environment orbitals</span>
                <span class="c1"># Check that translated fragment does not overlap with current fragment:</span>
                <span class="n">fragovlp</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_csc_dot</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">c_frag</span><span class="p">,</span> <span class="n">c_frag_t</span><span class="p">,</span> <span class="n">ovlp</span><span class="o">=</span><span class="n">ovlp</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spinsym</span> <span class="o">==</span> <span class="s2">&quot;restricted&quot;</span><span class="p">:</span>
                    <span class="n">fragovlp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fragovlp</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">spinsym</span> <span class="o">==</span> <span class="s2">&quot;unrestricted&quot;</span><span class="p">:</span>
                    <span class="n">fragovlp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fragovlp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fragovlp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">fragovlp</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> of fragment </span><span class="si">%s</span><span class="s2"> not orthogonal to original fragment (overlap= </span><span class="si">%.1e</span><span class="s2">)!&quot;</span><span class="p">,</span>
                        <span class="n">sym_op</span><span class="p">,</span>
                        <span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">fragovlp</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Overlapping fragment spaces (overlap= </span><span class="si">%.1e</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">fragovlp</span><span class="p">)</span>

                <span class="c1"># Add fragment</span>
                <span class="n">frag_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">get_next_id</span><span class="p">()</span>
                <span class="n">frag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fragment</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">frag_id</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">c_frag_t</span><span class="p">,</span>
                    <span class="n">c_env_t</span><span class="p">,</span>
                    <span class="n">solver</span><span class="o">=</span><span class="n">parent</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
                    <span class="n">sym_parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
                    <span class="n">sym_op</span><span class="o">=</span><span class="n">sym_op</span><span class="p">,</span>
                    <span class="n">mpi_rank</span><span class="o">=</span><span class="n">parent</span><span class="o">.</span><span class="n">mpi_rank</span><span class="p">,</span>
                    <span class="n">flags</span><span class="o">=</span><span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">flags</span><span class="p">),</span>
                    <span class="o">**</span><span class="n">parent</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">asdict</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="c1"># Check symmetry</span>
                <span class="c1"># (only for the first rotation or primitive translations (1,0,0), (0,1,0), and (0,0,1)</span>
                <span class="c1"># to reduce number of sym_op(c_env) calls)</span>
                <span class="k">if</span> <span class="n">check_mf</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">charge_err</span><span class="p">,</span> <span class="n">spin_err</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_symmetry_error</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="n">dm1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">charge_err</span><span class="p">,</span> <span class="n">spin_err</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mf_tol</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">symmetry_mf_tol</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                            <span class="s2">&quot;Mean-field DM1 not symmetric for </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> (errors: charge= </span><span class="si">%.1e</span><span class="s2">, spin= </span><span class="si">%.1e</span><span class="s2">)!&quot;</span><span class="p">,</span>
                            <span class="n">sym_op</span><span class="p">,</span>
                            <span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">charge_err</span><span class="p">,</span>
                            <span class="n">spin_err</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MF not symmetric under </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sym_op</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span>
                            <span class="s2">&quot;Mean-field DM symmetry error for </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">: charge= </span><span class="si">%.1e</span><span class="s2">, spin= </span><span class="si">%.1e</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">sym_op</span><span class="p">,</span>
                            <span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">charge_err</span><span class="p">,</span>
                            <span class="n">spin_err</span><span class="p">,</span>
                        <span class="p">)</span>

                <span class="c1"># Insert after parent fragment</span>
                <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span>
        <span class="n">fragments_sym</span> <span class="o">=</span> <span class="p">[</span><span class="n">fx</span> <span class="k">for</span> <span class="n">flist</span> <span class="ow">in</span> <span class="n">ftree</span> <span class="k">for</span> <span class="n">fx</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="k">return</span> <span class="n">fragments_sym</span></div>


<div class="viewcode-block" id="Embedding.create_invsym_fragments">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.create_invsym_fragments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_invsym_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Ang&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create inversion symmetric fragments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mf_tol: float, optional</span>
<span class="sd">            Tolerance for the error of the mean-field density matrix between symmetry related fragments.</span>
<span class="sd">            If the largest absolute difference in the density-matrix is above this value,</span>
<span class="sd">            and exception will be raised. Default: 1e-6.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fragments: list</span>
<span class="sd">            List of inversion-symmetry related fragments. These will have have the attributes `sym_parent` and `sym_op` set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symmetry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;inversion&quot;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_symmetric_fragments</span><span class="p">(</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="n">fragments</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.create_mirrorsym_fragments">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.create_mirrorsym_fragments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_mirrorsym_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Ang&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create mirror symmetric fragments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mf_tol: float, optional</span>
<span class="sd">            Tolerance for the error of the mean-field density matrix between symmetry related fragments.</span>
<span class="sd">            If the largest absolute difference in the density-matrix is above this value,</span>
<span class="sd">            and exception will be raised. Default: 1e-6.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fragments: list</span>
<span class="sd">            List of mirror-symmetry related fragments. These will have have the attributes `sym_parent` and `sym_op` set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symmetry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;reflection&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_symmetric_fragments</span><span class="p">(</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="n">fragments</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.create_rotsym_fragments">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.create_rotsym_fragments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_rotsym_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Ang&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create rotationally symmetric fragments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mf_tol: float, optional</span>
<span class="sd">            Tolerance for the error of the mean-field density matrix between symmetry related fragments.</span>
<span class="sd">            If the largest absolute difference in the density-matrix is above this value,</span>
<span class="sd">            and exception will be raised. Default: 1e-6.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fragments: list</span>
<span class="sd">            List of rotationally-symmetry related fragments. These will have have the attributes `sym_parent` and `sym_op` set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symmetry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;rotation&quot;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_symmetric_fragments</span><span class="p">(</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="n">fragments</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.create_transsym_fragments">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.create_transsym_fragments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_transsym_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create translationally symmetric fragments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        translation: array(3) of integers</span>
<span class="sd">            Each element represent the number of translation vector corresponding to the a0, a1, and a2 lattice vectors of the cell.</span>
<span class="sd">        mf_tol: float, optional</span>
<span class="sd">            Tolerance for the error of the mean-field density matrix between symmetry related fragments.</span>
<span class="sd">            If the largest absolute difference in the density-matrix is above this value,</span>
<span class="sd">            and exception will be raised. Default: 1e-6.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fragments: list</span>
<span class="sd">            List of T-symmetry related fragments. These will have the attributes `sym_parent` and `sym_op` set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symmetry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;translation&quot;</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_symmetric_fragments</span><span class="p">(</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="n">fragments</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.get_symmetry_parent_fragments">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_symmetry_parent_fragments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_symmetry_parent_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of all fragments, which are parents to symmetry related child fragments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        parents: list</span>
<span class="sd">            A list of all parent fragments, ordered in the same way as they appear in `self.fragments`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parents</span></div>


<div class="viewcode-block" id="Embedding.get_symmetry_child_fragments">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_symmetry_child_fragments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_symmetry_child_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_parents</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of all fragments, which are children to symmetry related parent fragments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        include_parents: bool, optional</span>
<span class="sd">            If true, the parent fragment of each symmetry group is prepended to each symmetry sublist.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        children: list of lists</span>
<span class="sd">            A list with the length of the number of parent fragments in the system, each element</span>
<span class="sd">            being another list containing all the children fragments of the given parent fragment.</span>
<span class="sd">            Both the outer and inner lists are ordered in the same way that the fragments appear in `self.fragments`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symmetry_parent_fragments</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">include_parents</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">]</span>
        <span class="n">parent_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">sym_parent</span><span class="o">.</span><span class="n">id</span>
            <span class="k">assert</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">parent_ids</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">parent_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="n">children</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">children</span></div>


<div class="viewcode-block" id="Embedding.get_fragments">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_fragments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all fragments which obey the specified conditions.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        **filters:</span>
<span class="sd">            List of returned fragments will be filtered according to specified</span>
<span class="sd">            keyword arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fragments: list</span>
<span class="sd">            List of fragments.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Only returns fragments with mpi_rank 0, 1, or 2:</span>

<span class="sd">        &gt;&gt;&gt; self.get_fragments(mpi_rank=[0,1,2])</span>

<span class="sd">        Only returns fragments with no symmetry parent:</span>

<span class="sd">        &gt;&gt;&gt; self.get_fragments(sym_parent=None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fragments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fragments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">filters</span> <span class="ow">or</span> <span class="n">options</span> <span class="ow">or</span> <span class="n">flags</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fragments</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_values_atleast_1d</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span> <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">filters</span> <span class="o">=</span> <span class="n">_values_atleast_1d</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_values_atleast_1d</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">_values_atleast_1d</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_skip</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">filt</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">filt</span><span class="p">):</span>
                <span class="k">return</span> <span class="ow">not</span> <span class="n">filt</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filt</span>

        <span class="n">filtered_fragments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Check filters:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="n">_skip</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Check options:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">getattr_recursive</span><span class="p">(</span><span class="n">frag</span><span class="o">.</span><span class="n">opts</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="n">_skip</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="c1"># Check flags:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">getattr_recursive</span><span class="p">(</span><span class="n">frag</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="n">_skip</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">filtered_fragments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filtered_fragments</span></div>


<div class="viewcode-block" id="Embedding.get_fragment_overlap_norm">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_fragment_overlap_norm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragment_overlap_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">occupied</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">virtual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get matrix of overlap norms between fragments.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fragments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fragments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fragment</span><span class="p">):</span>
            <span class="n">fragments</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">fragments</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">occupied</span> <span class="ow">or</span> <span class="n">virtual</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragments</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">ovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="n">nxy_occ</span> <span class="o">=</span> <span class="n">nxy_vir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">occupied</span><span class="p">:</span>
                <span class="n">cxs_occ</span> <span class="o">=</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spinalg</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">fx</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_occ</span><span class="p">),</span> <span class="n">ovlp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">virtual</span><span class="p">:</span>
                <span class="n">cxs_vir</span> <span class="o">=</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spinalg</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">fx</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_vir</span><span class="p">),</span> <span class="n">ovlp</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">fy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fragments</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">occupied</span><span class="p">:</span>
                    <span class="n">rxy_occ</span> <span class="o">=</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cxs_occ</span><span class="p">,</span> <span class="n">fy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_occ</span><span class="p">)</span>
                    <span class="n">nxy_occ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">spinalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rxy_occ</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="n">norm</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">virtual</span><span class="p">:</span>
                    <span class="n">rxy_vir</span> <span class="o">=</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cxs_vir</span><span class="p">,</span> <span class="n">fy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_vir</span><span class="p">)</span>
                    <span class="n">nxy_vir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">spinalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rxy_vir</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="n">norm</span><span class="p">))</span>
                <span class="n">overlap</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">((</span><span class="n">nxy_occ</span><span class="p">,</span> <span class="n">nxy_vir</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">overlap</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_absorb_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;TODO&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">fy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fx</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fy</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fx</span><span class="o">.</span><span class="n">active</span> <span class="ow">and</span> <span class="n">fy</span><span class="o">.</span><span class="n">active</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">svd</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
                    <span class="n">rxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>
                    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">rxy</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tol</span><span class="p">):</span>
                        <span class="n">nx</span> <span class="o">=</span> <span class="n">cx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">ny</span> <span class="o">=</span> <span class="n">cy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">swap</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="p">(</span><span class="n">nx</span> <span class="o">&gt;=</span> <span class="n">ny</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>
                        <span class="k">return</span> <span class="n">swap</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="n">cx_occ</span> <span class="o">=</span> <span class="n">fx</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[occ]|cluster[occ]&quot;</span><span class="p">)</span>
                <span class="n">cy_occ</span> <span class="o">=</span> <span class="n">fy</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[occ]|cluster[occ]&quot;</span><span class="p">)</span>
                <span class="n">swocc</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">cx_occ</span><span class="p">,</span> <span class="n">cy_occ</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">swocc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">cx_vir</span> <span class="o">=</span> <span class="n">fx</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[vir]|cluster[vir]&quot;</span><span class="p">)</span>
                <span class="n">cy_vir</span> <span class="o">=</span> <span class="n">fy</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[vir]|cluster[vir]&quot;</span><span class="p">)</span>
                <span class="n">swvir</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">cx_vir</span><span class="p">,</span> <span class="n">cy_vir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">swocc</span> <span class="o">!=</span> <span class="n">swvir</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Absorb smaller</span>
                <span class="k">if</span> <span class="n">swocc</span><span class="p">:</span>
                    <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fx</span>
                <span class="n">c_frag</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">fx</span><span class="o">.</span><span class="n">c_frag</span><span class="p">,</span> <span class="n">fy</span><span class="o">.</span><span class="n">c_frag</span><span class="p">)</span>
                <span class="n">fx</span><span class="o">.</span><span class="n">c_frag</span> <span class="o">=</span> <span class="n">c_frag</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">fx</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fy</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">fy</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subspace found: adding </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> (new name= </span><span class="si">%s</span><span class="s2">)!&quot;</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="c1"># Update fx</span>
                <span class="n">fx</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">fx</span><span class="o">.</span><span class="n">c_env</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">fx</span><span class="o">.</span><span class="n">_dmet_bath</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">fx</span><span class="o">.</span><span class="n">_occ_bath_factory</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">fx</span><span class="o">.</span><span class="n">_vir_bath_factory</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Results</span>
    <span class="c1"># -------</span>

<div class="viewcode-block" id="Embedding.communicate_clusters">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.communicate_clusters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">communicate_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Communicate cluster orbitals between MPI ranks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mpi</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="n">log_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">timing</span><span class="p">,</span> <span class="s2">&quot;Time to communicate clusters: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="n">sym_parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mpi_rank</span>
                <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">source</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">orig_mf</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">cluster</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">cluster</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="n">source</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">cluster</span> <span class="o">=</span> <span class="n">cluster</span>
                <span class="n">x</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">orig_mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span></div>


<div class="viewcode-block" id="Embedding.make_rdm1_demo">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.make_rdm1_demo">[docs]</a>
    <span class="nd">@log_method</span><span class="p">()</span>
    <span class="nd">@with_doc</span><span class="p">(</span><span class="n">make_rdm1_demo_rhf</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_rdm1_demo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">make_rdm1_demo_rhf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.make_rdm2_demo">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.make_rdm2_demo">[docs]</a>
    <span class="nd">@log_method</span><span class="p">()</span>
    <span class="nd">@with_doc</span><span class="p">(</span><span class="n">make_rdm2_demo_rhf</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_rdm2_demo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">make_rdm2_demo_rhf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.get_dmet_elec_energy">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_dmet_elec_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_dmet_elec_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part_cumulant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mpi_target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate electronic DMET energy via democratically partitioned density-matrices.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        part_cumulant: bool, optional</span>
<span class="sd">            If True, the 2-DM cumulant will be partitioned to calculate the energy. If False,</span>
<span class="sd">            the full 2-DM will be partitioned, as it is done in most of the DMET literature.</span>
<span class="sd">            True is recommended, unless checking for agreement with literature results. Default: True.</span>
<span class="sd">        approx_cumulant: bool, optional</span>
<span class="sd">            If True, the approximate cumulant, containing (delta 1-DM)-squared terms, is partitioned,</span>
<span class="sd">            instead of the true cumulant, if `part_cumulant=True`. Default: True.</span>
<span class="sd">        mpi_target: int or None, optional</span>
<span class="sd">            If set to an integer, the result will only be available at the specified MPI rank.</span>
<span class="sd">            If set to None, an MPI allreduce will be performed and the result will be available</span>
<span class="sd">            at all MPI ranks. Default: None. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        e_dmet: float</span>
<span class="sd">            Electronic DMET energy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">e_dmet</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mpi_rank</span><span class="o">=</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">sym_parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">wx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">symmetry_factor</span>
            <span class="n">e_dmet</span> <span class="o">+=</span> <span class="n">wx</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">get_fragment_dmet_energy</span><span class="p">(</span><span class="n">part_cumulant</span><span class="o">=</span><span class="n">part_cumulant</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="n">approx_cumulant</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mpi</span><span class="p">:</span>
            <span class="n">e_dmet</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">nreduce</span><span class="p">(</span><span class="n">e_dmet</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">mpi_target</span><span class="p">,</span> <span class="n">logfunc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">timingv</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">part_cumulant</span><span class="p">:</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_rdm1_demo</span><span class="p">(</span><span class="n">ao_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">approx_cumulant</span><span class="p">:</span>
                <span class="n">vhf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_veff_for_energy</span><span class="p">(</span><span class="n">dm1</span><span class="o">=</span><span class="n">dm1</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">approx_cumulant</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dm1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dm1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>
                <span class="n">vhf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_veff_for_energy</span><span class="p">(</span><span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="n">e_dmet</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vhf</span><span class="p">)</span> <span class="o">*</span> <span class="n">dm1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;E_elec(DMET)= </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">e_dmet</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">e_dmet</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncells</span></div>


<div class="viewcode-block" id="Embedding.get_dmet_energy">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_dmet_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_dmet_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part_cumulant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_nuc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_exxdiv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate DMET energy via democratically partitioned density-matrices.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        part_cumulant: bool, optional</span>
<span class="sd">            If True, the 2-DM cumulant will be partitioned to calculate the energy. If False,</span>
<span class="sd">            the full 2-DM will be partitioned, as it is done in most of the DMET literature.</span>
<span class="sd">            True is recommended, unless checking for agreement with literature results. Default: True.</span>
<span class="sd">        approx_cumulant: bool, optional</span>
<span class="sd">            If True, the approximate cumulant, containing (delta 1-DM)-squared terms, is partitioned,</span>
<span class="sd">            instead of the true cumulant, if `part_cumulant=True`. Default: True.</span>
<span class="sd">        with_nuc: bool, optional</span>
<span class="sd">            Include nuclear-repulsion energy. Default: True.</span>
<span class="sd">        with_exxdiv: bool, optional</span>
<span class="sd">            Include divergent exact-exchange correction. Default: True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        e_dmet: float</span>
<span class="sd">            DMET energy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">e_dmet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dmet_elec_energy</span><span class="p">(</span><span class="n">part_cumulant</span><span class="o">=</span><span class="n">part_cumulant</span><span class="p">,</span> <span class="n">approx_cumulant</span><span class="o">=</span><span class="n">approx_cumulant</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_nuc</span><span class="p">:</span>
            <span class="n">e_dmet</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_nuc</span>
        <span class="k">if</span> <span class="n">with_exxdiv</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_exxdiv</span><span class="p">:</span>
            <span class="n">e_dmet</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exxdiv</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">e_dmet</span></div>


    <span class="n">get_corrfunc_mf</span> <span class="o">=</span> <span class="n">log_method</span><span class="p">()(</span><span class="n">get_corrfunc_mf</span><span class="p">)</span>
    <span class="n">get_corrfunc</span> <span class="o">=</span> <span class="n">log_method</span><span class="p">()(</span><span class="n">get_corrfunc</span><span class="p">)</span>

    <span class="c1"># Utility</span>
    <span class="c1"># -------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_orthonormal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">crit_tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">err_tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check orthonormality of mo_coeff.&quot;&quot;&quot;</span>
        <span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="o">*</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">mo_coeff</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">(),</span> <span class="n">mo_coeff</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">mo_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="n">linf</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mo_name</span><span class="p">:</span>
            <span class="n">mo_name</span> <span class="o">=</span> <span class="s2">&quot; of </span><span class="si">%s</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="n">mo_name</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span> <span class="n">linf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">crit_tol</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Orthonormality error</span><span class="si">%s</span><span class="s2">: L(2)= </span><span class="si">%.2e</span><span class="s2">  L(inf)= </span><span class="si">%.2e</span><span class="s2"> !&quot;</span><span class="p">,</span> <span class="n">mo_name</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">linf</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">OrthonormalityError</span><span class="p">(</span><span class="s2">&quot;Orbitals not orhonormal!&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">max</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span> <span class="n">linf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">err_tol</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Orthonormality error</span><span class="si">%s</span><span class="s2">: L(2)= </span><span class="si">%.2e</span><span class="s2">  L(inf)= </span><span class="si">%.2e</span><span class="s2"> !&quot;</span><span class="p">,</span> <span class="n">mo_name</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">linf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Orthonormality error</span><span class="si">%s</span><span class="s2">: L(2)= </span><span class="si">%.2e</span><span class="s2">  L(inf)= </span><span class="si">%.2e</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mo_name</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">linf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l2</span><span class="p">,</span> <span class="n">linf</span>

<div class="viewcode-block" id="Embedding.get_mean_cluster_size">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_mean_cluster_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_mean_cluster_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">norb_active</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">])</span></div>


<div class="viewcode-block" id="Embedding.get_average_cluster_size">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_average_cluster_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_average_cluster_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">average</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_cluster_size</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span></div>


<div class="viewcode-block" id="Embedding.get_min_cluster_size">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_min_cluster_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_min_cluster_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">norb_active</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">])</span></div>


<div class="viewcode-block" id="Embedding.get_max_cluster_size">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_max_cluster_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_max_cluster_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">norb_active</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">])</span></div>


    <span class="c1"># --- Population analysis</span>
    <span class="c1"># -----------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_atom_projectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;sao&quot;</span><span class="p">,</span> <span class="n">orbital_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">atoms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atoms2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">natm</span><span class="p">))</span>
            <span class="c1"># For supercell systems, we do not want all supercell-atom pairs,</span>
            <span class="c1"># but only primitive-cell -- supercell pairs:</span>
            <span class="n">atoms1</span> <span class="o">=</span> <span class="n">atoms2</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kcell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kcell</span><span class="o">.</span><span class="n">natm</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="n">atoms1</span> <span class="o">=</span> <span class="n">atoms2</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atoms1</span><span class="p">,</span> <span class="n">atoms2</span> <span class="o">=</span> <span class="n">atoms</span>

        <span class="c1"># Get atomic projectors:</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s2">&quot;sao&quot;</span><span class="p">:</span>
            <span class="n">frag</span> <span class="o">=</span> <span class="n">SAO_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">projection</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;iaopao&quot;</span><span class="p">:</span>
            <span class="n">frag</span> <span class="o">=</span> <span class="n">IAOPAO_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s2">&quot;iao&quot;</span><span class="p">:</span>
            <span class="n">frag</span> <span class="o">=</span> <span class="n">IAO_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;IAO projection is not recommended for population analysis! Use IAO+PAO instead.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid projection: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">projection</span><span class="p">)</span>
        <span class="n">frag</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>
        <span class="n">ovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="n">projectors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spinalg</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">),</span> <span class="n">ovlp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">atoms1</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">atoms2</span><span class="p">)):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">get_atomic_fragment_indices</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">orbital_filter</span><span class="o">=</span><span class="n">orbital_filter</span><span class="p">)</span>
            <span class="n">c_atom</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">get_frag_coeff</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c_atom</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">no_orbs</span> <span class="o">=</span> <span class="n">c_atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c_atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">no_orbs</span> <span class="o">=</span> <span class="n">c_atom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">no_orbs</span> <span class="ow">and</span> <span class="n">orbital_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No orbitals found for atom </span><span class="si">%d</span><span class="s2"> when filtered!&quot;</span> <span class="o">%</span> <span class="n">atom</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No orbitals found for atom </span><span class="si">%d</span><span class="s2"> when filtered&quot;</span> <span class="o">%</span> <span class="n">atom</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">c_atom</span><span class="p">)</span>
            <span class="n">projectors</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">spinalg</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">atoms1</span><span class="p">,</span> <span class="n">atoms2</span><span class="p">,</span> <span class="n">projectors</span>

<div class="viewcode-block" id="Embedding.get_lo_coeff">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_lo_coeff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_lo_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_orbitals</span><span class="o">=</span><span class="s2">&quot;lowdin&quot;</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">local_orbitals</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;lowdin&quot;</span><span class="p">:</span>
            <span class="c1"># Avoid pre_orth_ao step!</span>
            <span class="c1"># self.c_lo = c_lo = pyscf.lo.orth_ao(self.mol, &#39;lowdin&#39;)</span>
            <span class="c1"># self.c_lo = c_lo = pyscf.lo.orth_ao(self.mol, &#39;meta-lowdin&#39;, pre_orth_ao=None)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp_power</span><span class="p">(</span><span class="n">power</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">local_orbitals</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;iao+pao&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">IAOPAO_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="n">minao</span><span class="p">)</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown local orbitals: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">local_orbitals</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.pop_analysis">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.pop_analysis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pop_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dm1</span><span class="p">,</span>
        <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">local_orbitals</span><span class="o">=</span><span class="s2">&quot;lowdin&quot;</span><span class="p">,</span>
        <span class="n">minao</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
        <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">orbital_resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">mpi_rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dm1 : (N, N) array</span>
<span class="sd">            If `mo_coeff` is None, AO representation is assumed.</span>
<span class="sd">        local_orbitals : {&#39;lowdin&#39;, &#39;mulliken&#39;, &#39;iao+pao&#39;} or array</span>
<span class="sd">            Kind of population analysis. Default: &#39;lowdin&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pop : (N) array</span>
<span class="sd">            Population of atomic orbitals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mo_coeff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ai,ij,bj-&gt;ab&quot;</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)</span>

        <span class="n">ovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_orbitals</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="n">local_orbitals</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lo</span> <span class="o">==</span> <span class="s2">&quot;mulliken&quot;</span><span class="p">:</span>
                <span class="n">c_lo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c_lo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lo_coeff</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="n">minao</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_lo</span> <span class="o">=</span> <span class="n">local_orbitals</span>

        <span class="k">if</span> <span class="n">c_lo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pop</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ba-&gt;a&quot;</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c_lo</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">)</span>
            <span class="n">pop</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ia,ab,ib-&gt;i&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">cs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">mpi_rank</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_population</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="n">filemode</span><span class="p">,</span> <span class="n">orbital_resolved</span><span class="o">=</span><span class="n">orbital_resolved</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pop</span></div>


<div class="viewcode-block" id="Embedding.get_atomic_charges">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.get_atomic_charges">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_atomic_charges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pop</span><span class="p">):</span>
        <span class="n">charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">natm</span><span class="p">)</span>
        <span class="n">spins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">natm</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pop</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">nao</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n(AO)= </span><span class="si">%d</span><span class="s2"> n(Pop)= </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">nao</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pop</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">ao_labels</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
            <span class="n">charges</span><span class="p">[</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-=</span> <span class="n">pop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">charges</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atom_charges</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">charges</span><span class="p">,</span> <span class="n">spins</span></div>


<div class="viewcode-block" id="Embedding.write_population">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.write_population">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">orbital_resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">charges</span><span class="p">,</span> <span class="n">spins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atomic_charges</span><span class="p">(</span><span class="n">pop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orbital_resolved</span><span class="p">:</span>
            <span class="n">aoslices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">aoslice_by_atom</span><span class="p">()[:,</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="n">aolabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">ao_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">write</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">write</span><span class="p">(</span><span class="s2">&quot;Population analysis&quot;</span><span class="p">)</span>
            <span class="n">write</span><span class="p">(</span><span class="s2">&quot;-------------------&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dirname</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filemode</span><span class="p">)</span>
            <span class="n">write</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">fmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
            <span class="n">tstamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing population analysis to file &quot;</span><span class="si">%s</span><span class="s1">&quot;. Time-stamp: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">tstamp</span><span class="p">)</span>
            <span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Time-stamp: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tstamp</span><span class="p">)</span>
            <span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Population analysis&quot;</span><span class="p">)</span>
            <span class="n">write</span><span class="p">(</span><span class="s2">&quot;# -------------------&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">charge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">charges</span><span class="p">):</span>
            <span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> </span><span class="si">%-7s</span><span class="s2">  q= </span><span class="si">% 11.8f</span><span class="s2">  s= </span><span class="si">% 11.8f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atom_symbol</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">spins</span><span class="p">[</span><span class="n">atom</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">orbital_resolved</span><span class="p">:</span>
                <span class="n">aos</span> <span class="o">=</span> <span class="n">aoslices</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ao</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aos</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">aolabels</span><span class="p">[</span><span class="n">ao</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">pop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">write</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%4d</span><span class="s2"> </span><span class="si">%-16s</span><span class="s2">= </span><span class="si">% 11.8f</span><span class="s2">  </span><span class="si">% 11.8f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">pop</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ao</span><span class="p">],</span> <span class="n">pop</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ao</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">write</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%4d</span><span class="s2"> </span><span class="si">%-16s</span><span class="s2">= </span><span class="si">% 11.8f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">pop</span><span class="p">[</span><span class="n">ao</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_fragment_nelectron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nelec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fragments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fragments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">is_envelop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nelec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nelec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">nelectron</span>
        <span class="n">nelec_frags</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">sym_factor</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">nelectron</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of electrons over </span><span class="si">%d</span><span class="s2"> fragments= </span><span class="si">%.8f</span><span class="s2">  target= </span><span class="si">%.8f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragments</span><span class="p">),</span> <span class="n">nelec_frags</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">nelec_frags</span> <span class="o">-</span> <span class="n">nelec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Number of mean-field electrons in fragments not equal to the target number of electrons.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nelec_frags</span>

    <span class="c1"># --- Fragmentation methods</span>

<div class="viewcode-block" id="Embedding.sao_fragmentation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.sao_fragmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sao_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the quantum embedding method for the use of SAO (Lowdin-AO) fragments.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SAO_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.site_fragmentation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.site_fragmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">site_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the quantum embedding method for the use of site fragments.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Site_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.iao_fragmentation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.iao_fragmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">iao_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the quantum embedding method for the use of IAO fragments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        minao: str, optional</span>
<span class="sd">            IAO reference basis set. Default: &#39;auto&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">IAO_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="n">minao</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.iaopao_fragmentation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.iaopao_fragmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">iaopao_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the quantum embedding method for the use of IAO+PAO fragments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        minao: str, optional</span>
<span class="sd">            IAO reference basis set. Default: &#39;auto&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">IAOPAO_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minao</span><span class="o">=</span><span class="n">minao</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.cas_fragmentation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.cas_fragmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cas_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the quantum embedding method for the use of site fragments.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CAS_Fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">complete_occupied</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">complete_virtual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if union of fragment spaces is orthonormal and complete.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spinsym</span> <span class="o">==</span> <span class="s2">&quot;restricted&quot;</span><span class="p">:</span>
            <span class="n">nspin</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">tspin</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">x</span>
            <span class="n">nelec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">nelectron</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">spinsym</span> <span class="o">==</span> <span class="s2">&quot;unrestricted&quot;</span><span class="p">:</span>
            <span class="n">nspin</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">tspin</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">nelec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">nelec</span>
        <span class="n">ovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="n">dm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspin</span><span class="p">):</span>
            <span class="n">nmo_s</span> <span class="o">=</span> <span class="n">tspin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmo</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">nelec_s</span> <span class="o">=</span> <span class="n">tspin</span><span class="p">(</span><span class="n">nelec</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">fragments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">(</span><span class="n">contributes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">is_secfrag</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fragments</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">c_frags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">tspin</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">c_frag</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">])</span>
            <span class="n">nfrags</span> <span class="o">=</span> <span class="n">c_frags</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">csc</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">c_frags</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">,</span> <span class="n">c_frags</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">csc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nfrags</span><span class="p">),</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tol</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Non-orthogonal error= </span><span class="si">%.3e</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">csc</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nfrags</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">complete_occupied</span> <span class="ow">and</span> <span class="n">complete_virtual</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nfrags</span> <span class="o">!=</span> <span class="n">nmo_s</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">complete_occupied</span> <span class="ow">or</span> <span class="n">complete_virtual</span><span class="p">:</span>
                <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c_frags</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">)</span>
                <span class="n">ne</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ia,ab,ib-&gt;&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">tspin</span><span class="p">(</span><span class="n">dm1</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="n">cs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">complete_occupied</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ne</span> <span class="o">-</span> <span class="n">nelec_s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">complete_virtual</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">nfrags</span> <span class="o">-</span> <span class="n">ne</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">nmo_s</span> <span class="o">-</span> <span class="n">nelec_s</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Embedding.has_orthonormal_fragmentation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.has_orthonormal_fragmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_orthonormal_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if union of fragment spaces is orthonormal.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_fragmentation</span><span class="p">(</span><span class="n">complete_occupied</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">complete_virtual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.has_complete_fragmentation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.has_complete_fragmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_complete_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if union of fragment spaces is orthonormal and complete.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_fragmentation</span><span class="p">(</span><span class="n">complete_occupied</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">complete_virtual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.has_complete_occupied_fragmentation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.has_complete_occupied_fragmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_complete_occupied_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if union of fragment spaces is orthonormal and complete in the occupied space.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_fragmentation</span><span class="p">(</span><span class="n">complete_occupied</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">complete_virtual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.has_complete_virtual_fragmentation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.has_complete_virtual_fragmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_complete_virtual_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if union of fragment spaces is orthonormal and complete in the virtual space.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_fragmentation</span><span class="p">(</span><span class="n">complete_occupied</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">complete_virtual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.require_complete_fragmentation">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.require_complete_fragmentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">require_complete_fragmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">incl_virtual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">incl_virtual</span><span class="p">:</span>
            <span class="n">complete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_complete_fragmentation</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">complete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_complete_occupied_fragmentation</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">complete</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Fragmentation is not orthogonal and complete.</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>


    <span class="c1"># --- Reset</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="n">fx</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_rpa</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Embedding.reset">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_fragments</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="c1"># --- Mean-field updates</span>

<div class="viewcode-block" id="Embedding.update_mf">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.update_mf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_mf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_energy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">veff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update underlying mean-field object.&quot;&quot;&quot;</span>
        <span class="c1"># Chech orthonormal MOs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">mo_coeff</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">(),</span> <span class="n">mo_coeff</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">mo_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MO coefficients not orthonormal!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mo_coeff</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">(</span><span class="n">mo_coeff</span><span class="o">=</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">veff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">veff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">get_veff</span><span class="p">(</span><span class="n">dm</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_veff</span><span class="p">(</span><span class="n">veff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mo_energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use diagonal of Fock matrix as MO energies</span>
            <span class="n">mo_energy</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ai,ab,bi-&gt;i&quot;</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fock</span><span class="p">(),</span> <span class="n">mo_coeff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span> <span class="o">=</span> <span class="n">mo_energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">e_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">energy_tot</span><span class="p">(</span><span class="n">dm</span><span class="o">=</span><span class="n">dm</span><span class="p">,</span> <span class="n">h1e</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_hcore</span><span class="p">(),</span> <span class="n">vhf</span><span class="o">=</span><span class="n">veff</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.check_fragment_symmetry">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.check_fragment_symmetry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_fragment_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dm1</span><span class="p">,</span> <span class="n">symtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check that the mean-field obeys the symmetry between fragments.&quot;&quot;&quot;</span>
        <span class="n">frags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symmetry_child_fragments</span><span class="p">(</span><span class="n">include_parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">frags</span><span class="p">:</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="n">charge_err</span><span class="p">,</span> <span class="n">spin_err</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_symmetry_error</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="n">dm1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">charge_err</span><span class="p">,</span> <span class="n">spin_err</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">symtol</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SymmetryError</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2"> not symmetric! Errors:  charge= </span><span class="si">%.2e</span><span class="s2">  spin= </span><span class="si">%.2e</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">charge_err</span><span class="p">,</span> <span class="n">spin_err</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span>
                        <span class="s2">&quot;Symmetry between </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">: Errors:  charge= </span><span class="si">%.2e</span><span class="s2">  spin= </span><span class="si">%.2e</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">charge_err</span><span class="p">,</span>
                        <span class="n">spin_err</span><span class="p">,</span>
                    <span class="p">)</span></div>


    <span class="c1"># --- Decorators</span>
    <span class="c1"># These replace the qemb.kernel method!</span>

<div class="viewcode-block" id="Embedding.optimize_chempot">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.optimize_chempot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_chempot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpt_init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dm1func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dm1kwds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dm1func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dm1func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_rdm1_demo</span>
        <span class="k">if</span> <span class="n">dm1kwds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dm1kwds</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">kernel_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="n">cpt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">iters</span><span class="p">,</span> <span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">global_frag_chempot</span> <span class="o">=</span> <span class="n">cpt</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">kernel_orig</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">dm1</span> <span class="o">=</span> <span class="n">dm1func</span><span class="p">(</span><span class="o">**</span><span class="n">dm1kwds</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rhf</span><span class="p">:</span>
                <span class="n">ne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">dm1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">dm1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">dm1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">ne</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">nelectron</span>
            <span class="n">iters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cpt</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_tot</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">err</span>

        <span class="n">bisect</span> <span class="o">=</span> <span class="n">ChempotBisection</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">cpt_init</span><span class="o">=</span><span class="n">cpt_init</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">iters</span><span class="p">,</span> <span class="n">result</span>
            <span class="n">cpt</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># Print info:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Chemical potential optimization&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------------------------&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Iteration   Chemical potential   N(elec) error  Converged         Total Energy&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">cpt</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">conv</span><span class="p">,</span> <span class="n">etot</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;  </span><span class="si">%9d</span><span class="s2">  </span><span class="si">%19s</span><span class="s2">  </span><span class="si">%+14.8f</span><span class="s2">  </span><span class="si">%9r</span><span class="s2">  </span><span class="si">%19s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">cpt</span><span class="p">),</span> <span class="n">err</span><span class="p">,</span> <span class="n">conv</span><span class="p">,</span> <span class="n">energy_string</span><span class="p">(</span><span class="n">etot</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bisect</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Chemical potential not found!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="Embedding.pdmet_scmf">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.pdmet_scmf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pdmet_scmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator for p-DMET.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_scmf</span> <span class="o">=</span> <span class="n">PDMET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_scmf</span><span class="o">.</span><span class="n">kernel</span></div>


<div class="viewcode-block" id="Embedding.brueckner_scmf">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.brueckner_scmf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">brueckner_scmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator for Brueckner-DMET.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_scmf</span> <span class="o">=</span> <span class="n">Brueckner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_scmf</span><span class="o">.</span><span class="n">kernel</span></div>

<div class="viewcode-block" id="Embedding.qpewdmet_scmf">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.qpewdmet_scmf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">qpewdmet_scmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator for QP-EWDMET.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.scmf</span><span class="w"> </span><span class="kn">import</span> <span class="n">QPEWDMET</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;QP-EWDMET requires Dyson installed&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_scmf</span> <span class="o">=</span> <span class="n">QPEWDMET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_scmf</span><span class="o">.</span><span class="n">kernel</span></div>

<div class="viewcode-block" id="Embedding.check_solver">
<a class="viewcode-back" href="../../../../apidoc/vayesta.core.qemb.html#vayesta.core.qemb.qemb.Embedding.check_solver">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="n">is_uhf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span><span class="p">:</span>
            <span class="n">is_eb</span> <span class="o">=</span> <span class="s2">&quot;crpa_full&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">screening</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_eb</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">check_solver_config</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">is_uhf</span><span class="p">,</span> <span class="n">is_eb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>