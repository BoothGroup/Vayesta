

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vayesta.edmet.fragment &mdash; Vayesta 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Vayesta
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/modules.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Vayesta</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../vayesta.html">vayesta</a></li>
          <li class="breadcrumb-item"><a href="../edmet.html">vayesta.edmet</a></li>
      <li class="breadcrumb-item active">vayesta.edmet.fragment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vayesta.edmet.fragment</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">timeit</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyscf.lib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.linalg</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">dot</span><span class="p">,</span> <span class="n">einsum</span><span class="p">,</span> <span class="n">log_time</span><span class="p">,</span> <span class="n">time_string</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.dmet.fragment</span><span class="w"> </span><span class="kn">import</span> <span class="n">DMETFragment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.solver</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_solver_config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vayesta.core.bath</span><span class="w"> </span><span class="kn">import</span> <span class="n">helper</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">pyscf</span><span class="w"> </span><span class="kn">import</span> <span class="n">__config__</span>


<div class="viewcode-block" id="EDMETFragmentExit">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragmentExit">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EDMETFragmentExit</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="Options">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.Options">[docs]</a>
<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Options</span><span class="p">(</span><span class="n">DMETFragment</span><span class="o">.</span><span class="n">Options</span><span class="p">):</span>
    <span class="n">make_dd_moments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">old_sc_condition</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_bos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">occ_proj_kernel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">boson_xc_kernel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bosonic_interaction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="EDMETFragment">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EDMETFragment</span><span class="p">(</span><span class="n">DMETFragment</span><span class="p">):</span>
    <span class="n">Options</span> <span class="o">=</span> <span class="n">Options</span>

<div class="viewcode-block" id="EDMETFragment.Results">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.Results">[docs]</a>
    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Results</span><span class="p">(</span><span class="n">DMETFragment</span><span class="o">.</span><span class="n">Results</span><span class="p">):</span>
        <span class="n">dm_eb</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">eb_couplings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">boson_freqs</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dd_mom0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dd_mom1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">e_fb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_xc_contrib</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ov_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nvir_active</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ov_active_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ov_mf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nvir</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nbos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span><span class="o">.</span><span class="n">nbos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bosons are not yet defined!&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">r_bos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Symmetry transformation for EDMET bosons in particle-hole basis is not yet implemented.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_bos</span>

    <span class="nd">@r_bos</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">r_bos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot set attribute r_bos in symmetry derived fragment.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_r_bos</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">r_bos_ao</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># NB this is the definition of the bosons as a rotation of AO pair excitations.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Need to convert bosonic definition from ov-excitations into ao pairs.</span>
            <span class="n">r_bos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span>
            <span class="n">co</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff_occ</span>
            <span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff_vir</span>
            <span class="n">r_bosa</span> <span class="o">=</span> <span class="n">r_bos</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nvir</span><span class="p">))</span>
            <span class="n">r_bosb</span> <span class="o">=</span> <span class="n">r_bos</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nvir</span><span class="p">))</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nia,pi,qa-&gt;npq&quot;</span><span class="p">,</span> <span class="n">r_bosa</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">cv</span><span class="p">),</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nia,pi,qa-&gt;npq&quot;</span><span class="p">,</span> <span class="n">r_bosb</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">cv</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">r_bos_ao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_parent</span><span class="o">.</span><span class="n">r_bos_ao</span>
            <span class="c1"># Need to rotate to account for symmetry operations.</span>
            <span class="n">r_bos_ao</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r_bos_ao</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r_bos_ao</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">r_ao_bos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This is the rotation from the bosons into the AO basis.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,pr,qs-&gt;nrs&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos_ao</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_couplings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ecouplings</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span>

    <span class="nd">@energy_couplings</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_couplings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ecouplings</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="EDMETFragment.check_solver">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.check_solver">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="n">is_uhf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">is_eb</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">check_solver_config</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">is_uhf</span><span class="p">,</span> <span class="n">is_eb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span></div>


<div class="viewcode-block" id="EDMETFragment.get_fock">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_fock">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_fock</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span></div>


<div class="viewcode-block" id="EDMETFragment.get_co_active">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_co_active">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_co_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">co</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active_occ</span>
        <span class="k">return</span> <span class="n">co</span><span class="p">,</span> <span class="n">co</span></div>


<div class="viewcode-block" id="EDMETFragment.get_cv_active">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_cv_active">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cv_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active_vir</span>
        <span class="k">return</span> <span class="n">cv</span><span class="p">,</span> <span class="n">cv</span></div>


<div class="viewcode-block" id="EDMETFragment.get_rot_to_mf_ov">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_rot_to_mf_ov">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_rot_to_mf_ov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[occ]|cluster[occ]&quot;</span><span class="p">)</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[vir]|cluster[vir]&quot;</span><span class="p">)</span>
        <span class="n">spat_rot</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;iJ,aB-&gt;iaJB&quot;</span><span class="p">,</span> <span class="n">ro</span><span class="p">,</span> <span class="n">rv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span><span class="p">))</span>
        <span class="n">res</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span><span class="p">]</span> <span class="o">=</span> <span class="n">spat_rot</span>
        <span class="n">res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span><span class="p">]</span> <span class="o">=</span> <span class="n">spat_rot</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="EDMETFragment.get_fragment_projector_ov">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_fragment_projector_ov">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragment_projector_ov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">inc_bosons</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;In space of cluster p-h excitations, generate the projector to the impurity portion of the occupied index.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;o&quot;</span> <span class="ow">in</span> <span class="n">proj</span> <span class="ow">or</span> <span class="s2">&quot;v&quot;</span> <span class="ow">in</span> <span class="n">proj</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Must project the occupied and/or virtual index to the fragment. Please specify at least &quot;</span> <span class="s2">&quot;one&quot;</span>
            <span class="p">)</span>

        <span class="n">nex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span>
        <span class="k">if</span> <span class="n">inc_bosons</span><span class="p">:</span>
            <span class="n">nex</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbos</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_ov_projector</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">pv</span><span class="p">):</span>
            <span class="n">p_ov_spat</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ab-&gt;iajb&quot;</span><span class="p">,</span> <span class="n">po</span><span class="p">,</span> <span class="n">pv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">))</span>
            <span class="n">p_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nex</span><span class="p">,</span> <span class="n">nex</span><span class="p">))</span>
            <span class="n">p_ov</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_ov_spat</span>
            <span class="n">p_ov</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_ov_spat</span>
            <span class="k">return</span> <span class="n">p_ov</span>

        <span class="n">p_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nex</span><span class="p">,</span> <span class="n">nex</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;o&quot;</span> <span class="ow">in</span> <span class="n">proj</span><span class="p">:</span>
            <span class="n">po</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_projector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active_occ</span><span class="p">)</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nvir_active</span><span class="p">)</span>
            <span class="n">p_ov</span> <span class="o">+=</span> <span class="n">get_ov_projector</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">pv</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;v&quot;</span> <span class="ow">in</span> <span class="n">proj</span><span class="p">:</span>
            <span class="n">po</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span><span class="p">)</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_projector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active_vir</span><span class="p">)</span>
            <span class="n">p_ov</span> <span class="o">+=</span> <span class="n">get_ov_projector</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">pv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p_ov</span></div>


<div class="viewcode-block" id="EDMETFragment.set_up_fermionic_bath">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.set_up_fermionic_bath">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_up_fermionic_bath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the fermionic bath orbitals&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_bath</span><span class="p">()</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_cluster</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c_active_occ</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">c_active_occ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c_active_vir</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">c_active_vir</span>
        <span class="c1"># Want to return the rotation of the canonical HF orbitals which produce the cluster canonical orbitals.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rot_to_mf_ov</span><span class="p">()</span></div>


<div class="viewcode-block" id="EDMETFragment.define_bosons">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.define_bosons">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_bosons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpa_mom</span><span class="p">,</span> <span class="n">rot_ov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given the RPA zeroth moment between the fermionic cluster excitations and the rest of the space, define</span>
<span class="sd">        our cluster bosons.</span>
<span class="sd">        Note that this doesn&#39;t define our Hamiltonian, since we don&#39;t yet have the required portion of our</span>
<span class="sd">        zeroth moment for the bosonic degrees of freedom.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rot_ov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rot_ov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rot_to_mf_ov</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpa_mom</span> <span class="o">=</span> <span class="n">rpa_mom</span>
        <span class="c1"># Need to remove fermionic degrees of freedom from moment contribution. Null space of rotation matrix is size</span>
        <span class="c1"># N^4, so instead deduct projection onto fermionic space.</span>
        <span class="n">rot_ov_pinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">rot_ov</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">env_mom</span> <span class="o">=</span> <span class="n">rpa_mom</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">rpa_mom</span><span class="p">,</span> <span class="n">rot_ov</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">rot_ov_pinv</span><span class="p">)</span>
        <span class="c1"># v defines the rotation of the mean-field excitation space specifying our bosons.</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">env_mom</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">want</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">tol</span>
        <span class="n">nbos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">want</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">max_bos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Zeroth moment matching generated </span><span class="si">%d</span><span class="s2"> cluster bosons.Largest discarded singular value: </span><span class="si">%4.2e</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">nbos</span><span class="p">,</span>
                <span class="n">s</span><span class="p">[</span><span class="n">nbos</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Zeroth moment matching generated </span><span class="si">%d</span><span class="s2"> cluster bosons.&quot;</span><span class="p">,</span> <span class="n">nbos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fragment </span><span class="si">%s</span><span class="s2"> Quasiboson histogram&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;------------------------------</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_name</span><span class="p">))</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">helper</span><span class="o">.</span><span class="n">make_horizontal_histogram</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">))</span>
        <span class="c1"># Calculate the relevant components of the zeroth moment- we don&#39;t want to recalculate these.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:</span><span class="n">nbos</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta0_ferm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rpa_mom</span><span class="p">,</span> <span class="n">rot_ov</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta0_coupling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">env_mom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span></div>


<div class="viewcode-block" id="EDMETFragment.construct_boson_hamil">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.construct_boson_hamil">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">construct_boson_hamil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eta0_bos</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given the zeroth moment coupling of our bosons to the remainder of the space, along with stored information,</span>
<span class="sd">        generate the components of our interacting electron-boson Hamiltonian.</span>
<span class="sd">        At the same time, calculate the local RPA correlation energy since this requires all the same information we</span>
<span class="sd">        already have to hand.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store_cluster_rpa</span><span class="p">(</span><span class="n">eta0_bos</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;qba&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_interaction</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">bosonic_exchange</span> <span class="o">=</span> <span class="s2">&quot;bos_ex&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_interaction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proj_hamil_qba</span><span class="p">(</span><span class="n">exchange_between_bos</span><span class="o">=</span><span class="n">bosonic_exchange</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_interaction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;xc&quot;</span><span class="p">:</span>
                <span class="n">couplings_aa</span><span class="p">,</span> <span class="n">couplings_bb</span><span class="p">,</span> <span class="n">a_bos</span><span class="p">,</span> <span class="n">b_bos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_wxc</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_interaction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;direct&quot;</span><span class="p">:</span>
                <span class="n">couplings_aa</span><span class="p">,</span> <span class="n">couplings_bb</span><span class="p">,</span> <span class="n">a_bos</span><span class="p">,</span> <span class="n">b_bos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_noxc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Unknown bosonic interaction kernel specified.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">a_bos</span> <span class="o">=</span> <span class="n">a_bos</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bos_freqs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">bogoliubov_decouple</span><span class="p">(</span><span class="n">a_bos</span> <span class="o">+</span> <span class="n">b_bos</span><span class="p">,</span> <span class="n">a_bos</span> <span class="o">-</span> <span class="n">b_bos</span><span class="p">)</span>
                <span class="n">couplings_aa</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,nm-&gt;mpq&quot;</span><span class="p">,</span> <span class="n">couplings_aa</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,nm-&gt;mqp&quot;</span><span class="p">,</span> <span class="n">couplings_aa</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">couplings_bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,nm-&gt;mpq&quot;</span><span class="p">,</span> <span class="n">couplings_bb</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,nm-&gt;mqp&quot;</span><span class="p">,</span> <span class="n">couplings_bb</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bos_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span> <span class="o">=</span> <span class="p">(</span><span class="n">couplings_aa</span><span class="p">,</span> <span class="n">couplings_bb</span><span class="p">)</span>

        <span class="c1"># Will also want to save the effective local modification resulting from our local construction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Local correlation energy for fragment </span><span class="si">%d</span><span class="s2">: </span><span class="si">%6.4e</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_erpa</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_erpa</span></div>


<div class="viewcode-block" id="EDMETFragment.store_cluster_rpa">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.store_cluster_rpa">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">store_cluster_rpa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eta0_bos</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function just stores all required information for the&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta0_bos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eta0_bos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">ov_rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rot_to_mf_ov</span><span class="p">()</span>
        <span class="c1"># Get couplings between all fermionic and boson degrees of freedom.</span>
        <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eri_couplings</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ov_rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># Depending upon the specifics of our construction we may need to deduct the contribution from this cluster</span>
        <span class="c1"># in the previous iteration to avoid double counting in future.</span>
        <span class="n">xc_apb</span><span class="p">,</span> <span class="n">xc_amb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xc_couplings</span><span class="p">(</span><span class="n">xc_kernel</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ov_rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">eps_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loc_eps</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ov_rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">apb</span> <span class="o">=</span> <span class="n">eps_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eris</span> <span class="o">+</span> <span class="n">xc_apb</span>

        <span class="c1"># This is the bare amb.</span>
        <span class="n">amb</span> <span class="o">=</span> <span class="n">eps_loc</span> <span class="o">+</span> <span class="n">xc_amb</span>
        <span class="n">eta0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">apb</span><span class="p">)</span>
        <span class="n">eta0</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta0_ferm</span>
        <span class="n">eta0</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta0_coupling</span>
        <span class="n">eta0</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span> <span class="p">:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta0_coupling</span><span class="o">.</span><span class="n">T</span>
        <span class="n">eta0</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta0_bos</span>

        <span class="c1"># Need to generate projector from our RPA excitation space to the local fragment degrees of freedom.</span>
        <span class="n">fproj_ov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_projector_ov</span><span class="p">()</span>
        <span class="c1"># loc_erpa = (einsum(&quot;pq,qr,rp-&gt;&quot;, fproj_ov, eta0[:self.ov_active_tot, :], apb[:, :self.ov_active_tot]) \</span>
        <span class="c1">#                - einsum(&quot;pq,qp-&gt;&quot;, fproj_ov, eps_loc[:self.ov_active_tot, :self.ov_active_tot]) \</span>
        <span class="c1">#                - einsum(&quot;pq,qp-&gt;&quot;, fproj_ov, eris[:self.ov_active_tot, :self.ov_active_tot])) / 2.0</span>
        <span class="n">xc_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">xc_apb</span> <span class="o">-</span> <span class="n">xc_amb</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc_erpa</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,qr,rp-&gt;&quot;</span><span class="p">,</span> <span class="n">fproj_ov</span><span class="p">,</span> <span class="n">eta0</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">],</span> <span class="p">(</span><span class="n">apb</span> <span class="o">-</span> <span class="p">(</span><span class="n">xc_b</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">])</span>
            <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,qp-&gt;&quot;</span><span class="p">,</span> <span class="n">fproj_ov</span><span class="p">,</span> <span class="p">((</span><span class="n">apb</span> <span class="o">+</span> <span class="n">amb</span> <span class="o">-</span> <span class="n">xc_b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">])</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># loc_erpa = (einsum(&quot;pq,qr,rp-&gt;&quot;, fproj_ov, eta0[:self.ov_active_tot], eris[:, :self.ov_active_tot])</span>
        <span class="c1">#            - einsum(&quot;pq,qp-&gt;&quot;, fproj_ov, eris[:self.ov_active_tot, :self.ov_active_tot])) / 4.0</span>

        <span class="n">renorm_amb</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">eta0</span><span class="p">,</span> <span class="n">apb</span><span class="p">,</span> <span class="n">eta0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amb_renorm_effect</span> <span class="o">=</span> <span class="n">renorm_amb</span> <span class="o">-</span> <span class="n">amb</span>

        <span class="n">maxdev</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">amb</span> <span class="o">-</span> <span class="n">renorm_amb</span><span class="p">)[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">maxdev</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Maximum deviation in irreducible polarisation propagator=</span><span class="si">%6.4e</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">amb</span> <span class="o">-</span> <span class="n">renorm_amb</span><span class="p">)[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="p">)</span>

        <span class="c1"># If have xc kernel from previous iteration want to deduct contribution from this cluster; otherwise bosons</span>
        <span class="c1"># will contain a double-counted representation of the already captured correlation in the cluster.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_noxc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_boson_hamil</span><span class="p">(</span><span class="n">apb</span> <span class="o">-</span> <span class="n">xc_apb</span><span class="p">,</span> <span class="n">renorm_amb</span> <span class="o">-</span> <span class="n">xc_amb</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_xc_contrib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dc_apb</span><span class="p">,</span> <span class="n">dc_amb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xc_couplings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_xc_contrib</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ov_rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">apb</span> <span class="o">-=</span> <span class="n">dc_apb</span>
            <span class="n">renorm_amb</span> <span class="o">-=</span> <span class="n">dc_amb</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_wxc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_boson_hamil</span><span class="p">(</span><span class="n">apb</span><span class="p">,</span> <span class="n">renorm_amb</span><span class="p">)</span>
        <span class="c1"># These are the quantities before decoupling, since these in some sense represent the `physical&#39; excitations of</span>
        <span class="c1"># the system. ie. each quasi-bosonic excitation operator is made up of only environmental excitations, rather</span>
        <span class="c1"># than also including deexcitations, making later manipulations more straightforward.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apb</span> <span class="o">=</span> <span class="n">apb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amb</span> <span class="o">=</span> <span class="n">renorm_amb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta0</span> <span class="o">=</span> <span class="n">eta0</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_boson_hamil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apb</span><span class="p">,</span> <span class="n">amb</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">apb</span> <span class="o">+</span> <span class="n">amb</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">apb</span> <span class="o">-</span> <span class="n">amb</span><span class="p">)</span>

        <span class="n">nactive_a</span> <span class="o">=</span> <span class="n">nactive_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">norb_active</span>

        <span class="n">couplings_aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,</span> <span class="n">nactive_a</span><span class="p">,</span> <span class="n">nactive_a</span><span class="p">))</span>
        <span class="n">couplings_bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,</span> <span class="n">nactive_b</span><span class="p">,</span> <span class="n">nactive_b</span><span class="p">))</span>

        <span class="n">couplings_aa</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span>
        <span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nvir_active</span><span class="p">)</span>
        <span class="n">couplings_aa</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span> <span class="p">:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">]</span>
            <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nvir_active</span><span class="p">)</span>
            <span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">couplings_bb</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span>
        <span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nvir_active</span><span class="p">)</span>
        <span class="n">couplings_bb</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span> <span class="p">:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span><span class="p">]</span>
            <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nvir_active</span><span class="p">)</span>
            <span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">a_bos</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:]</span>
        <span class="n">b_bos</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span> <span class="p">:]</span>

        <span class="k">return</span> <span class="n">couplings_aa</span><span class="p">,</span> <span class="n">couplings_bb</span><span class="p">,</span> <span class="n">a_bos</span><span class="p">,</span> <span class="n">b_bos</span>

<div class="viewcode-block" id="EDMETFragment.get_eri_couplings">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_eri_couplings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_eri_couplings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rot</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain eri in a space defined by an arbitrary rotation of the mean-field particle-hole excitations of our</span>
<span class="sd">        systems. Note that this should only really be used in the case that such a rotation cannot be described by a</span>
<span class="sd">        rotation of the underlying single-particle basis, since highly efficient routines already exist for this case..</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert rots from full-space particle-hole excitations into AO pairs.</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">conv_to_aos</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nvir</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nia,pi,qa-&gt;npq&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff_occ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff_vir</span><span class="p">)</span>

        <span class="n">rota</span><span class="p">,</span> <span class="n">rotb</span> <span class="o">=</span> <span class="n">rot</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span><span class="p">],</span> <span class="n">rot</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mf</span><span class="p">,</span> <span class="s2">&quot;with_df&quot;</span><span class="p">):</span>
            <span class="n">rota</span><span class="p">,</span> <span class="n">rotb</span> <span class="o">=</span> <span class="n">conv_to_aos</span><span class="p">(</span><span class="n">rota</span><span class="p">),</span> <span class="n">conv_to_aos</span><span class="p">(</span><span class="n">rotb</span><span class="p">)</span>
            <span class="c1"># Loop through cderis</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">eri1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">with_df</span><span class="o">.</span><span class="n">loop</span><span class="p">():</span>
                <span class="n">l_</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,lpq-&gt;nl&quot;</span><span class="p">,</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">eri1</span><span class="p">),</span> <span class="n">rota</span> <span class="o">+</span> <span class="n">rotb</span><span class="p">)</span>

                <span class="n">res</span> <span class="o">+=</span> <span class="n">dot</span><span class="p">(</span><span class="n">l_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">l_</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is painful to do for each fragment, but comes from working with 4-index eris.</span>
            <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_eris_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
            <span class="n">eris</span> <span class="o">=</span> <span class="n">eris</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span> <span class="p">:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">rota</span> <span class="o">+</span> <span class="n">rotb</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">rota</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">rotb</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>


<div class="viewcode-block" id="EDMETFragment.conv_to_aos">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.conv_to_aos">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">conv_to_aos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">rb</span><span class="p">):</span>
        <span class="c1"># Convert rots from full-space particle-hole excitations into AO pairs.</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">conv_to_aos</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nvir</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nia,pi,qa-&gt;npq&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff_occ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">mo_coeff_vir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conv_to_aos</span><span class="p">(</span><span class="n">ra</span><span class="p">),</span> <span class="n">conv_to_aos</span><span class="p">(</span><span class="n">rb</span><span class="p">)</span></div>


<div class="viewcode-block" id="EDMETFragment.get_xc_couplings">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_xc_couplings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_xc_couplings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">,</span> <span class="n">rot</span><span class="p">):</span>
        <span class="n">ov_mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ov_mf</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)):</span>
            <span class="n">ov_mf</span> <span class="o">=</span> <span class="p">(</span><span class="n">ov_mf</span><span class="p">,</span> <span class="n">ov_mf</span><span class="p">)</span>

        <span class="n">rota</span><span class="p">,</span> <span class="n">rotb</span> <span class="o">=</span> <span class="n">rot</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">ov_mf</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">rot</span><span class="p">[:,</span> <span class="n">ov_mf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ov_mf</span><span class="p">)]</span>

        <span class="n">rota</span><span class="p">,</span> <span class="n">rotb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_to_aos</span><span class="p">(</span><span class="n">rota</span><span class="p">,</span> <span class="n">rotb</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">with_df</span><span class="p">:</span>
            <span class="c1"># Store low-rank expression for xc kernel.</span>
            <span class="c1"># Store alpha and beta-spin xc-kernel contributions separately, so need to treat separately.</span>
            <span class="n">la_l</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,lpq-&gt;nl&quot;</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rota</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,lpq-&gt;nl&quot;</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rotb</span><span class="p">)</span>
            <span class="n">la_r</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,lpq-&gt;nl&quot;</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">rota</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,lpq-&gt;nl&quot;</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">rotb</span><span class="p">)</span>

            <span class="n">lb_l</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,lpq-&gt;nl&quot;</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rota</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,lpq-&gt;nl&quot;</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rotb</span><span class="p">)</span>
            <span class="n">lb_r</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,lqp-&gt;nl&quot;</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">rota</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,lqp-&gt;nl&quot;</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">rotb</span><span class="p">)</span>

            <span class="n">acontrib</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">la_l</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">la_r</span><span class="p">)</span>
            <span class="n">bcontrib</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">lb_l</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lb_r</span><span class="p">)</span>
            <span class="n">apb</span> <span class="o">=</span> <span class="n">acontrib</span> <span class="o">+</span> <span class="n">bcontrib</span>
            <span class="n">amb</span> <span class="o">=</span> <span class="n">acontrib</span> <span class="o">-</span> <span class="n">bcontrib</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Have full-rank expression for xc kernel, but separate spin channels.</span>
            <span class="n">acontrib</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lpq,pqrs,mrs-&gt;lm&quot;</span><span class="p">,</span> <span class="n">rota</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rotb</span><span class="p">)</span>
            <span class="n">acontrib</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">acontrib</span><span class="o">.</span><span class="n">T</span>
                <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lpq,pqrs,mrs-&gt;lm&quot;</span><span class="p">,</span> <span class="n">rota</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rota</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lpq,pqrs,mrs-&gt;lm&quot;</span><span class="p">,</span> <span class="n">rotb</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rotb</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">bcontrib</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lpq,pqrs,msr-&gt;lm&quot;</span><span class="p">,</span> <span class="n">rota</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rotb</span><span class="p">)</span>
            <span class="n">bcontrib</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">bcontrib</span><span class="o">.</span><span class="n">T</span>
                <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lpq,pqrs,msr-&gt;lm&quot;</span><span class="p">,</span> <span class="n">rota</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rota</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lpq,pqrs,msr-&gt;lm&quot;</span><span class="p">,</span> <span class="n">rotb</span><span class="p">,</span> <span class="n">xc_kernel</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rotb</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">apb</span> <span class="o">=</span> <span class="n">acontrib</span> <span class="o">+</span> <span class="n">bcontrib</span>
            <span class="n">amb</span> <span class="o">=</span> <span class="n">acontrib</span> <span class="o">-</span> <span class="n">bcontrib</span>
        <span class="k">return</span> <span class="n">apb</span><span class="p">,</span> <span class="n">amb</span></div>


<div class="viewcode-block" id="EDMETFragment.get_loc_eps">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_loc_eps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_loc_eps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">rot</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ln,n,mn-&gt;lm&quot;</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">rot</span><span class="p">)</span></div>


<div class="viewcode-block" id="EDMETFragment.proj_hamil_qba">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.proj_hamil_qba">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">proj_hamil_qba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_between_bos</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate quasi-bosonic Hamiltonian via projection of appropriate Hamiltonian elements of full system.</span>
<span class="sd">        This represents the bosons as an explicit sum of environmental excitations, which we then approximate as bosonic</span>
<span class="sd">         degrees of freedom.&quot;&quot;&quot;</span>

        <span class="c1"># Note that electron-boson couplings set here describe a Hamiltonian with terms:</span>
        <span class="c1">#       V[n,p,q] p^+ q b_n^+ + h.c.</span>
        <span class="c1"># This is arbitrary (and indeed different solvers have different definitions) but this is definitely the one</span>
        <span class="c1"># used here for all future reference (after much checking...).</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">ca</span> <span class="o">=</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ca</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">c</span>
        <span class="c1"># indexed as npq in atomic orbitals, but p is a projection of the occupied indices and q virtual indices.</span>
        <span class="n">r_bos_aoa</span><span class="p">,</span> <span class="n">r_bos_aob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos_ao</span>
        <span class="c1"># Note that our o-v fock matrix blocks may be nonzero, however our environmental states are always constructed</span>
        <span class="c1"># from only particle-hole excitations.</span>
        <span class="c1"># If no correlation potential was used this can be calculated by eps.</span>
        <span class="n">fa</span><span class="p">,</span> <span class="n">fb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fock</span><span class="p">()</span>

        <span class="n">coa</span><span class="p">,</span> <span class="n">cob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_co_active</span><span class="p">()</span>
        <span class="n">cva</span><span class="p">,</span> <span class="n">cvb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cv_active</span><span class="p">()</span>

        <span class="n">noa</span><span class="p">,</span> <span class="n">nva</span> <span class="o">=</span> <span class="n">coa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cva</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nob</span><span class="p">,</span> <span class="n">nvb</span> <span class="o">=</span> <span class="n">cob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cvb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ovlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>
        <span class="n">t_fock_start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="c1"># Can just use expressions for Hamiltonian elements between single excitations.</span>
        <span class="c1"># First, get fock contributions. All are N^3 or less.</span>
        <span class="c1"># This will be zero if at HF solution.</span>
        <span class="c1"># V_n &lt;= C_{nia}f_{ia}</span>
        <span class="n">bos_nonconserv</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,pq-&gt;n&quot;</span><span class="p">,</span> <span class="n">r_bos_aoa</span><span class="p">,</span> <span class="n">fa</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,pq-&gt;n&quot;</span><span class="p">,</span> <span class="n">r_bos_aob</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
        <span class="c1"># \Omega_n &lt;= C_{mia}C_{nib}f_{ab} - C_{mia}C_{nja}f_{ij}</span>
        <span class="n">a_bos</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,msr,qr,ps-&gt;nm&quot;</span><span class="p">,</span> <span class="n">r_bos_aoa</span><span class="p">,</span> <span class="n">r_bos_aoa</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span>
            <span class="s2">&quot;npq,msr,qr,ps-&gt;nm&quot;</span><span class="p">,</span> <span class="n">r_bos_aob</span><span class="p">,</span> <span class="n">r_bos_aob</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">ovlp</span>
        <span class="p">)</span>
        <span class="n">a_bos</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npq,mrs,pr,qs-&gt;nm&quot;</span><span class="p">,</span> <span class="n">r_bos_aoa</span><span class="p">,</span> <span class="n">r_bos_aoa</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">ovlp</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span>
            <span class="s2">&quot;npq,mrs,pr,qs-&gt;nm&quot;</span><span class="p">,</span> <span class="n">r_bos_aob</span><span class="p">,</span> <span class="n">r_bos_aob</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">ovlp</span>
        <span class="p">)</span>

        <span class="c1"># Write this as a single function for both spin channels, to avoid chance of typos</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_fock_couplings_spin_channel</span><span class="p">(</span><span class="n">r_bos_ao</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">nv</span><span class="p">):</span>
            <span class="n">couplings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="n">nv</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># No o-&gt;v excitation fock contribution.</span>
            <span class="c1"># v-&gt;o excitation within active space.</span>
            <span class="c1"># V_{nai} &lt;= C_{nic}f_{ac} - C_{nka}f_{ik}</span>
            <span class="n">couplings</span><span class="p">[:,</span> <span class="n">no</span><span class="p">:,</span> <span class="p">:</span><span class="n">no</span><span class="p">]</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npc,qc,pi,qa-&gt;nai&quot;</span><span class="p">,</span> <span class="n">r_bos_ao</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">ovlp</span><span class="p">,</span> <span class="n">co</span><span class="p">),</span> <span class="n">cv</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span>
                <span class="s2">&quot;nkq,pk,pi,qa-&gt;nai&quot;</span><span class="p">,</span> <span class="n">r_bos_ao</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">ovlp</span><span class="p">,</span> <span class="n">cv</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># o-&gt;o excitation within active space. Note that we&#39;re constructing the non-normal ordered parameterisation</span>
            <span class="c1"># here, so all signs are flipped for o-o component.</span>
            <span class="c1"># V_{nij} &lt;= -(\delta_{ij}C_{nkc}f_{ck} - C_{njc}f_{ic})</span>
            <span class="n">fac</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nck,ck-&gt;n&quot;</span><span class="p">,</span> <span class="n">r_bos_ao</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">couplings</span><span class="p">[:,</span> <span class="p">:</span><span class="n">no</span><span class="p">,</span> <span class="p">:</span><span class="n">no</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,n-&gt;npq&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">no</span><span class="p">),</span> <span class="n">fac</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span>
                <span class="s2">&quot;npc,qc,qi,pj-&gt;nij&quot;</span><span class="p">,</span> <span class="n">r_bos_ao</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">ovlp</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># v-&gt;v excitation within active space.</span>
            <span class="c1"># V_{nab} &lt;= C_{nic}f_{ac} C_{nka}f_{ik}</span>
            <span class="n">couplings</span><span class="p">[:,</span> <span class="n">no</span><span class="p">:,</span> <span class="n">no</span><span class="p">:]</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,n-&gt;npq&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nv</span><span class="p">),</span> <span class="n">fac</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span>
                <span class="s2">&quot;nkp,kq,pa,qb-&gt;nab&quot;</span><span class="p">,</span> <span class="n">r_bos_ao</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">ovlp</span><span class="p">,</span> <span class="n">cv</span><span class="p">),</span> <span class="n">cv</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">couplings</span>

        <span class="n">fcouplings_aa</span> <span class="o">=</span> <span class="n">get_fock_couplings_spin_channel</span><span class="p">(</span><span class="n">r_bos_aoa</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">cva</span><span class="p">,</span> <span class="n">noa</span><span class="p">,</span> <span class="n">nva</span><span class="p">)</span>
        <span class="n">fcouplings_bb</span> <span class="o">=</span> <span class="n">get_fock_couplings_spin_channel</span><span class="p">(</span><span class="n">r_bos_aob</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">cob</span><span class="p">,</span> <span class="n">cvb</span><span class="p">,</span> <span class="n">nob</span><span class="p">,</span> <span class="n">nvb</span><span class="p">)</span>

        <span class="n">t_fock</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_fock_start</span>

        <span class="c1"># Get coulombic contribution; for coupling this is just V_{npq} &lt;= C_{nkc}&lt;pk||qc&gt;.</span>
        <span class="n">ccouplings_aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fcouplings_aa</span><span class="p">)</span>
        <span class="n">ccouplings_bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fcouplings_bb</span><span class="p">)</span>

        <span class="n">t_coulomb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">exchange_between_bos</span><span class="p">:</span>
            <span class="n">t_bos_exchange</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">with_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exchange_between_bos</span><span class="p">:</span>
                <span class="n">blk_prefactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbos</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blk_prefactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span>
            <span class="c1"># Limit ourselves to only use quarter the maximum memory for the single largest array.</span>
            <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">__config__</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">blk_prefactor</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">blksize</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">with_df</span><span class="o">.</span><span class="n">get_naoaux</span><span class="p">():</span>
                <span class="n">blksize</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using blksize of </span><span class="si">%d</span><span class="s2"> to generate Bosonic Hamiltonian.&quot;</span><span class="p">,</span> <span class="n">blksize</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">eri1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">with_df</span><span class="o">.</span><span class="n">loop</span><span class="p">(</span><span class="n">blksize</span><span class="p">):</span>
                <span class="c1"># Here we&#39;ve kept the old einsum expressions around just in case we need comparison later.</span>
                <span class="n">l_</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">eri1</span><span class="p">)</span>
                <span class="n">t_coulomb_start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                <span class="c1"># First generate coulomb interactions effects. This all scales as N^3.</span>
                <span class="c1"># l_bos = einsum(&quot;npq,mpq-&gt;nm&quot;, l_, r_bos_aoa + r_bos_aob)  # N^3</span>
                <span class="c1"># la_ferm = einsum(&quot;npq,pi,qj-&gt;nij&quot;, l_, ca, ca)  # N^3</span>
                <span class="c1"># lb_ferm = einsum(&quot;npq,pi,qj-&gt;nij&quot;, l_, cb, cb)  # N^3</span>

                <span class="n">l_bos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_</span><span class="p">,</span> <span class="n">r_bos_aoa</span> <span class="o">+</span> <span class="n">r_bos_aob</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
                <span class="n">la_ferm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">ca</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">lb_ferm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">cb</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                <span class="c1"># print(&quot;!!1!!&quot;,</span>
                <span class="c1">#    abs(einsum(&quot;npq,mpq-&gt;nm&quot;, l_, r_bos_aoa + r_bos_aob) - l_bos).max(),</span>
                <span class="c1">#    abs(einsum(&quot;npq,pi,qj-&gt;nij&quot;, l_, ca, ca) - la_ferm).max(),</span>
                <span class="c1">#    abs(einsum(&quot;npq,pi,qj-&gt;nij&quot;, l_, cb, cb) - lb_ferm).max()</span>
                <span class="c1"># )</span>

                <span class="c1"># V_{npq} &lt;= (pq|ia)C_{nia} = &lt;pi|qa&gt;C_{nia}</span>
                <span class="c1"># ccouplings_aa += einsum(&quot;nm,nij-&gt;mij&quot;, l_bos, la_ferm)  # N^3</span>
                <span class="c1"># ccouplings_bb += einsum(&quot;nm,nij-&gt;mij&quot;, l_bos, lb_ferm)  # N^3</span>
                <span class="n">ccouplings_aa</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_bos</span><span class="p">,</span> <span class="n">la_ferm</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">ccouplings_bb</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_bos</span><span class="p">,</span> <span class="n">lb_ferm</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                <span class="c1"># print(&quot;!!2!!&quot;,</span>
                <span class="c1">#      abs(einsum(&quot;nm,nij-&gt;mij&quot;, l_bos, la_ferm) - np.tensordot(l_bos, la_ferm, ([0], [0]))).max(),</span>
                <span class="c1">#      abs( einsum(&quot;nm,nij-&gt;mij&quot;, l_bos, lb_ferm) - np.tensordot(l_bos, lb_ferm, ([0], [0]))).max()</span>
                <span class="c1">#      )</span>

                <span class="k">del</span> <span class="n">la_ferm</span><span class="p">,</span> <span class="n">lb_ferm</span>
                <span class="c1"># \Omega_n &lt;= (ia|bj)C_{nia}C_{mjb} = &lt;ib|aj&gt;C_{nia}C_{mjb}</span>
                <span class="c1"># a_bos += einsum(&quot;nm,no-&gt;mo&quot;, l_bos, l_bos)  # N</span>
                <span class="n">a_bos</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_bos</span><span class="p">,</span> <span class="n">l_bos</span><span class="p">,</span> <span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">del</span> <span class="n">l_bos</span>
                <span class="c1"># Now exchange contributions; those to the coupling are straightforward (N^3) to calculate.</span>
                <span class="c1"># la_singl = einsum(&quot;npq,pi-&gt;niq&quot;, l_, ca)  # N^3</span>
                <span class="c1"># lb_singl = einsum(&quot;npq,pi-&gt;niq&quot;, l_, cb)  # N^3</span>
                <span class="n">la_singl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># N^3</span>
                <span class="n">lb_singl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># N^3</span>
                <span class="c1"># print(&quot;!!3!!&quot;,</span>
                <span class="c1">#      abs(einsum(&quot;npq,pi-&gt;niq&quot;, l_, ca) - la_singl).max(),</span>
                <span class="c1">#      abs(einsum(&quot;npq,pi-&gt;niq&quot;, l_, cb) - lb_singl).max())</span>
                <span class="c1"># V_{npq} &lt;= -(pa|iq)C_{nia} = -&lt;pi|aq&gt;C_{nia}</span>
                <span class="c1"># ccouplings_aa -= einsum(&quot;nip,njq,mpq-&gt;mji&quot;, la_singl, la_singl, r_bos_aoa)  # N^3</span>
                <span class="c1"># ccouplings_bb -= einsum(&quot;nip,njq,mpq-&gt;mji&quot;, lb_singl, lb_singl, r_bos_aob)  # N^3</span>

                <span class="n">ccouplings_aa</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span>
                    <span class="n">la_singl</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">la_singl</span><span class="p">,</span> <span class="n">r_bos_aoa</span><span class="p">,</span> <span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>  <span class="c1"># njq,mpq-&gt;njmp</span>
                <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>  <span class="c1"># nip,njmp-&gt;ijm-&gt;mji</span>

                <span class="n">ccouplings_bb</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span>
                    <span class="n">lb_singl</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">lb_singl</span><span class="p">,</span> <span class="n">r_bos_aob</span><span class="p">,</span> <span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>  <span class="c1"># njq,mpq-&gt;njmp</span>
                <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>  <span class="c1"># nip,njmp-&gt;ijm-&gt;mji</span>

                <span class="c1"># print(&quot;!!4!!&quot;,</span>
                <span class="c1">#      abs(einsum(&quot;nip,njq,mpq-&gt;mji&quot;, la_singl, la_singl, r_bos_aoa) - np.tensordot(</span>
                <span class="c1">#    la_singl,</span>
                <span class="c1">#    np.tensordot(la_singl, r_bos_aoa, ([2], [2])),  # njq,mpq-&gt;njmp</span>
                <span class="c1">#    ([0, 2], [0, 3])</span>
                <span class="c1"># ).transpose([2, 1, 0])).max(),</span>
                <span class="c1">#      abs(einsum(&quot;nip,njq,mpq-&gt;mji&quot;, lb_singl, lb_singl, r_bos_aob) - np.tensordot(</span>
                <span class="c1">#    lb_singl,</span>
                <span class="c1">#    np.tensordot(lb_singl, r_bos_aob, ([2], [2])),  # njq,mpq-&gt;njmp</span>
                <span class="c1">#    ([0, 2], [0, 3])</span>
                <span class="c1"># ).transpose([2, 1, 0])).max()</span>
                <span class="c1">#      )</span>

                <span class="n">t_coulomb</span> <span class="o">+=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_coulomb_start</span>
                <span class="k">del</span> <span class="n">la_singl</span><span class="p">,</span> <span class="n">lb_singl</span>
                <span class="k">if</span> <span class="n">exchange_between_bos</span><span class="p">:</span>
                    <span class="n">t_bosex_start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="c1"># boson-boson interactions are N^4, so if have O(N) clusters this would push our scaling to N^5...</span>
                    <span class="c1"># Note we want both `occupied` indices of bosonic degrees of freedom to contract to same l, and the</span>
                    <span class="c1"># same for both `virtual` indices.</span>
                    <span class="c1"># Only same-spin so need to do different channels separately.</span>
                    <span class="c1"># \Omega_n &lt;= (ab|ji)C_{nia}C_{mjb} = &lt;aj|bi&gt;C_{nia}C_{mjb}</span>
                    <span class="c1"># a_bos -= einsum(&quot;nqrm,nrql-&gt;ml&quot;,</span>
                    <span class="c1">#                einsum(&quot;npq,mpr-&gt;nqrm&quot;, l_, r_bos_aoa),</span>
                    <span class="c1">#                einsum(&quot;npq,lrq-&gt;nprl&quot;, l_, r_bos_aoa))</span>
                    <span class="c1"># a_bos -= einsum(&quot;nqrm,nrql-&gt;ml&quot;,</span>
                    <span class="c1">#                einsum(&quot;npq,mpr-&gt;nqrm&quot;, l_, r_bos_aob),</span>
                    <span class="c1">#                einsum(&quot;npq,lrq-&gt;nprl&quot;, l_, r_bos_aob))</span>

                    <span class="n">a_bos</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_</span><span class="p">,</span> <span class="n">r_bos_aoa</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])),</span>  <span class="c1"># npq,mpr-&gt;nqmr</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_</span><span class="p">,</span> <span class="n">r_bos_aoa</span><span class="p">,</span> <span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])),</span>  <span class="c1"># npq,mrq-&gt;npmr</span>
                        <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                    <span class="p">)</span>  <span class="c1"># nqmr,nrlq-&gt;ml</span>
                    <span class="n">a_bos</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_</span><span class="p">,</span> <span class="n">r_bos_aob</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])),</span>  <span class="c1"># npq,mpr-&gt;nqmr</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">l_</span><span class="p">,</span> <span class="n">r_bos_aob</span><span class="p">,</span> <span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])),</span>  <span class="c1"># npq,mrq-&gt;npmr</span>
                        <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                    <span class="p">)</span>  <span class="c1"># nqmr,nrlq-&gt;ml</span>

                    <span class="n">t_bos_exchange</span> <span class="o">+=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_bosex_start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Explicit QBA Hamiltonian construction is currently only implemented for use with&quot;</span> <span class="s2">&quot;density fitting.&quot;</span>
            <span class="p">)</span>

        <span class="n">couplings_aa</span> <span class="o">=</span> <span class="n">fcouplings_aa</span> <span class="o">+</span> <span class="n">ccouplings_aa</span>
        <span class="n">couplings_bb</span> <span class="o">=</span> <span class="n">fcouplings_bb</span> <span class="o">+</span> <span class="n">ccouplings_bb</span>

        <span class="n">nelec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nelec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">nelec</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nelec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nelec</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npp-&gt;n&quot;</span><span class="p">,</span> <span class="n">couplings_aa</span><span class="p">[:,</span> <span class="p">:</span><span class="n">noa</span><span class="p">,</span> <span class="p">:</span><span class="n">noa</span><span class="p">])</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;npp-&gt;n&quot;</span><span class="p">,</span> <span class="n">couplings_bb</span><span class="p">[:,</span> <span class="p">:</span><span class="n">nob</span><span class="p">,</span> <span class="p">:</span><span class="n">nob</span><span class="p">])</span>

        <span class="n">bos_nonconserv</span> <span class="o">+=</span> <span class="n">shift</span>

        <span class="n">couplings_aa</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,pq-&gt;npq&quot;</span><span class="p">,</span> <span class="n">bos_nonconserv</span> <span class="o">/</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">noa</span> <span class="o">+</span> <span class="n">nva</span><span class="p">))</span>
        <span class="n">couplings_bb</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,pq-&gt;npq&quot;</span><span class="p">,</span> <span class="n">bos_nonconserv</span> <span class="o">/</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nob</span> <span class="o">+</span> <span class="n">nvb</span><span class="p">))</span>

        <span class="c1"># Decouple bosons here.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bos_freqs</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">a_bos</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span> <span class="o">=</span> <span class="p">(</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nm,npq-&gt;mqp&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">couplings_aa</span><span class="p">),</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nm,npq-&gt;mqp&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">couplings_bb</span><span class="p">))</span>
        <span class="c1"># ccouplings[n,p,q] = &lt;pi||qa&gt;C_{nia}; can use this for energy evaluation later.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_couplings</span> <span class="o">=</span> <span class="p">(</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nm,npq-&gt;mqp&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ccouplings_aa</span><span class="p">),</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nm,npq-&gt;mqp&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ccouplings_bb</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Time for Bosonic Hamiltonian Projection into fragment </span><span class="si">%d</span><span class="s2">:  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">time_string</span><span class="p">(</span><span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">exchange_between_bos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;         </span><span class="si">%s</span><span class="s2"> for fock components, </span><span class="si">%s</span><span class="s2"> for N^3 scaling coulombic components and </span><span class="si">%s</span><span class="s2"> for N^4 &quot;</span>
                <span class="s2">&quot;bosonic exchange.&quot;</span><span class="p">,</span>
                <span class="n">time_string</span><span class="p">(</span><span class="n">t_fock</span><span class="p">),</span>
                <span class="n">time_string</span><span class="p">(</span><span class="n">t_coulomb</span><span class="p">),</span>
                <span class="n">time_string</span><span class="p">(</span><span class="n">t_bos_exchange</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;         </span><span class="si">%s</span><span class="s2"> for fock components, and </span><span class="si">%s</span><span class="s2"> for N^3 scaling coulombic components.&quot;</span><span class="p">,</span>
                <span class="n">time_string</span><span class="p">(</span><span class="n">t_fock</span><span class="p">),</span>
                <span class="n">time_string</span><span class="p">(</span><span class="n">t_coulomb</span><span class="p">),</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="EDMETFragment.check_qba_approx">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.check_qba_approx">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_qba_approx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdm1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given boson and cluster coefficient definitions, checks deviation from exact bosonic commutation relations</span>
<span class="sd">        within our cluster projected onto the ground state.</span>
<span class="sd">        This will hopefully tell us whether our bosons are likely to be a good approximation to the full system.</span>
<span class="sd">        We could take the L2 norm of the overall deviation, but given most of the resultant operators have essentially</span>
<span class="sd">        negligible expectation values with the ground state this is an unnecessarily pessimistic</span>
<span class="sd">        estimator.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">r_bos_a</span><span class="p">,</span> <span class="n">r_bos_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rbos_split</span><span class="p">()</span>
        <span class="n">r_o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[occ]|cluster[occ]&quot;</span><span class="p">)</span>
        <span class="n">r_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[vir]|cluster[vir]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">is_uhf</span><span class="p">:</span>
            <span class="n">r_o</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_o</span><span class="p">,</span> <span class="n">r_o</span><span class="p">)</span>
            <span class="n">r_v</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_v</span><span class="p">,</span> <span class="n">r_v</span><span class="p">)</span>
            <span class="n">rdm1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdm1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rdm1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Contributions to commutator [b_n, b_m^+]</span>
        <span class="n">odev_a</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nia,mja,ik,jl-&gt;nmkl&quot;</span><span class="p">,</span> <span class="n">r_bos_a</span><span class="p">,</span> <span class="n">r_bos_a</span><span class="p">,</span> <span class="n">r_o</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r_o</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">odev_b</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nia,mja,ik,jl-&gt;nmkl&quot;</span><span class="p">,</span> <span class="n">r_bos_b</span><span class="p">,</span> <span class="n">r_bos_b</span><span class="p">,</span> <span class="n">r_o</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_o</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">vdev_a</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nia,mib,ac,bd-&gt;nmcd&quot;</span><span class="p">,</span> <span class="n">r_bos_a</span><span class="p">,</span> <span class="n">r_bos_a</span><span class="p">,</span> <span class="n">r_v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r_v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vdev_b</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nia,mib,ac,bd-&gt;nmcd&quot;</span><span class="p">,</span> <span class="n">r_bos_b</span><span class="p">,</span> <span class="n">r_bos_b</span><span class="p">,</span> <span class="n">r_v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">no_a</span><span class="p">,</span> <span class="n">no_b</span> <span class="o">=</span> <span class="n">r_o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nmij,ij-&gt;nm&quot;</span><span class="p">,</span> <span class="n">odev_a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">no_a</span><span class="p">)</span> <span class="o">-</span> <span class="n">rdm1</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="n">no_a</span><span class="p">,</span> <span class="p">:</span><span class="n">no_a</span><span class="p">])</span>
            <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nmij,ij-&gt;nm&quot;</span><span class="p">,</span> <span class="n">odev_b</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">no_b</span><span class="p">)</span> <span class="o">-</span> <span class="n">rdm1</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="n">no_b</span><span class="p">,</span> <span class="p">:</span><span class="n">no_b</span><span class="p">])</span>
            <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nmab,ab-&gt;nm&quot;</span><span class="p">,</span> <span class="n">vdev_a</span><span class="p">,</span> <span class="n">rdm1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">no_a</span><span class="p">:,</span> <span class="n">no_a</span><span class="p">:])</span>
            <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nmab,ab-&gt;nm&quot;</span><span class="p">,</span> <span class="n">vdev_b</span><span class="p">,</span> <span class="n">rdm1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">no_b</span><span class="p">:,</span> <span class="n">no_b</span><span class="p">:])</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Maximum neglected local density fluctuation in quasi-boson commutation=</span><span class="si">%6.4e</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span></div>


<div class="viewcode-block" id="EDMETFragment.get_rbos_split">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_rbos_split">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_rbos_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r_bos_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span><span class="p">]</span>
        <span class="n">r_bos_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_mf</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">r_bos_a</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nvir</span><span class="p">)),</span> <span class="n">r_bos_b</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nocc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">nvir</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EDMETFragment.kernel">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.kernel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">construct_bath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chempot</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solve the fragment with the specified solver and chemical potential.&quot;&quot;&quot;</span>
        <span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span>

        <span class="c1"># Create solver object</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">cluster_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
        <span class="c1"># Chemical potential</span>
        <span class="k">if</span> <span class="n">chempot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_projector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">v_ext</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">chempot</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">chempot</span> <span class="o">*</span> <span class="n">px</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cluster_solver</span><span class="o">.</span><span class="n">v_ext</span> <span class="o">=</span> <span class="o">-</span><span class="n">chempot</span> <span class="o">*</span> <span class="n">px</span>

        <span class="k">with</span> <span class="n">log_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Time for </span><span class="si">%s</span><span class="s2"> solver:&quot;</span> <span class="o">%</span> <span class="n">solver</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">cluster_solver</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>

        <span class="n">wf</span> <span class="o">=</span> <span class="n">cluster_solver</span><span class="o">.</span><span class="n">wf</span>

        <span class="n">dm1</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>
        <span class="n">dm2</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">make_rdm2</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_qba_approx</span><span class="p">(</span><span class="n">dm1</span><span class="p">)</span>
        <span class="n">dm_eb</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">make_rdm_eb</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="p">(</span>
            <span class="n">fid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">n_active</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">norb_active</span><span class="p">,</span> <span class="n">converged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wf</span><span class="o">=</span><span class="n">wf</span><span class="p">,</span> <span class="n">dm1</span><span class="o">=</span><span class="n">dm1</span><span class="p">,</span> <span class="n">dm2</span><span class="o">=</span><span class="n">dm2</span><span class="p">,</span> <span class="n">dm_eb</span><span class="o">=</span><span class="n">dm_eb</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">e1</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">e2</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">e_fb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edmet_energy_contrib</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">make_dd_moments</span><span class="p">:</span>
            <span class="n">r_o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;cluster[occ]|frag&quot;</span><span class="p">)</span>
            <span class="n">r_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;cluster[vir]|frag&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r_o</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r_o</span><span class="p">,</span> <span class="n">r_v</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">r_o</span><span class="p">,</span> <span class="n">r_v</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">ddmoms</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">make_dd_moms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">coeffs</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">old_sc_condition</span><span class="p">:</span>
                <span class="n">ddmoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ppqq-&gt;pq&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ddmoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">ddmoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ppqq-&gt;pq&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ddmoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">results</span><span class="o">.</span><span class="n">dd_mom0</span> <span class="o">=</span> <span class="n">ddmoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">results</span><span class="o">.</span><span class="n">dd_mom1</span> <span class="o">=</span> <span class="n">ddmoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="EDMETFragment.get_solver_options">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_solver_options">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_solver_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="n">solver_opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">solver_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">solver_options</span><span class="p">)</span>
        <span class="n">pass_through</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">pass_through</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Passing fragment option </span><span class="si">%s</span><span class="s2"> to solver.&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">solver_opts</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">solver_opts</span></div>


<div class="viewcode-block" id="EDMETFragment.get_edmet_energy_contrib">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_edmet_energy_contrib">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_edmet_energy_contrib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hamil</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate EDMET energy contribution, according to expression given in appendix of EDMET preprint&quot;&quot;&quot;</span>
        <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dmet_energy_contrib</span><span class="p">(</span><span class="n">hamil</span><span class="p">)</span>
        <span class="n">c_act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active</span>
        <span class="n">p_imp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_projector</span><span class="p">(</span><span class="n">c_act</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_imp</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">p_imp</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_imp</span><span class="p">,</span> <span class="n">p_imp</span><span class="p">)</span>
        <span class="n">dm_eb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">dm_eb</span>
        <span class="n">couplings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_couplings</span>

        <span class="c1"># Have separate spin contributions.</span>
        <span class="k">if</span> <span class="s2">&quot;qba&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">bosonic_interaction</span><span class="p">:</span>
            <span class="c1"># Already have exchange effects included in interactions, so can use straightforward contraction.</span>
            <span class="c1"># dm_eb -&gt; &lt;0|b^+ p^+ q|0&gt; in P[p,q,b].</span>
            <span class="c1"># couplings -&gt; &lt;pi||qa&gt;C_{nia} in couplings[n,p,q].</span>
            <span class="c1"># Want &lt;pj||qb&gt;C_{njb} ( &lt;b_n^+ q^+ p&gt; - &lt;b_n q^+ p&gt;) so our energy is:</span>
            <span class="n">efb</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;qr,npq,rpn&quot;</span><span class="p">,</span> <span class="n">p_imp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">couplings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dm_eb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dm_eb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;qr,npq,rpn&quot;</span><span class="p">,</span> <span class="n">p_imp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">couplings</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dm_eb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dm_eb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">efb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">efb</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pr,npq,rqn&quot;</span><span class="p">,</span> <span class="n">p_imp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">couplings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dm_eb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;qr,npq,prn&quot;</span><span class="p">,</span> <span class="n">p_imp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">couplings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dm_eb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pr,npq,rqn&quot;</span><span class="p">,</span> <span class="n">p_imp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">couplings</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dm_eb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;qr,npq,prn&quot;</span><span class="p">,</span> <span class="n">p_imp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">couplings</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dm_eb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">efb</span></div>


    <span class="c1"># From this point on have functionality to perform self-consistency.</span>

<div class="viewcode-block" id="EDMETFragment.construct_correlation_kernel_contrib">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.construct_correlation_kernel_contrib">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">construct_correlation_kernel_contrib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">m0_new</span><span class="p">,</span> <span class="n">m1_new</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">svdtol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the contribution to the correlation kernel arising from this fragment, in terms of local degrees of</span>
<span class="sd">        freedom (ie cluster orbitals and bosons).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">new_amb</span><span class="p">,</span> <span class="n">new_apb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_composite_moments</span><span class="p">(</span><span class="n">m0_new</span><span class="p">,</span> <span class="n">m1_new</span><span class="p">)</span>

        <span class="n">r_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[occ]|cluster[occ]&quot;</span><span class="p">)</span>
        <span class="n">r_vir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;mo[vir]|cluster[vir]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r_occ</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">r_occ</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_occ</span><span class="p">,</span> <span class="n">r_occ</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r_vir</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">r_vir</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_vir</span><span class="p">,</span> <span class="n">r_vir</span><span class="p">)</span>
        <span class="n">ov_a</span><span class="p">,</span> <span class="n">ov_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_ab</span>
        <span class="n">no_a</span><span class="p">,</span> <span class="n">no_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc_ab</span>
        <span class="n">nv_a</span><span class="p">,</span> <span class="n">nv_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvir_ab</span>
        <span class="n">ncl_a</span><span class="p">,</span> <span class="n">ncl_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nclus_ab</span>
        <span class="c1"># We want to actually consider the difference from the dRPA kernel.</span>
        <span class="c1"># Get irreducible polarisation propagator.</span>
        <span class="n">ov_rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rot_to_mf_ov</span><span class="p">()</span>
        <span class="n">eps_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loc_eps</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ov_rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># Get eri couplings between all fermionic and boson degrees of freedom.</span>
        <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eri_couplings</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ov_rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># Calculate just xc contribution.</span>
        <span class="c1"># For A+B need to deduct dRPA contribution.</span>
        <span class="n">new_xc_apb</span> <span class="o">=</span> <span class="n">new_apb</span> <span class="o">-</span> <span class="n">eps_loc</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eris</span>
        <span class="c1"># For A-B need to deduct effective dRPA contribution and the renormalisation of interactions introduced in</span>
        <span class="c1"># cluster construction.</span>
        <span class="n">new_xc_amb</span> <span class="o">=</span> <span class="n">new_amb</span> <span class="o">-</span> <span class="n">eps_loc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_renorm_effect</span>

        <span class="n">new_xc_a</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">new_xc_apb</span> <span class="o">+</span> <span class="n">new_xc_amb</span><span class="p">)</span>
        <span class="n">new_xc_b</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">new_xc_apb</span> <span class="o">-</span> <span class="n">new_xc_amb</span><span class="p">)</span>
        <span class="c1"># Now just need to convert to ensure proper symmetries of couplings are imposed, and project each index in turn</span>
        <span class="c1"># into the fragment space.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">occ_proj_kernel</span><span class="p">:</span>
            <span class="n">fr_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_projector_ov</span><span class="p">(</span><span class="n">proj</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">inc_bosons</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Need to divide my the number of projectors actually applied; here it&#39;s just two.</span>
            <span class="n">fac</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fr_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_projector_ov</span><span class="p">(</span><span class="n">proj</span><span class="o">=</span><span class="s2">&quot;ov&quot;</span><span class="p">,</span> <span class="n">inc_bosons</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Have sum of occupied and virtual projectors, so four total.</span>
            <span class="n">fac</span> <span class="o">=</span> <span class="mf">4.0</span>

        <span class="n">new_xc_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">fr_proj</span><span class="p">,</span> <span class="n">new_xc_a</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">new_xc_a</span><span class="p">,</span> <span class="n">fr_proj</span><span class="p">))</span> <span class="o">/</span> <span class="n">fac</span>
        <span class="n">new_xc_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">fr_proj</span><span class="p">,</span> <span class="n">new_xc_b</span><span class="p">)</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">new_xc_b</span><span class="p">,</span> <span class="n">fr_proj</span><span class="p">))</span> <span class="o">/</span> <span class="n">fac</span>

        <span class="c1"># Now need to combine A and B contributions, taking care of bosonic contributions.</span>
        <span class="c1"># Note that we currently won&#39;t have any boson-boson contributions, and all contributions are</span>
        <span class="c1"># symmetric.</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_fermionic_spat_contrib</span><span class="p">(</span><span class="n">acon</span><span class="p">,</span> <span class="n">bcon</span><span class="p">,</span> <span class="n">no_l</span><span class="p">,</span> <span class="n">nv_l</span><span class="p">,</span> <span class="n">no_r</span><span class="p">,</span> <span class="n">nv_r</span><span class="p">):</span>
            <span class="n">f_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">no_l</span><span class="p">,</span> <span class="n">nv_l</span><span class="p">,</span> <span class="n">no_r</span><span class="p">,</span> <span class="n">nv_r</span><span class="p">)</span>
            <span class="n">fermionic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no_l</span> <span class="o">+</span> <span class="n">nv_l</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">no_r</span> <span class="o">+</span> <span class="n">nv_r</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">fermionic</span><span class="p">[:</span><span class="n">no_l</span><span class="p">,</span> <span class="n">no_l</span><span class="p">:,</span> <span class="p">:</span><span class="n">no_r</span><span class="p">,</span> <span class="n">no_r</span><span class="p">:]</span> <span class="o">=</span> <span class="n">acon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">f_shape</span><span class="p">)</span>
            <span class="n">fermionic</span><span class="p">[:</span><span class="n">no_l</span><span class="p">,</span> <span class="n">no_l</span><span class="p">:,</span> <span class="n">no_r</span><span class="p">:,</span> <span class="p">:</span><span class="n">no_r</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">f_shape</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">fermionic</span> <span class="o">=</span> <span class="n">fermionic</span> <span class="o">+</span> <span class="n">fermionic</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">fermionic</span>

        <span class="n">ferm_aa</span> <span class="o">=</span> <span class="n">get_fermionic_spat_contrib</span><span class="p">(</span><span class="n">new_xc_a</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="p">:</span><span class="n">ov_a</span><span class="p">],</span> <span class="n">new_xc_b</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="p">:</span><span class="n">ov_a</span><span class="p">],</span> <span class="n">no_a</span><span class="p">,</span> <span class="n">nv_a</span><span class="p">,</span> <span class="n">no_a</span><span class="p">,</span> <span class="n">nv_a</span><span class="p">)</span>
        <span class="n">ferm_ab</span> <span class="o">=</span> <span class="n">get_fermionic_spat_contrib</span><span class="p">(</span>
            <span class="n">new_xc_a</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">],</span> <span class="n">new_xc_b</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">],</span> <span class="n">no_a</span><span class="p">,</span> <span class="n">nv_a</span><span class="p">,</span> <span class="n">no_b</span><span class="p">,</span> <span class="n">nv_b</span>
        <span class="p">)</span>
        <span class="n">ferm_bb</span> <span class="o">=</span> <span class="n">get_fermionic_spat_contrib</span><span class="p">(</span>
            <span class="n">new_xc_a</span><span class="p">[</span><span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">,</span> <span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">],</span>
            <span class="n">new_xc_b</span><span class="p">[</span><span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">,</span> <span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">],</span>
            <span class="n">no_b</span><span class="p">,</span>
            <span class="n">nv_b</span><span class="p">,</span>
            <span class="n">no_b</span><span class="p">,</span>
            <span class="n">nv_b</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_fb_spat_contrib</span><span class="p">(</span><span class="n">acon</span><span class="p">,</span> <span class="n">bcon</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">nv</span><span class="p">):</span>
            <span class="n">fb_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">no</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">)</span>
            <span class="n">fermbos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no</span> <span class="o">+</span> <span class="n">nv</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">,))</span>
            <span class="n">fermbos</span><span class="p">[:</span><span class="n">no</span><span class="p">,</span> <span class="n">no</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">acon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">fb_shape</span><span class="p">)</span>
            <span class="n">fermbos</span><span class="p">[</span><span class="n">no</span><span class="p">:,</span> <span class="p">:</span><span class="n">no</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">bcon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">fb_shape</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">fermbos</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">boson_xc_kernel</span><span class="p">:</span>
            <span class="n">fb_a</span> <span class="o">=</span> <span class="n">get_fb_spat_contrib</span><span class="p">(</span><span class="n">new_xc_a</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span> <span class="p">:],</span> <span class="n">new_xc_b</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span> <span class="p">:],</span> <span class="n">no_a</span><span class="p">,</span> <span class="n">nv_a</span><span class="p">)</span>
            <span class="n">fb_b</span> <span class="o">=</span> <span class="n">get_fb_spat_contrib</span><span class="p">(</span>
                <span class="n">new_xc_a</span><span class="p">[</span><span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">,</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span> <span class="p">:],</span> <span class="n">new_xc_b</span><span class="p">[</span><span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">,</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span> <span class="p">:],</span> <span class="n">no_b</span><span class="p">,</span> <span class="n">nv_b</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fb_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no_a</span> <span class="o">+</span> <span class="n">nv_a</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
            <span class="n">fb_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no_b</span> <span class="o">+</span> <span class="n">nv_b</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">with_df</span><span class="p">:</span>
            <span class="c1"># If using RI we can now perform an svd to generate a low-rank representation in the cluster.</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">construct_low_rank_rep</span><span class="p">(</span><span class="n">vaa</span><span class="p">,</span> <span class="n">vab</span><span class="p">,</span> <span class="n">vbb</span><span class="p">,</span> <span class="n">v_fb_a</span><span class="p">,</span> <span class="n">v_fb_b</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Generates low-rank representation of kernel. Note that this will usually be non-PSD, so a real</span>
<span class="sd">                representation will be necessarily asymmetric. Once code is generalised for complex numbers can</span>
<span class="sd">                use symmetric decomposition...&quot;&quot;&quot;</span>
                <span class="n">na</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">vaa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vbb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nbos</span> <span class="o">=</span> <span class="n">v_fb_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">nferm_tot</span> <span class="o">=</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nb</span><span class="o">**</span><span class="mi">2</span>

                <span class="n">vaa</span> <span class="o">=</span> <span class="n">vaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">vbb</span> <span class="o">=</span> <span class="n">vbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">nb</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">vab</span> <span class="o">=</span> <span class="n">vab</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">nb</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

                <span class="n">v_fb_a_ex</span> <span class="o">=</span> <span class="n">v_fb_a</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">nbos</span><span class="p">))</span>
                <span class="n">v_fb_b_ex</span> <span class="o">=</span> <span class="n">v_fb_b</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">nbos</span><span class="p">))</span>

                <span class="n">v_fb_a_dex</span> <span class="o">=</span> <span class="n">v_fb_a</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">nbos</span><span class="p">))</span>
                <span class="n">v_fb_b_dex</span> <span class="o">=</span> <span class="n">v_fb_b</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nb</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">nbos</span><span class="p">))</span>

                <span class="n">fullv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nb</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nbos</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">fullv</span><span class="p">[:</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vaa</span>
                <span class="n">fullv</span><span class="p">[</span><span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="n">nferm_tot</span><span class="p">,</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="n">nferm_tot</span><span class="p">]</span> <span class="o">=</span> <span class="n">vbb</span>
                <span class="n">fullv</span><span class="p">[:</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="n">nferm_tot</span><span class="p">]</span> <span class="o">=</span> <span class="n">vab</span>
                <span class="n">fullv</span><span class="p">[</span><span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="n">nferm_tot</span><span class="p">,</span> <span class="p">:</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vab</span><span class="o">.</span><span class="n">T</span>

                <span class="c1"># Component coupling to bosonic excitations.</span>
                <span class="n">fullv</span><span class="p">[:</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">nferm_tot</span> <span class="p">:</span> <span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_fb_a_ex</span>
                <span class="n">fullv</span><span class="p">[</span><span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="n">nferm_tot</span><span class="p">,</span> <span class="n">nferm_tot</span> <span class="p">:</span> <span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_fb_b_ex</span>

                <span class="n">fullv</span><span class="p">[</span><span class="n">nferm_tot</span> <span class="p">:</span> <span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span><span class="p">,</span> <span class="p">:</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_fb_a_ex</span><span class="o">.</span><span class="n">T</span>
                <span class="n">fullv</span><span class="p">[</span><span class="n">nferm_tot</span> <span class="p">:</span> <span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span><span class="p">,</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="n">nferm_tot</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_fb_b_ex</span><span class="o">.</span><span class="n">T</span>

                <span class="c1"># Component coupling to bosonic excitations.</span>
                <span class="n">fullv</span><span class="p">[:</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">v_fb_a_dex</span>
                <span class="n">fullv</span><span class="p">[</span><span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="n">nferm_tot</span><span class="p">,</span> <span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">v_fb_b_dex</span>

                <span class="n">fullv</span><span class="p">[</span><span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span> <span class="p">:,</span> <span class="p">:</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_fb_a_dex</span><span class="o">.</span><span class="n">T</span>
                <span class="n">fullv</span><span class="p">[</span><span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span> <span class="p">:,</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="n">nferm_tot</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_fb_b_dex</span><span class="o">.</span><span class="n">T</span>

                <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">fullv</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">want</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">svdtol</span>
                <span class="n">nwant</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">want</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fragment </span><span class="si">%d</span><span class="s2"> gives rank </span><span class="si">%d</span><span class="s2"> xc-kernel contribution.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nwant</span><span class="p">)</span>
                <span class="n">repr_l</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,np-&gt;np&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="n">nwant</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">v</span><span class="p">[:</span><span class="n">nwant</span><span class="p">])</span>
                <span class="n">repr_r</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,pn-&gt;np&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="n">nwant</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">u</span><span class="p">[:,</span> <span class="p">:</span><span class="n">nwant</span><span class="p">])</span>

                <span class="n">repf_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">repr_l</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nwant</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">na</span><span class="p">)),</span> <span class="n">repr_r</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nwant</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">na</span><span class="p">)))</span>
                <span class="n">repf_b</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">repr_l</span><span class="p">[:,</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="n">nferm_tot</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nwant</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">)),</span>
                    <span class="n">repr_r</span><span class="p">[:,</span> <span class="n">na</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="n">nferm_tot</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nwant</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="n">repbos_ex</span> <span class="o">=</span> <span class="p">(</span><span class="n">repr_l</span><span class="p">[:,</span> <span class="n">nferm_tot</span> <span class="p">:</span> <span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span><span class="p">],</span> <span class="n">repr_r</span><span class="p">[:,</span> <span class="n">nferm_tot</span> <span class="p">:</span> <span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span><span class="p">])</span>
                <span class="n">repbos_dex</span> <span class="o">=</span> <span class="p">(</span><span class="n">repr_l</span><span class="p">[:,</span> <span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span> <span class="p">:],</span> <span class="n">repr_r</span><span class="p">[:,</span> <span class="n">nferm_tot</span> <span class="o">+</span> <span class="n">nbos</span> <span class="p">:])</span>
                <span class="k">return</span> <span class="n">repf_a</span><span class="p">,</span> <span class="n">repf_b</span><span class="p">,</span> <span class="n">repbos_ex</span><span class="p">,</span> <span class="n">repbos_dex</span>

            <span class="k">return</span> <span class="n">construct_low_rank_rep</span><span class="p">(</span><span class="n">ferm_aa</span><span class="p">,</span> <span class="n">ferm_ab</span><span class="p">,</span> <span class="n">ferm_bb</span><span class="p">,</span> <span class="n">fb_a</span><span class="p">,</span> <span class="n">fb_b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ferm_aa</span><span class="p">,</span> <span class="n">ferm_ab</span><span class="p">,</span> <span class="n">ferm_bb</span><span class="p">,</span> <span class="n">fb_a</span><span class="p">,</span> <span class="n">fb_b</span></div>


<div class="viewcode-block" id="EDMETFragment.get_correlation_kernel_contrib">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_correlation_kernel_contrib">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_correlation_kernel_contrib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contrib</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets contribution to xc kernel in full space of system.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">c_active</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">with_df</span><span class="p">:</span>
            <span class="c1"># First get the contribution from the fermionic degrees of freedom.</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,pi,qj-&gt;npq&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">contrib</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">boson_xc_kernel</span><span class="p">:</span>
                <span class="n">repbos_ex</span><span class="p">,</span> <span class="n">repbos_dex</span> <span class="o">=</span> <span class="n">contrib</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="n">r_ao_bosa</span><span class="p">,</span> <span class="n">r_ao_bosb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_ao_bos</span>

                <span class="n">bos_contrib</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nz,zpq-&gt;npq&quot;</span><span class="p">,</span> <span class="n">repbos_ex</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r_ao_bosa</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nz,zpq-&gt;nqp&quot;</span><span class="p">,</span> <span class="n">repbos_dex</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r_ao_bosa</span><span class="p">),</span>
                        <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nz,zpq-&gt;npq&quot;</span><span class="p">,</span> <span class="n">repbos_ex</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_ao_bosa</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nz,zpq-&gt;nqp&quot;</span><span class="p">,</span> <span class="n">repbos_dex</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_ao_bosa</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="p">(</span>
                        <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nz,zpq-&gt;npq&quot;</span><span class="p">,</span> <span class="n">repbos_ex</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r_ao_bosb</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nz,zpq-&gt;nqp&quot;</span><span class="p">,</span> <span class="n">repbos_dex</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r_ao_bosb</span><span class="p">),</span>
                        <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nz,zpq-&gt;npq&quot;</span><span class="p">,</span> <span class="n">repbos_ex</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_ao_bosb</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nz,zpq-&gt;nqp&quot;</span><span class="p">,</span> <span class="n">repbos_dex</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_ao_bosb</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">]</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">z1</span> <span class="o">+</span> <span class="n">z2</span> <span class="k">for</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">bos_contrib</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_xc_contrib</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v_aa</span><span class="p">,</span> <span class="n">v_ab</span><span class="p">,</span> <span class="n">v_bb</span><span class="p">,</span> <span class="n">fb_a</span><span class="p">,</span> <span class="n">fb_b</span> <span class="o">=</span> <span class="n">contrib</span>
            <span class="n">v_aa</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijkl,pi,qj,rk,sl-&gt;pqrs&quot;</span><span class="p">,</span> <span class="n">v_aa</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">v_ab</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijkl,pi,qj,rk,sl-&gt;pqrs&quot;</span><span class="p">,</span> <span class="n">v_ab</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">v_bb</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijkl,pi,qj,rk,sl-&gt;pqrs&quot;</span><span class="p">,</span> <span class="n">v_bb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">boson_xc_kernel</span><span class="p">:</span>
                <span class="n">r_bosa</span><span class="p">,</span> <span class="n">r_bosb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos_ao</span>
                <span class="c1"># First bosonic excitations, need to consider boson for both first and second index pair.</span>
                <span class="n">bos_v_aa</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijn,pi,qj,nrs-&gt;pqrs&quot;</span><span class="p">,</span> <span class="n">fb_a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r_bosa</span><span class="p">)</span>
                <span class="n">bos_v_aa</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pqrs-&gt;rspq&quot;</span><span class="p">,</span> <span class="n">bos_v_aa</span><span class="p">)</span>
                <span class="n">bos_v_bb</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijn,pi,qj,nrs-&gt;pqrs&quot;</span><span class="p">,</span> <span class="n">fb_b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r_bosb</span><span class="p">)</span>
                <span class="n">bos_v_bb</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pqrs-&gt;rspq&quot;</span><span class="p">,</span> <span class="n">bos_v_bb</span><span class="p">)</span>
                <span class="n">bos_v_ab</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijn,pi,qj,nrs-&gt;pqrs&quot;</span><span class="p">,</span> <span class="n">fb_a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r_bosb</span><span class="p">)</span>
                <span class="n">bos_v_ab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijn,pi,qj,nrs-&gt;rspq&quot;</span><span class="p">,</span> <span class="n">fb_b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r_bosa</span><span class="p">)</span>
                <span class="c1"># Bosonic dexcitations contributions swap pqrs-&gt;qpsr.</span>
                <span class="n">bos_v_aa</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pqrs-&gt;qpsr&quot;</span><span class="p">,</span> <span class="n">bos_v_aa</span><span class="p">)</span>
                <span class="n">bos_v_ab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pqrs-&gt;qpsr&quot;</span><span class="p">,</span> <span class="n">bos_v_ab</span><span class="p">)</span>
                <span class="n">bos_v_bb</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pqrs-&gt;qpsr&quot;</span><span class="p">,</span> <span class="n">bos_v_bb</span><span class="p">)</span>

                <span class="n">v_aa</span> <span class="o">+=</span> <span class="n">bos_v_aa</span>
                <span class="n">v_ab</span> <span class="o">+=</span> <span class="n">bos_v_ab</span>
                <span class="n">v_bb</span> <span class="o">+=</span> <span class="n">bos_v_bb</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">prev_xc_contrib</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_aa</span><span class="p">,</span> <span class="n">v_ab</span><span class="p">,</span> <span class="n">v_bb</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">v_aa</span><span class="p">,</span> <span class="n">v_ab</span><span class="p">,</span> <span class="n">v_bb</span></div>


<div class="viewcode-block" id="EDMETFragment.get_composite_moments">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_composite_moments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_composite_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m0_new</span><span class="p">,</span> <span class="n">m1_new</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct composite moments using the local solver dd moments and the lattice RPA moments&quot;&quot;&quot;</span>
        <span class="c1"># Get the ApB, AmB and m0 for this cluster. Note that this is pre-boson decoupling, but we don&#39;t actually care</span>
        <span class="c1"># about that here and it shouldn&#39;t change our answer.</span>
        <span class="n">apb_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apb</span>
        <span class="n">amb_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb</span>
        <span class="n">m0_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta0</span>
        <span class="c1"># Now want to construct rotations defining which degrees of freedom contribute to two-point quantities.</span>
        <span class="n">rot_ov_frag</span><span class="p">,</span> <span class="n">rot_frag_ov</span><span class="p">,</span> <span class="n">proj_to_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rot_ov_frag</span><span class="p">()</span>
        <span class="n">ov_a</span><span class="p">,</span> <span class="n">ov_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_ab</span>
        <span class="c1"># Now generate new moments in whatever space our self-consistency condition requires.</span>
        <span class="n">m0_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">dot</span><span class="p">(</span><span class="n">proj_to_order</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">proj_to_order</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">proj_to_order</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m0_new</span><span class="p">]</span>
        <span class="n">m1_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">dot</span><span class="p">(</span><span class="n">proj_to_order</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">proj_to_order</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">proj_to_order</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m1_new</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_updated</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">rot_ovf</span><span class="p">,</span> <span class="n">rot_fov</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Given the original value of a block, the updated solver value, and rotations between appropriate spaces</span>
<span class="sd">            generate the updated value of the appropriate block.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rot_ovf</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">rot_ovf</span> <span class="o">=</span> <span class="p">(</span><span class="n">rot_ovf</span><span class="p">,</span> <span class="n">rot_ovf</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rot_fov</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">rot_fov</span> <span class="o">=</span> <span class="p">(</span><span class="n">rot_fov</span><span class="p">,</span> <span class="n">rot_fov</span><span class="p">)</span>
            <span class="c1"># Generate difference in local, two-point excitation basis.</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">update</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">rot_ovf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">orig</span><span class="p">,</span> <span class="n">rot_ovf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">orig</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">rot_fov</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">diff</span><span class="p">,</span> <span class="n">rot_fov</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_updated_spincomponents</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">rot_ov_frag</span><span class="p">,</span> <span class="n">rot_frag_ov</span><span class="p">):</span>
            <span class="n">newmat</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">newmat</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="p">:</span><span class="n">ov_a</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_updated</span><span class="p">(</span><span class="n">newmat</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="p">:</span><span class="n">ov_a</span><span class="p">],</span> <span class="n">update</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rot_ov_frag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rot_frag_ov</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">newmat</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_updated</span><span class="p">(</span>
                <span class="n">newmat</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">],</span> <span class="n">update</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rot_ov_frag</span><span class="p">,</span> <span class="n">rot_frag_ov</span>
            <span class="p">)</span>
            <span class="n">newmat</span><span class="p">[</span><span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">,</span> <span class="p">:</span><span class="n">ov_a</span><span class="p">]</span> <span class="o">=</span> <span class="n">newmat</span><span class="p">[:</span><span class="n">ov_a</span><span class="p">,</span> <span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">newmat</span><span class="p">[</span><span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">,</span> <span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_updated</span><span class="p">(</span>
                <span class="n">newmat</span><span class="p">[</span><span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">,</span> <span class="n">ov_a</span> <span class="p">:</span> <span class="n">ov_a</span> <span class="o">+</span> <span class="n">ov_b</span><span class="p">],</span> <span class="n">update</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rot_ov_frag</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rot_frag_ov</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">newmat</span>

        <span class="n">new_amb</span> <span class="o">=</span> <span class="n">get_updated_spincomponents</span><span class="p">(</span><span class="n">amb_orig</span><span class="p">,</span> <span class="n">m1_new</span><span class="p">,</span> <span class="n">rot_ov_frag</span><span class="p">,</span> <span class="n">rot_frag_ov</span><span class="p">)</span>
        <span class="n">new_m0</span> <span class="o">=</span> <span class="n">get_updated_spincomponents</span><span class="p">(</span><span class="n">m0_orig</span><span class="p">,</span> <span class="n">m0_new</span><span class="p">,</span> <span class="n">rot_ov_frag</span><span class="p">,</span> <span class="n">rot_frag_ov</span><span class="p">)</span>
        <span class="n">new_m0_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">new_m0</span><span class="p">)</span>
        <span class="n">new_apb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">new_m0_inv</span><span class="p">,</span> <span class="n">new_amb</span><span class="p">,</span> <span class="n">new_m0_inv</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">new_amb</span><span class="p">,</span> <span class="n">new_apb</span></div>


<div class="viewcode-block" id="EDMETFragment.get_rot_ov_frag">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.get_rot_ov_frag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_rot_ov_frag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get rotations between the relevant space for fragment two-point excitations and the cluster active occupied-</span>
<span class="sd">        virtual excitations.&quot;&quot;&quot;</span>

        <span class="n">occ_frag_rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;cluster[occ]|frag&quot;</span><span class="p">)</span>
        <span class="n">vir_frag_rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overlap</span><span class="p">(</span><span class="s2">&quot;cluster[vir]|frag&quot;</span><span class="p">)</span>
        <span class="n">ov_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">old_sc_condition</span><span class="p">:</span>
            <span class="c1"># Then get projectors to local quantities in ov-basis. Note this needs to be stacked to apply to each spin</span>
            <span class="c1"># pairing separately.</span>
            <span class="n">rot_ov_frag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ip,ap-&gt;pia&quot;</span><span class="p">,</span> <span class="n">occ_frag_rot</span><span class="p">,</span> <span class="n">vir_frag_rot</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ov_loc</span><span class="p">))</span>
            <span class="c1"># Get pseudo-inverse to map from frag to loc. Since occupied-virtual excitations aren&#39;t spanning this</span>
            <span class="c1"># isn&#39;t a simple transpose.</span>
            <span class="n">rot_frag_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">rot_ov_frag</span><span class="p">)</span>
            <span class="n">proj_to_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">rot_ov_frag</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># First, grab rotations from particle-hole excitations to fragment degrees of freedom, ignoring reordering</span>
            <span class="n">rot_ov_frag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ip,aq-&gt;pqia&quot;</span><span class="p">,</span> <span class="n">occ_frag_rot</span><span class="p">,</span> <span class="n">vir_frag_rot</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ov_loc</span><span class="p">))</span>
            <span class="c1"># Set up matrix to map down to only a single index ordering.</span>
            <span class="n">proj_to_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frag</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frag</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">proj_to_order</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_to_order</span><span class="p">[</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">proj_to_order</span> <span class="o">=</span> <span class="n">proj_to_order</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frag</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frag</span><span class="p">))</span>
            <span class="c1"># Now restrict to triangular portion of array</span>
            <span class="n">proj_to_order</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">proj_to_order</span><span class="p">)</span>
            <span class="c1"># proj_from_order = np.linalg.pinv(proj_to_order)</span>
            <span class="c1"># Now have rotation between single fragment ordering, and fragment particle-hole excits.</span>
            <span class="n">rot_ov_frag</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">proj_to_order</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">rot_ov_frag</span><span class="p">)</span>
            <span class="c1"># Get pseudo-inverse to map from frag to loc. Since occupied-virtual excitations aren&#39;t spanning this</span>
            <span class="c1"># isn&#39;t a simple transpose.</span>
            <span class="n">rot_frag_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">rot_ov_frag</span><span class="p">)</span>
        <span class="c1"># Return tuples so can can unified interface with UHF implementation.</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">rot_ov_frag</span><span class="p">,</span> <span class="n">rot_ov_frag</span><span class="p">),</span> <span class="p">(</span><span class="n">rot_frag_ov</span><span class="p">,</span> <span class="n">rot_frag_ov</span><span class="p">),</span> <span class="n">proj_to_order</span></div>


<div class="viewcode-block" id="EDMETFragment.calc_exact_ac">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.calc_exact_ac">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_exact_ac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">use_plasmon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the exact local energy for RPA in this cluster via the Adiabatic Connection, with or without</span>
<span class="sd">        the plasmon formula. Note that although</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ov_rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rot_to_mf_ov</span><span class="p">()</span>
        <span class="c1"># Get couplings between all fermionic and boson degrees of freedom.</span>
        <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eri_couplings</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ov_rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">eps_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loc_eps</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ov_rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">fproj_ov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_projector_ov</span><span class="p">()</span>

        <span class="n">xc_apb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apb</span> <span class="o">-</span> <span class="n">eps_loc</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eris</span>
        <span class="c1"># NB for the sake of our local energy evaluation the renormalisation is just a component of the coulomb</span>
        <span class="c1"># interaction.</span>
        <span class="n">xc_amb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb</span> <span class="o">-</span> <span class="n">eps_loc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_renorm_effect</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">calc_eta0</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="n">amb_alpha</span> <span class="o">=</span> <span class="n">eps_loc</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amb</span> <span class="o">-</span> <span class="n">eps_loc</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha</span>
            <span class="n">apb_alpha</span> <span class="o">=</span> <span class="n">eps_loc</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apb</span> <span class="o">-</span> <span class="n">eps_loc</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha</span>
            <span class="c1"># e, c = np.linalg.eig(dot(amb, apb))</span>
            <span class="n">MPrt</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">sqrtm</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">amb_alpha</span><span class="p">,</span> <span class="n">apb_alpha</span><span class="p">))</span>  <span class="c1"># einsum(&quot;pn,n,qn-&gt;pq&quot;, c, e ** (0.5), c)</span>
            <span class="n">eta0</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">MPrt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">apb_alpha</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">apb_alpha</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">return</span> <span class="n">eta0</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">calc_contrib_partialint</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="n">eta0</span> <span class="o">=</span> <span class="n">calc_eta0</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">eta0inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">eta0</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span>
                <span class="o">-</span><span class="p">(</span>
                    <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,qr,rp-&gt;&quot;</span><span class="p">,</span> <span class="n">fproj_ov</span><span class="p">,</span> <span class="n">eta0</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">],</span> <span class="n">xc_apb</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">])</span>
                    <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,qr,rp-&gt;&quot;</span><span class="p">,</span> <span class="n">fproj_ov</span><span class="p">,</span> <span class="n">eta0inv</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">],</span> <span class="n">xc_amb</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="mi">4</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">calc_contrib_direct</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="n">eta0</span> <span class="o">=</span> <span class="n">calc_eta0</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">eta0inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">eta0</span><span class="p">)</span>
            <span class="c1"># This is just the contribution from the bare, standard coulomb interaction.</span>
            <span class="n">e_bare</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">einsum</span><span class="p">(</span>
                    <span class="s2">&quot;pq,pr,rq-&gt;&quot;</span><span class="p">,</span>
                    <span class="n">fproj_ov</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">eta0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">))[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">],</span>
                    <span class="n">eris</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="c1"># Need to account for renormalisation of bosonic interactions, which is included in cluster coulomb kernel.</span>
            <span class="n">renorm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_renorm_effect</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">e_renorm</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">einsum</span><span class="p">(</span>
                    <span class="s2">&quot;pq,pr,rq-&gt;&quot;</span><span class="p">,</span>
                    <span class="n">fproj_ov</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">eta0inv</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">))[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">],</span>
                    <span class="n">renorm</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">e_bare</span> <span class="o">+</span> <span class="n">e_renorm</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">run_ac_inter</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">points</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">leggauss</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
            <span class="c1"># Shift and reweight to interval of [0,1].</span>
            <span class="n">points</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">points</span> <span class="o">/=</span> <span class="mi">2</span>
            <span class="n">weights</span> <span class="o">/=</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">w</span> <span class="o">*</span> <span class="n">func</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">points</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">use_plasmon</span><span class="p">:</span>
            <span class="n">e_plasmon</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,qr,rp-&gt;&quot;</span><span class="p">,</span> <span class="n">fproj_ov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta0</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">apb</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">])</span>
                <span class="o">-</span> <span class="p">(</span>
                    <span class="n">einsum</span><span class="p">(</span>
                        <span class="s2">&quot;pq,qp-&gt;&quot;</span><span class="p">,</span>
                        <span class="n">fproj_ov</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">eps_loc</span> <span class="o">+</span> <span class="n">eris</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_renorm_effect</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="k">return</span> <span class="n">e_plasmon</span> <span class="o">+</span> <span class="n">run_ac_inter</span><span class="p">(</span><span class="n">calc_contrib_partialint</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">run_ac_inter</span><span class="p">(</span><span class="n">calc_contrib_direct</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span></div>


<div class="viewcode-block" id="EDMETFragment.test_total_rpa_energy">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.test_total_rpa_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_total_rpa_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">use_plasmon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the exact local energy for RPA in this cluster via the Adiabatic Connection, with or without</span>
<span class="sd">        the plasmon formula. Note that although</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ov_rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rot_to_mf_ov</span><span class="p">()</span>
        <span class="c1"># Get couplings between all fermionic and boson degrees of freedom.</span>
        <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eri_couplings</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ov_rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">eps_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loc_eps</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ov_rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_bos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">xc_apb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apb</span> <span class="o">-</span> <span class="n">eps_loc</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eris</span>
        <span class="c1"># NB for the sake of our local energy evaluation the renormalisation is just a component of the coulomb</span>
        <span class="c1"># interaction.</span>
        <span class="n">xc_amb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb</span> <span class="o">-</span> <span class="n">eps_loc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_renorm_effect</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">calc_eta0</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="n">amb_alpha</span> <span class="o">=</span> <span class="n">eps_loc</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amb</span> <span class="o">-</span> <span class="n">eps_loc</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha</span>
            <span class="n">apb_alpha</span> <span class="o">=</span> <span class="n">eps_loc</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apb</span> <span class="o">-</span> <span class="n">eps_loc</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha</span>
            <span class="c1"># e, c = np.linalg.eig(dot(amb, apb))</span>
            <span class="n">MPrt</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">sqrtm</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">amb_alpha</span><span class="p">,</span> <span class="n">apb_alpha</span><span class="p">))</span>  <span class="c1"># einsum(&quot;pn,n,qn-&gt;pq&quot;, c, e ** (0.5), c)</span>
            <span class="n">eta0</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">MPrt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">apb_alpha</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">apb_alpha</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">return</span> <span class="n">eta0</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">calc_contrib_partialint</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="n">eta0</span> <span class="o">=</span> <span class="n">calc_eta0</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">eta0inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">eta0</span><span class="p">)</span>

            <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,qp-&gt;&quot;</span><span class="p">,</span> <span class="n">eta0</span><span class="p">,</span> <span class="n">xc_apb</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,qp-&gt;&quot;</span><span class="p">,</span> <span class="n">eta0inv</span><span class="p">,</span> <span class="n">xc_amb</span><span class="p">))</span> <span class="o">/</span> <span class="mi">4</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">calc_contrib_direct</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="n">eta0</span> <span class="o">=</span> <span class="n">calc_eta0</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">eta0inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">eta0</span><span class="p">)</span>
            <span class="c1"># This is just the contribution from the bare, standard coulomb interaction.</span>
            <span class="n">e_bare</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,qp-&gt;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">eta0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">)),</span> <span class="n">eris</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="c1"># Need to account for renormalisation of bosonic interactions, which is included in cluster coulomb kernel.</span>
            <span class="n">renorm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_renorm_effect</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">e_renorm</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,qp-&gt;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">eta0inv</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ov_active_tot</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbos</span><span class="p">)),</span> <span class="n">renorm</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="k">return</span> <span class="n">e_bare</span> <span class="o">+</span> <span class="n">e_renorm</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">run_ac_inter</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">points</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">leggauss</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
            <span class="c1"># Shift and reweight to interval of [0,1].</span>
            <span class="n">points</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">points</span> <span class="o">/=</span> <span class="mi">2</span>
            <span class="n">weights</span> <span class="o">/=</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">w</span> <span class="o">*</span> <span class="n">func</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">points</span><span class="p">)])</span>

        <span class="n">e_plasmon</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;pq,qp-&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apb</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">eps_loc</span> <span class="o">+</span> <span class="n">eris</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">amb_renorm_effect</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">e_plasmon</span> <span class="o">=</span> <span class="n">e_plasmon</span> <span class="o">+</span> <span class="n">run_ac_inter</span><span class="p">(</span><span class="n">calc_contrib_partialint</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>

        <span class="n">e_direct</span> <span class="o">=</span> <span class="n">run_ac_inter</span><span class="p">(</span><span class="n">calc_contrib_direct</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Difference between plasmon and direct AC total correlation energies: </span><span class="si">%6.4e</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e_plasmon</span> <span class="o">-</span> <span class="n">e_direct</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">e_plasmon</span><span class="p">,</span> <span class="n">e_direct</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ov_active_ab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ov</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ov</span><span class="p">,</span> <span class="n">ov</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ov</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nocc_ab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">nocc_active</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">no</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">no</span><span class="p">,</span> <span class="n">no</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">no</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nclus_ab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ncl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">norb_active</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ncl</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ncl</span><span class="p">,</span> <span class="n">ncl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ncl</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nvir_ab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nclus_ab</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc_ab</span><span class="p">)])</span>

<div class="viewcode-block" id="EDMETFragment.split_ov_spin_components">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.EDMETFragment.split_ov_spin_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">split_ov_spin_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
        <span class="n">ov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ov_active</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ov</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">ova</span><span class="p">,</span> <span class="n">ovb</span> <span class="o">=</span> <span class="n">ov</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ova</span> <span class="o">=</span> <span class="n">ovb</span> <span class="o">=</span> <span class="n">ov</span>

        <span class="k">return</span> <span class="n">mat</span><span class="p">[:</span><span class="n">ova</span><span class="p">,</span> <span class="p">:</span><span class="n">ova</span><span class="p">],</span> <span class="n">mat</span><span class="p">[:</span><span class="n">ova</span><span class="p">,</span> <span class="n">ova</span> <span class="p">:</span> <span class="n">ova</span> <span class="o">+</span> <span class="n">ovb</span><span class="p">],</span> <span class="n">mat</span><span class="p">[</span><span class="n">ova</span> <span class="p">:</span> <span class="n">ova</span> <span class="o">+</span> <span class="n">ovb</span><span class="p">,</span> <span class="n">ova</span> <span class="p">:</span> <span class="n">ova</span> <span class="o">+</span> <span class="n">ovb</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="bogoliubov_decouple">
<a class="viewcode-back" href="../../../apidoc/vayesta.edmet.html#vayesta.edmet.edmet.bogoliubov_decouple">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bogoliubov_decouple</span><span class="p">(</span><span class="n">apb</span><span class="p">,</span> <span class="n">amb</span><span class="p">):</span>
    <span class="c1"># Perform quick bogliubov transform to decouple our bosons.</span>
    <span class="n">rt_amb</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">sqrtm</span><span class="p">(</span><span class="n">amb</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">rt_amb</span><span class="p">,</span> <span class="n">apb</span><span class="p">,</span> <span class="n">rt_amb</span><span class="p">)</span>
    <span class="n">e</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">e</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">xpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,qp,pn-&gt;qn&quot;</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">rt_amb</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">xmy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,qp,pn-&gt;qn&quot;</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">rt_amb</span><span class="p">),</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">xpy</span> <span class="o">+</span> <span class="n">xmy</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">xpy</span> <span class="o">-</span> <span class="n">xmy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>